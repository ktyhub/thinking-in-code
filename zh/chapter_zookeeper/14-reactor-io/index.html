<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="ä¸“æ³¨å¼€æºæŠ€æœ¯ç‰ˆæœ¬å‘å¸ƒæ´å¯Ÿ - è¿½è¸ªå¼€æºé¡¹ç›®ç‰ˆæœ¬æ¼”è¿›ï¼Œæ·±åº¦è§£ææŠ€æœ¯å˜é©ï¼Œä¸ºæŠ€æœ¯å†³ç­–æä¾›å‰ç»æ€§æ´å¯Ÿå’Œå‡çº§å»ºè®®"><meta name=author content=ktyhub><link href=https://www.ktyhub.com/zh/chapter_zookeeper/14-reactor-io/ rel=canonical><link href=../13-loaddatabase/ rel=prev><link href=../15-election/ rel=next><link rel=alternate href=/zh/ hreflang=zh><link rel=alternate href=/en/ hreflang=en><link rel=alternate href=/es/ hreflang=es><link rel=alternate href=/fr/ hreflang=fr><link rel=alternate href=/de/ hreflang=de><link rel=alternate href=/ja/ hreflang=ja><link rel=alternate href=/ko/ hreflang=ko><link rel=alternate href=/pt/ hreflang=pt><link rel=alternate href=/ru/ hreflang=ru><link rel=alternate href=/ar/ hreflang=ar><link rel=alternate type=application/rss+xml title="RSS è®¢é˜…" href=../../../feed_rss_created.xml><link rel=alternate type=application/rss+xml title="å·²æ›´æ–°å†…å®¹çš„ RSS è®¢é˜…" href=../../../feed_rss_updated.xml><link rel=icon href=../../../img/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>ğŸ“¡ 14-Reactorç½‘ç»œIO - NextStack</title><link rel=stylesheet href=../../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Noto Sans SC";--md-code-font:"JetBrains Mono"}</style><link rel=stylesheet href=../../../stylesheets/homepage-unified.css><link rel=stylesheet href=../../../stylesheets/homepage-fullwidth.css><link rel=stylesheet href=../../../stylesheets/navbar-optimization.css><link rel=stylesheet href=../../../stylesheets/category-navigation.css><link rel=stylesheet href=../../../stylesheets/release-tracker.css><link rel=stylesheet href=../../../mermaid.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-8ZRYQZ565W"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-8ZRYQZ565W",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-8ZRYQZ565W",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=blue> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#nioservercnxnfactory class=md-skip> è·³è½¬è‡³ </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=é¡µçœ‰> <a href=../../.. title=NextStack class="md-header__button md-logo" aria-label=NextStack data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8 3a2 2 0 0 0-2 2v4a2 2 0 0 1-2 2H3v2h1a2 2 0 0 1 2 2v4a2 2 0 0 0 2 2h2v-2H8v-5a2 2 0 0 0-2-2 2 2 0 0 0 2-2V5h2V3m6 0a2 2 0 0 1 2 2v4a2 2 0 0 0 2 2h1v2h-1a2 2 0 0 0-2 2v4a2 2 0 0 1-2 2h-2v-2h2v-5a2 2 0 0 1 2-2 2 2 0 0 1-2-2V5h-2V3z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> NextStack </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> ğŸ“¡ 14-Reactorç½‘ç»œIO </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=blue aria-label=åˆ‡æ¢åˆ°å¤œé—´æ¨¡å¼ type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title=åˆ‡æ¢åˆ°å¤œé—´æ¨¡å¼ for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=light-blue aria-label=åˆ‡æ¢åˆ°æ—¥é—´æ¨¡å¼ type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title=åˆ‡æ¢åˆ°æ—¥é—´æ¨¡å¼ for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <div class=md-header__option> <div class=md-select> <button class="md-header__button md-icon" aria-label=é€‰æ‹©å½“å‰è¯­è¨€> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg> </button> <div class=md-select__inner> <ul class=md-select__list> <li class=md-select__item> <a href=/zh/ hreflang=zh class=md-select__link> ä¸­æ–‡ </a> </li> <li class=md-select__item> <a href=/en/ hreflang=en class=md-select__link> English </a> </li> <li class=md-select__item> <a href=/es/ hreflang=es class=md-select__link> EspaÃ±ol </a> </li> <li class=md-select__item> <a href=/fr/ hreflang=fr class=md-select__link> FranÃ§ais </a> </li> <li class=md-select__item> <a href=/de/ hreflang=de class=md-select__link> Deutsch </a> </li> <li class=md-select__item> <a href=/ja/ hreflang=ja class=md-select__link> æ—¥æœ¬èª </a> </li> <li class=md-select__item> <a href=/ko/ hreflang=ko class=md-select__link> í•œêµ­ì–´ </a> </li> <li class=md-select__item> <a href=/pt/ hreflang=pt class=md-select__link> PortuguÃªs </a> </li> <li class=md-select__item> <a href=/ru/ hreflang=ru class=md-select__link> Ğ ÑƒÑÑĞºĞ¸Ğ¹ </a> </li> <li class=md-select__item> <a href=/ar/ hreflang=ar class=md-select__link> Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© </a> </li> </ul> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=æœç´¢ placeholder=æœç´¢ autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=æŸ¥æ‰¾> <a href=javascript:void(0) class="md-search__icon md-icon" title=åˆ†äº« aria-label=åˆ†äº« data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=æ¸…ç©ºå½“å‰å†…å®¹ aria-label=æ¸…ç©ºå½“å‰å†…å®¹ tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> æ­£åœ¨åˆå§‹åŒ–æœç´¢å¼•æ“ </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> <nav class=md-tabs aria-label=æ ‡ç­¾ data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=/ class=md-tabs__link> ğŸ  é¦–é¡µ </a> </li> <li class=md-tabs__item> <a href=../../release_note/ class=md-tabs__link> ğŸ†• æ–°æŠ€æœ¯ </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../chapter_preface/ class=md-tabs__link> ğŸ“š æŠ€æœ¯åšå®¢ </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=å¯¼èˆªæ  data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=NextStack class="md-nav__button md-logo" aria-label=NextStack data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8 3a2 2 0 0 0-2 2v4a2 2 0 0 1-2 2H3v2h1a2 2 0 0 1 2 2v4a2 2 0 0 0 2 2h2v-2H8v-5a2 2 0 0 0-2-2 2 2 0 0 0 2-2V5h2V3m6 0a2 2 0 0 1 2 2v4a2 2 0 0 0 2 2h1v2h-1a2 2 0 0 0-2 2v4a2 2 0 0 1-2 2h-2v-2h2v-5a2 2 0 0 1 2-2 2 2 0 0 1-2-2V5h-2V3z"/></svg> </a> NextStack </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=/ class=md-nav__link> <span class=md-ellipsis> ğŸ  é¦–é¡µ </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <div class="md-nav__link md-nav__container"> <a href=../../release_note/ class="md-nav__link "> <span class=md-ellipsis> ğŸ†• æ–°æŠ€æœ¯ </span> </a> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> ğŸ†• æ–°æŠ€æœ¯ </label> <ul class=md-nav__list data-md-scrollfix> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> ğŸ“š æŠ€æœ¯åšå®¢ </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> ğŸ“š æŠ€æœ¯åšå®¢ </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1> <div class="md-nav__link md-nav__container"> <a href=../../chapter_preface/ class="md-nav__link "> <span class=md-ellipsis> ğŸ“ å‰è¨€ </span> </a> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> ğŸ“ å‰è¨€ </label> <ul class=md-nav__list data-md-scrollfix> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex> <span class=md-ellipsis> ğŸ” æŠ€æœ¯è°ƒç ” </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> ğŸ” æŠ€æœ¯è°ƒç ” </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chapter_post/site/ class=md-nav__link> <span class=md-ellipsis> ğŸ”– ç½‘å€æ”¶è— </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_post/elasticjob_cloud/ class=md-nav__link> <span class=md-ellipsis> â˜ï¸ è§£é” ElasticJob äº‘åŸç”Ÿå®è·µçš„éš¾é¢˜ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_post/prometheus/ class=md-nav__link> <span class=md-ellipsis> ğŸ“Š ä»æŒ‡æ ‡åˆ°æ´å¯ŸåŠ›çš„æ™®ç½—ç±³ä¿®æ–¯ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_post/flink/ class=md-nav__link> <span class=md-ellipsis> ğŸŒŠ æµ·é‡æ•°æ®å®æ—¶åˆ†æå¼•æ“Apache Flink </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_post/log4j2/ class=md-nav__link> <span class=md-ellipsis> ğŸ“‹ å¯è§‚æµ‹æ€§ä¹‹Log4j2ä¼˜é›…æ—¥å¿—æ‰“å° </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_post/micrometer/ class=md-nav__link> <span class=md-ellipsis> ğŸ“ å¯è§‚æµ‹æ€§ç¥å™¨ä¹‹ Micrometer </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_post/micrometer_tracing/ class=md-nav__link> <span class=md-ellipsis> ğŸ”„ å¯è§‚æµ‹æ€§ä¹‹Micrometer Tracing </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_post/clickhouse/ class=md-nav__link> <span class=md-ellipsis> ğŸ“ˆ å¤§æ•°æ®å®æ—¶åœ¨çº¿åˆ†æä¸ºä½•é€‰æ‹©clickhouseï¼Ÿ </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex> <span class=md-ellipsis> ğŸ—„ï¸ MySQL </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> ğŸ—„ï¸ MySQL </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chapter_mysql/1-transaction-concept/ class=md-nav__link> <span class=md-ellipsis> ğŸ’¼ 1-äº‹åŠ¡åŸºæœ¬æ¦‚å¿µ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_mysql/2-lock/ class=md-nav__link> <span class=md-ellipsis> ğŸ”’ 2-é”æœºåˆ¶ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_mysql/3-innodb_mvcc/ class=md-nav__link> <span class=md-ellipsis> ğŸ“Š 3-InnoDBçš„MVCC </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_mysql/4-redolog/ class=md-nav__link> <span class=md-ellipsis> ğŸ“ 4-Redoæ—¥å¿— </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_mysql/5-undolog/ class=md-nav__link> <span class=md-ellipsis> ğŸ”™ 5-Undoæ—¥å¿— </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_mysql/6-binlog/ class=md-nav__link> <span class=md-ellipsis> ğŸ“œ 6-Binlog </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_mysql/7-transaction/ class=md-nav__link> <span class=md-ellipsis> ğŸ”„ 7-äº‹åŠ¡å®ç° </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_mysql/8-xatransaction/ class=md-nav__link> <span class=md-ellipsis> âš¡ 8-XAäº‹åŠ¡ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_mysql/9-springtransaction/ class=md-nav__link> <span class=md-ellipsis> ğŸƒ 9-Springäº‹åŠ¡ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_mysql/10-distransaction/ class=md-nav__link> <span class=md-ellipsis> ğŸŒ 10-åˆ†å¸ƒå¼äº‹åŠ¡ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_mysql/11-distransaction-2/ class=md-nav__link> <span class=md-ellipsis> ğŸ”— 11-åˆ†å¸ƒå¼äº‹åŠ¡(äºŒ) </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_mysql/12-distransaction-3/ class=md-nav__link> <span class=md-ellipsis> ğŸ§© 12-åˆ†å¸ƒå¼äº‹åŠ¡(ä¸‰) </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_mysql/13-cap/ class=md-nav__link> <span class=md-ellipsis> ğŸ“Š 13-CAPç†è®º </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_mysql/14-final-equals/ class=md-nav__link> <span class=md-ellipsis> ğŸ”„ 14-æœ€ç»ˆä¸€è‡´æ€§ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_mysql/15-notify/ class=md-nav__link> <span class=md-ellipsis> ğŸ“¨ 15-é€šçŸ¥æ¨¡å¼ </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex> <span class=md-ellipsis> âš¡ Flux </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> âš¡ Flux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chaptor_reactor/Flux/ class=md-nav__link> <span class=md-ellipsis> ğŸŒŸ FluxåŸºç¡€ </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/1-Flux/ class=md-nav__link> <span class=md-ellipsis> ğŸ”§ 1-Fluxåˆ›å»ºåŸç† </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/2-Flux.push/ class=md-nav__link> <span class=md-ellipsis> ğŸš€ 2-Flux.pushåˆ›å»ºä¸å‘å¸ƒ </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/3-Flux.handle/ class=md-nav__link> <span class=md-ellipsis> ğŸ› ï¸ 3-Flux.handleæ“ä½œ </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/4-Momo/ class=md-nav__link> <span class=md-ellipsis> ğŸ§© 4-MonoåŸºç¡€ </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/5-BaseSubscriber/ class=md-nav__link> <span class=md-ellipsis> ğŸ‘¥ 5-BaseSubscriberä½¿ç”¨ </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/6-Scheduler/ class=md-nav__link> <span class=md-ellipsis> ï¿½ï¿½ï¸ 6-è°ƒåº¦å™¨Scheduler </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/7-Schedulers.elastic/ class=md-nav__link> <span class=md-ellipsis> ğŸ”„ 7-å¼¹æ€§è°ƒåº¦å™¨Elastic </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/8-Flux.pushlishOn/ class=md-nav__link> <span class=md-ellipsis> ğŸ“¤ 8-Fluxå‘å¸ƒçº¿ç¨‹æ§åˆ¶ </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/9-Flux.subscribeOn/ class=md-nav__link> <span class=md-ellipsis> ğŸ“¥ 9-Fluxè®¢é˜…çº¿ç¨‹æ§åˆ¶ </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/10-Flux.parallel/ class=md-nav__link> <span class=md-ellipsis> ğŸš¦ 10-Fluxå¹¶è¡Œå¤„ç† </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/11-ParallelFlux.runOn/ class=md-nav__link> <span class=md-ellipsis> ğŸƒ 11-ParallelFluxè¿è¡Œ </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/12-Filter/ class=md-nav__link> <span class=md-ellipsis> ğŸ” 12-è¿‡æ»¤å™¨Filter </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/13-transform/ class=md-nav__link> <span class=md-ellipsis> ï¿½ï¿½ï¿½ï¿½ 13-è½¬æ¢transform </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/14-â€‹â€‹bufferâ€‹â€‹_windowï¿½ï¿½ï¿½â€‹_groupBy.md class=md-nav__link> <span class=md-ellipsis> ğŸ“¦ 14-ç¼“å†²ä¸åˆ†ç»„ </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/15-merge_mergeSequential/ class=md-nav__link> <span class=md-ellipsis> ğŸ”— 15-åˆå¹¶æ“ä½œ </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/16-flatMap_flatMapSequential/ class=md-nav__link> <span class=md-ellipsis> ğŸ“„ 16-æ‰å¹³åŒ–æ˜ å°„ </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/17-concatMap/ class=md-nav__link> <span class=md-ellipsis> ğŸ§µ 17-è¿æ¥æ˜ å°„concatMap </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/18-combineLatest/ class=md-nav__link> <span class=md-ellipsis> ğŸ§© 18-combineLatestç»„åˆ </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/19-UnicastProcessor/ class=md-nav__link> <span class=md-ellipsis> ğŸ“¡ 19-å•æ’­å¤„ç†å™¨ </span> </a> </li> <li class=md-nav__item> <a href=../../chaptor_reactor/20-DirectProcessor/ class=md-nav__link> <span class=md-ellipsis> ğŸ® 20-ç›´æ¥å¤„ç†å™¨ </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_5> <label class=md-nav__link for=__nav_3_5 id=__nav_3_5_label tabindex> <span class=md-ellipsis> ğŸ¤– spring-ai-alibaba </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_5_label aria-expanded=false> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> ğŸ¤– spring-ai-alibaba </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chapter_spring_ai_alibaba/1-official-website/ class=md-nav__link> <span class=md-ellipsis> ğŸ“ 1-å®˜ç½‘ç¬”è®° </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_6> <label class=md-nav__link for=__nav_3_6 id=__nav_3_6_label tabindex> <span class=md-ellipsis> ğŸ“Ÿ mcp </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_6_label aria-expanded=false> <label class=md-nav__title for=__nav_3_6> <span class="md-nav__icon md-icon"></span> ğŸ“Ÿ mcp </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chapter_modelcontextprotocol/1-official-website/ class=md-nav__link> <span class=md-ellipsis> ğŸ“ 1-å®˜ç½‘ç¬”è®° </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_7> <label class=md-nav__link for=__nav_3_7 id=__nav_3_7_label tabindex> <span class=md-ellipsis> ğŸ§  spring-ai </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_7_label aria-expanded=false> <label class=md-nav__title for=__nav_3_7> <span class="md-nav__icon md-icon"></span> ğŸ§  spring-ai </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chapter_spring_ai/1-official-website/ class=md-nav__link> <span class=md-ellipsis> ğŸ“ 1-å®˜ç½‘ç¬”è®° </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_spring_ai/2-sample/ class=md-nav__link> <span class=md-ellipsis> ğŸš€ 2-åŸºç¡€ç¤ºä¾‹ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_spring_ai/3-sample2/ class=md-nav__link> <span class=md-ellipsis> ğŸ§© 3-è¿›é˜¶ç¤ºä¾‹ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_spring_ai/4-sample/ class=md-nav__link> <span class=md-ellipsis> ğŸ” 4-å®ï¿½ï¿½ï¿½åº”ç”¨ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_spring_ai/5-advisor/ class=md-nav__link> <span class=md-ellipsis> ğŸ‘¨â€ğŸ’¼ 5-AIé¡¾é—®(Advisor) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_8> <label class=md-nav__link for=__nav_3_8 id=__nav_3_8_label tabindex> <span class=md-ellipsis> â˜¸ï¸ kubernetes(v1.9.9)(æ¢³ç†ä¸­) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_8_label aria-expanded=false> <label class=md-nav__title for=__nav_3_8> <span class="md-nav__icon md-icon"></span> â˜¸ï¸ kubernetes(v1.9.9)(æ¢³ç†ä¸­) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chapter_kubernetes/1-index/ class=md-nav__link> <span class=md-ellipsis> ğŸ“¥ 1-å…‹éš†K8Sæºç  </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_kubernetes/2-apiserver/ class=md-nav__link> <span class=md-ellipsis> ğŸš€ 2-ApiServerä¸»æµç¨‹ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_kubernetes/3-apiserver-server-run-options/ class=md-nav__link> <span class=md-ellipsis> âš™ï¸ 3-ApiServeré…ç½®åˆå§‹åŒ– </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_kubernetes/4-apiserver-add-flags/ class=md-nav__link> <span class=md-ellipsis> ğŸš© 4-ApiServerå‘½ä»¤è¡Œæ ‡è®° </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_kubernetes/5-apiserver-server-run/ class=md-nav__link> <span class=md-ellipsis> ğŸ”— 5-ApiServer-APIæœåŠ¡å™¨é“¾åˆ›å»º </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_9> <label class=md-nav__link for=__nav_3_9 id=__nav_3_9_label tabindex> <span class=md-ellipsis> â±ï¸ ElasticJob(V2.1.5) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_9_label aria-expanded=false> <label class=md-nav__title for=__nav_3_9> <span class="md-nav__icon md-icon"></span> â±ï¸ ElasticJob(V2.1.5) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chapter_elasticjob/1-introduce/ class=md-nav__link> <span class=md-ellipsis> ğŸ“š 1-åˆ†å¸ƒå¼è°ƒåº¦ç³»ç»Ÿç®€ä»‹ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_elasticjob/2-reg/ class=md-nav__link> <span class=md-ellipsis> ğŸ“‹ 2-æ³¨å†Œä¸­å¿ƒçš„è®¾è®¡åŸç† </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_elasticjob/4-job-template/ class=md-nav__link> <span class=md-ellipsis> ğŸ“ 4-è°ƒåº¦ä½œä¸šæ¨¡ç‰ˆç±»è®¾è®¡ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_elasticjob/5-job-config-storage/ class=md-nav__link> <span class=md-ellipsis> ğŸ’¾ 5-åˆ†å¸ƒå¼åœºæ™¯ä¸‹å­˜å‚¨çš„ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_elasticjob/6-job-registry/ class=md-nav__link> <span class=md-ellipsis> ğŸ§© 6-å•ä¾‹æ¨¡å¼ä½œä¸šæ³¨å†Œè¡¨ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_elasticjob/7-quartz/ class=md-nav__link> <span class=md-ellipsis> â²ï¸ 7-Quartzä¸‹çš„å•æœºæ‰§è¡Œ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_elasticjob/8-job-life/ class=md-nav__link> <span class=md-ellipsis> ğŸ”„ 8-ç³»ç»Ÿå¯åŠ¨æ—¶çš„ç”Ÿå‘½å‘¨æœŸ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_elasticjob/9-listener/ class=md-nav__link> <span class=md-ellipsis> ğŸ‘‚ 9-è°ƒåº¦ä½œä¸šçš„ç›‘å¬å™¨å¤§å…¨ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_elasticjob/10-leader-latch/ class=md-nav__link> <span class=md-ellipsis> ğŸ”’ 10-åˆ†å¸ƒå¼é”å®ç°é€‰ä¸»èŠ‚ç‚¹ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_elasticjob/11-server-instance/ class=md-nav__link> <span class=md-ellipsis> ğŸ’½ 11-æœåŠ¡å’Œè¿›ç¨‹ä¿¡æ¯æŒä¹…åŒ– </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_10 checked> <label class=md-nav__link for=__nav_3_10 id=__nav_3_10_label tabindex> <span class=md-ellipsis> ğŸ˜ Zookeeper(V3.6.2) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_10_label aria-expanded=true> <label class=md-nav__title for=__nav_3_10> <span class="md-nav__icon md-icon"></span> ğŸ˜ Zookeeper(V3.6.2) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../1-introduce/ class=md-nav__link> <span class=md-ellipsis> ğŸŒŸ 1-å…¥é—¨ç®€ä»‹ </span> </a> </li> <li class=md-nav__item> <a href=../2-implement/ class=md-nav__link> <span class=md-ellipsis> ğŸ“ 2-å®ç°è¯´æ˜ </span> </a> </li> <li class=md-nav__item> <a href=../3-install/ class=md-nav__link> <span class=md-ellipsis> ğŸ”§ 3-å®‰è£…é…ç½® </span> </a> </li> <li class=md-nav__item> <a href=../4-client/ class=md-nav__link> <span class=md-ellipsis> ğŸ‘¤ 4-å®¢æˆ·ç«¯å…¥é—¨ </span> </a> </li> <li class=md-nav__item> <a href=../5-produce-and-consumer/ class=md-nav__link> <span class=md-ellipsis> ğŸ”’ 5-é”ä¸ç”Ÿäº§è€…æ¶ˆè´¹è€… </span> </a> </li> <li class=md-nav__item> <a href=../6-watch/ class=md-nav__link> <span class=md-ellipsis> ğŸ‘€ 6-ç›‘å¬æœºåˆ¶ </span> </a> </li> <li class=md-nav__item> <a href=../7-start-source/ class=md-nav__link> <span class=md-ellipsis> ğŸšª 7-æœåŠ¡å™¨å…¥å£ </span> </a> </li> <li class=md-nav__item> <a href=../8-config/ class=md-nav__link> <span class=md-ellipsis> âš™ï¸ 8-é…ç½®åŠ è½½ </span> </a> </li> <li class=md-nav__item> <a href=../9-clear-log-start/ class=md-nav__link> <span class=md-ellipsis> ğŸ§¹ 9-æ—¥å¿—æ¸…ç†ä»»åŠ¡ </span> </a> </li> <li class=md-nav__item> <a href=../10-init-main/ class=md-nav__link> <span class=md-ellipsis> ğŸš€ 10-åˆå§‹åŒ–å’Œå¯åŠ¨ </span> </a> </li> <li class=md-nav__item> <a href=../11-reactor/ class=md-nav__link> <span class=md-ellipsis> ğŸŒ 11-ç½‘ç»œIOåˆå§‹åŒ– </span> </a> </li> <li class=md-nav__item> <a href=../12-quorumpeer-init/ class=md-nav__link> <span class=md-ellipsis> ğŸ§© 12-QuorumPeeråˆå§‹åŒ– </span> </a> </li> <li class=md-nav__item> <a href=../13-loaddatabase/ class=md-nav__link> <span class=md-ellipsis> ğŸ’¾ 13-åˆå§‹åŒ–ç£ç›˜æ•°æ® </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> ğŸ“¡ 14-Reactorç½‘ç»œIO </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> ğŸ“¡ 14-Reactorç½‘ç»œIO </span> </a> <nav class="md-nav md-nav--secondary" aria-label=ç›®å½•> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> ç›®å½• </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> ç®€ä»‹ </span> </a> <nav class=md-nav aria-label=ç®€ä»‹> <ul class=md-nav__list> <li class=md-nav__item> <a href=#startservercnxnfactory class=md-nav__link> <span class=md-ellipsis> startServerCnxnFactory </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#reactoriomain-sub-reactor class=md-nav__link> <span class=md-ellipsis> ä¸»ä»Reactorç½‘ç»œIOæ¨¡å‹main-sub reactor </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> åŒæ­¥é˜Ÿåˆ— </span> </a> <nav class=md-nav aria-label=åŒæ­¥é˜Ÿåˆ—> <ul class=md-nav__list> <li class=md-nav__item> <a href=#selectorthreadacceptedqueue class=md-nav__link> <span class=md-ellipsis> SelectorThread.acceptedQueue </span> </a> </li> <li class=md-nav__item> <a href=#selectorthreadupdatequeue class=md-nav__link> <span class=md-ellipsis> SelectorThread.updateQueue </span> </a> </li> <li class=md-nav__item> <a href=#socketchannelnioservercnxnoutgoingbuffers class=md-nav__link> <span class=md-ellipsis> socketChannel.NIOServerCnxn.outgoingBuffers </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#nioservercnxnfactory_1 class=md-nav__link> <span class=md-ellipsis> NIOServerCnxnFactory çš„åˆå§‹åŒ–é…ç½®æ–¹æ³• </span> </a> </li> <li class=md-nav__item> <a href=#nioservercnxnfactory_2 class=md-nav__link> <span class=md-ellipsis> NIOServerCnxnFactoryçš„å¯åŠ¨æ–¹æ³• </span> </a> </li> <li class=md-nav__item> <a href=#acceptthread class=md-nav__link> <span class=md-ellipsis> AcceptThread </span> </a> <nav class=md-nav aria-label=AcceptThread> <ul class=md-nav__list> <li class=md-nav__item> <a href=#acceptthread_1 class=md-nav__link> <span class=md-ellipsis> AcceptThreadç±»å‹æºç  </span> </a> </li> <li class=md-nav__item> <a href=#pauseaccept class=md-nav__link> <span class=md-ellipsis> pauseAcceptæš‚åœæ¥æ”¶ </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#selectorthread class=md-nav__link> <span class=md-ellipsis> SelectorThread </span> </a> <nav class=md-nav aria-label=SelectorThread> <ul class=md-nav__list> <li class=md-nav__item> <a href=#selectorthread_1 class=md-nav__link> <span class=md-ellipsis> SelectorThreadç±»å‹æºç  </span> </a> </li> <li class=md-nav__item> <a href=#processacceptedconnections class=md-nav__link> <span class=md-ellipsis> å¤„ç†è¢«æ¥å—çš„è¿æ¥è¯·æ±‚processAcceptedConnections </span> </a> </li> <li class=md-nav__item> <a href=#createconnection class=md-nav__link> <span class=md-ellipsis> createConnection </span> </a> <nav class=md-nav aria-label=createConnection> <ul class=md-nav__list> <li class=md-nav__item> <a href=#nioservercnxn class=md-nav__link> <span class=md-ellipsis> çœ‹ä¸‹NIOServerCnxnçš„æ„é€ å™¨ </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#updatequeueprocessinterestopsupdaterequests class=md-nav__link> <span class=md-ellipsis> æ›´æ–°updateQueueä¸­è¿æ¥çš„ç›‘å¬äº‹ä»¶processInterestOpsUpdateRequests </span> </a> </li> <li class=md-nav__item> <a href=#io class=md-nav__link> <span class=md-ellipsis> å¤„ç†IOäº‹ä»¶ </span> </a> <nav class=md-nav aria-label=å¤„ç†IOäº‹ä»¶> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ioworkrequest class=md-nav__link> <span class=md-ellipsis> IOWorkRequest </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#nioservercnxn_1 class=md-nav__link> <span class=md-ellipsis> NIOServerCnxnè¯»å–æ•°æ®æµç¨‹ </span> </a> </li> <li class=md-nav__item> <a href=#ioworkrequest_1 class=md-nav__link> <span class=md-ellipsis> IOWorkRequest </span> </a> <nav class=md-nav aria-label=IOWorkRequest> <ul class=md-nav__list> <li class=md-nav__item> <a href=#nioservercnxndoio class=md-nav__link> <span class=md-ellipsis> NIOServerCnxnçš„doIO </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#readpayload class=md-nav__link> <span class=md-ellipsis> readPayload </span> </a> </li> <li class=md-nav__item> <a href=#readconnectrequest class=md-nav__link> <span class=md-ellipsis> readConnectRequest </span> </a> <nav class=md-nav aria-label=readConnectRequest> <ul class=md-nav__list> <li class=md-nav__item> <a href=#processconnectrequest class=md-nav__link> <span class=md-ellipsis> å¤„ç†è¿æ¥è¯·æ±‚processConnectRequest </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#session class=md-nav__link> <span class=md-ellipsis> åˆå§‹åŒ–Session </span> </a> <nav class=md-nav aria-label=åˆå§‹åŒ–Session> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> è·Ÿè¸ªä¼šè¯è¿‡æœŸæ—¶é—´ </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> æäº¤ä¼šè¯ </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> æäº¤è¯·æ±‚å¤„ç† </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#processpacket class=md-nav__link> <span class=md-ellipsis> processPacket </span> </a> </li> <li class=md-nav__item> <a href=#selector-thread class=md-nav__link> <span class=md-ellipsis> selector thread </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#connectionexpirerthread class=md-nav__link> <span class=md-ellipsis> ConnectionExpirerThread </span> </a> </li> <li class=md-nav__item> <a href=#nettyservercnxnfactory class=md-nav__link> <span class=md-ellipsis> NettyServerCnxnFactory </span> </a> <nav class=md-nav aria-label=NettyServerCnxnFactory> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> æ€»ç»“ </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../15-election/ class=md-nav__link> <span class=md-ellipsis> ğŸ—³ï¸ 15-é€‰ä¸¾ç®—æ³•çš„å‡†å¤‡ç­‰å¾…é€‰ä¸¾ </span> </a> </li> <li class=md-nav__item> <a href=../16-lookforleader/ class=md-nav__link> <span class=md-ellipsis> ğŸ” 16-å¼€å§‹å¯»æ‰¾leader </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_11> <label class=md-nav__link for=__nav_3_11 id=__nav_3_11_label tabindex> <span class=md-ellipsis> ğŸ Dubbbo(V3.0.8) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_11_label aria-expanded=false> <label class=md-nav__title for=__nav_3_11> <span class="md-nav__icon md-icon"></span> ğŸ Dubbbo(V3.0.8) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chapter_dubbo/1-learn-from-a-demo/ class=md-nav__link> <span class=md-ellipsis> ğŸ”° 1-æœåŠ¡æä¾›è€…çš„Demo </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/2-serviceconfig-config/ class=md-nav__link> <span class=md-ellipsis> âš™ï¸ 2-ServiceConfigåŒ– </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/3-model-init/ class=md-nav__link> <span class=md-ellipsis> ğŸ§© 3-é¢†åŸŸæ¨¡å‹Modelå¯¹è±¡ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/4-extension-init/ class=md-nav__link> <span class=md-ellipsis> ğŸ”Œ 4-Extensionçš„åˆå§‹åŒ– </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/5-getadaptiveextension/ class=md-nav__link> <span class=md-ellipsis> ğŸ”§ 5-getAdaptiveExtensionæ–¹æ³• </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/6-extension-wrapper/ class=md-nav__link> <span class=md-ellipsis> ğŸ 6-Extensionçš„Wrapperæœºåˆ¶ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/7-extension-activate/ class=md-nav__link> <span class=md-ellipsis> âš¡ 7-Extensionçš„Activateæœºåˆ¶ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/8-dubbobootstrap/ class=md-nav__link> <span class=md-ellipsis> ï¿½ï¿½ï¿½ 8-DubboBootstrapå¯åŠ¨ç¨‹åº </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/9-application-config/ class=md-nav__link> <span class=md-ellipsis> ğŸ“± 9-ApplicationConfig </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/10-registryconfig/ class=md-nav__link> <span class=md-ellipsis> ğŸ“‹ 10-RegistryConfig </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/11-protocolconfig/ class=md-nav__link> <span class=md-ellipsis> ğŸ”Œ 11-ProtocolConfig </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/12-start-life-cycle/ class=md-nav__link> <span class=md-ellipsis> ğŸ”„ 12-å¯åŠ¨ç”Ÿå‘½å‘¨æœŸ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/13-configcenter/ class=md-nav__link> <span class=md-ellipsis> âš™ï¸ 13-é…ç½®ä¸­å¿ƒåˆå§‹åŒ– </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/14-config-load/ class=md-nav__link> <span class=md-ellipsis> ğŸ“‚ 14-é…ç½®åŠ è½½è¯´æ˜ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/15-metadata/ class=md-nav__link> <span class=md-ellipsis> ğŸ“Š 15-å…ƒæ•°æ®ä¸­å¿ƒè¯´æ˜ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/16-moduledeployer/ class=md-nav__link> <span class=md-ellipsis> ğŸ“¦ 16-æ¨¡å—å‘å¸ƒå™¨ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/17-provider-register/ class=md-nav__link> <span class=md-ellipsis> ğŸ”„ 17-æä¾›è€…åŒæ³¨å†Œ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/18-metadataService-export/ class=md-nav__link> <span class=md-ellipsis> ğŸ“¤ 18-å…ƒæ•°æ®æœåŠ¡çš„å¯¼å‡º </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/19-consuemr-demo/ class=md-nav__link> <span class=md-ellipsis> ğŸ‘¥ 19-æ¶ˆè´¹è€…æ¡ˆä¾‹ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/20-reference-config/ class=md-nav__link> <span class=md-ellipsis> ğŸ”— 20-ReferenceConfig </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/21-refer-services/ class=md-nav__link> <span class=md-ellipsis> ğŸ” 21-ReferServices </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_dubbo/22-migration-invoker/ class=md-nav__link> <span class=md-ellipsis> ğŸ”„ 22-è‡ªåŠ¨å†³ç­–åº”ç”¨çº§æœåŠ¡å‘ç°åŸç† </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_12> <label class=md-nav__link for=__nav_3_12 id=__nav_3_12_label tabindex> <span class=md-ellipsis> ğŸ“¨ Apache Kafka Client(3.2) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_12_label aria-expanded=false> <label class=md-nav__title for=__nav_3_12> <span class="md-nav__icon md-icon"></span> ğŸ“¨ Apache Kafka Client(3.2) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chapter_kafka/1-introduce/ class=md-nav__link> <span class=md-ellipsis> ğŸŒŸ 1-å…¥é—¨ç¬”è®° </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_kafka/2-high-performence/ class=md-nav__link> <span class=md-ellipsis> ğŸš€ 2-é«˜æ€§èƒ½é«˜å¯ç”¨è®¾è®¡ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_kafka/3-client-sample/ class=md-nav__link> <span class=md-ellipsis> ğŸ‘¤ 3-å®¢æˆ·ç«¯æ¡ˆä¾‹ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_kafka/4-kafka-producer/ class=md-nav__link> <span class=md-ellipsis> ğŸ­ 4-KafkaProducer </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_kafka/5-sender/ class=md-nav__link> <span class=md-ellipsis> ğŸ“¤ 5-å‘é€å™¨Sender </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_kafka/6-kafka-thread/ class=md-nav__link> <span class=md-ellipsis> ğŸ§µ 6-å®¢æˆ·ç«¯çš„IOçº¿ç¨‹ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_kafka/7-kafka-producer-init/ class=md-nav__link> <span class=md-ellipsis> ğŸš€ 7-KafkaProducerçš„åˆå§‹åŒ– </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_kafka/8-send-producer-data/ class=md-nav__link> <span class=md-ellipsis> ğŸ“¤ 8-å‘é€ç”Ÿäº§è€…æ•°æ® </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_kafka/9-execute-io/ class=md-nav__link> <span class=md-ellipsis> âš¡ 9-æ‰§è¡ŒIOäº‹ä»¶ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_kafka/10-handle-io/ class=md-nav__link> <span class=md-ellipsis> ğŸ”„ 10-å¤„ç†IOç»“æœ </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_13> <label class=md-nav__link for=__nav_3_13 id=__nav_3_13_label tabindex> <span class=md-ellipsis> ğŸŒ Netty(v4.x) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_13_label aria-expanded=false> <label class=md-nav__title for=__nav_3_13> <span class="md-nav__icon md-icon"></span> ğŸŒ Netty(v4.x) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chapter_netty/1-sample/ class=md-nav__link> <span class=md-ellipsis> ğŸŒŸ 1-Nettyçš„å…¥é—¨ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_netty/2-bootstrap/ class=md-nav__link> <span class=md-ellipsis> ğŸš€ 2-å¯åŠ¨ï¿½ï¿½Bootstrapp </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_netty/3-event-loop-group-init/ class=md-nav__link> <span class=md-ellipsis> ğŸ”„ 3-EventLoopGroupåˆå§‹åŒ– </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_netty/4-server-bootstrap-attr/ class=md-nav__link> <span class=md-ellipsis> âš™ï¸ 4-BootStrapå±æ€§è®¾ç½® </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_14> <label class=md-nav__link for=__nav_3_14 id=__nav_3_14_label tabindex> <span class=md-ellipsis> ğŸ” Druid(v1.2.11) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_14_label aria-expanded=false> <label class=md-nav__title for=__nav_3_14> <span class="md-nav__icon md-icon"></span> ğŸ” Druid(v1.2.11) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chapter_druid/1-sample/ class=md-nav__link> <span class=md-ellipsis> ğŸŒŸ 1-å…¥é—¨æ¡ˆä¾‹ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_druid/2-datasource/ class=md-nav__link> <span class=md-ellipsis> ğŸ“Š 2-æ•°æ®æºç®€ä»‹ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_druid/3-before-connection/ class=md-nav__link> <span class=md-ellipsis> ğŸ”Œ 3-åˆå§‹åŒ–è¿æ¥ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_druid/4-db-type/ class=md-nav__link> <span class=md-ellipsis> ğŸš— 4-DbTypeä¸é©±åŠ¨ç±» </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_druid/5-log-stats-thread/ class=md-nav__link> <span class=md-ellipsis> ğŸ“Š 5-ç›‘æ§ä¿¡æ¯çº¿ç¨‹ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_druid/6-create-and-start-creator-thread/ class=md-nav__link> <span class=md-ellipsis> ğŸ”— 6-ç‰©ç†è¿æ¥åˆ›å»ºçº¿ç¨‹ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_druid/7-driver-connect/ class=md-nav__link> <span class=md-ellipsis> ğŸ—ï¸ 7-åˆ›å»ºæ•°æ®åº“è¿æ¥å¯¹è±¡ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_druid/8-validate-connection/ class=md-nav__link> <span class=md-ellipsis> âœ… 8-è¿æ¥çš„é¦–æ¬¡éªŒè¯ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_druid/9-druid-destroy/ class=md-nav__link> <span class=md-ellipsis> ğŸ’¥ 9-Druidé”€æ¯çº¿ç¨‹ </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_15> <label class=md-nav__link for=__nav_3_15 id=__nav_3_15_label tabindex> <span class=md-ellipsis> ğŸƒ SpringBoot(v2.6.6) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_15_label aria-expanded=false> <label class=md-nav__title for=__nav_3_15> <span class="md-nav__icon md-icon"></span> ğŸƒ SpringBoot(v2.6.6) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chapter_springboot/1-sample/ class=md-nav__link> <span class=md-ellipsis> ğŸŒŸ 1-å…¥é—¨æ¡ˆä¾‹ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_springboot/2-spi/ class=md-nav__link> <span class=md-ellipsis> ğŸš€ 2-runæ–¹æ³•ä¸SPIæ‰«æ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_springboot/3-run/ class=md-nav__link> <span class=md-ellipsis> ğŸ”„ 3-SpringApplicationçš„runæ–¹æ³• </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_springboot/4-environment/ class=md-nav__link> <span class=md-ellipsis> ğŸŒ 4-Environmentåˆå§‹åŒ– </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_springboot/5-application-context-init/ class=md-nav__link> <span class=md-ellipsis> ğŸ­ 5-ApplicationContextåˆå§‹åŒ– </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_springboot/6-reader-scanner/ class=md-nav__link> <span class=md-ellipsis> ğŸ“– 6-Readerå’ŒScanner </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_springboot/spring-flux/ class=md-nav__link> <span class=md-ellipsis> âš¡ Spring Flux </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_16> <label class=md-nav__link for=__nav_3_16 id=__nav_3_16_label tabindex> <span class=md-ellipsis> ğŸ“¡ EMQX(V3.0) </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_16_label aria-expanded=false> <label class=md-nav__title for=__nav_3_16> <span class="md-nav__icon md-icon"></span> ğŸ“¡ EMQX(V3.0) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chapter_emqx/1-introduce/ class=md-nav__link> <span class=md-ellipsis> ğŸŒŸ 1-EMQXç®€ä»‹ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_emqx/2-code-struct/ class=md-nav__link> <span class=md-ellipsis> ğŸ—ï¸ 2-é¡¹ç›®ç»“æ„ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_emqx/3-kernel/ class=md-nav__link> <span class=md-ellipsis> ğŸ”„ 3-å†…æ ¸å±‚å¯åŠ¨ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_emqx/4-router/ class=md-nav__link> <span class=md-ellipsis> ğŸ›£ï¸ 4-è·¯ç”±å±‚å¯åŠ¨ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_emqx/5-broker/ class=md-nav__link> <span class=md-ellipsis> ğŸ§© 5-ä»£ç†å±‚å¯åŠ¨ </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_17> <label class=md-nav__link for=__nav_3_17 id=__nav_3_17_label tabindex> <span class=md-ellipsis> ğŸ§ Linuxå†…æ ¸æºç  </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_17_label aria-expanded=false> <label class=md-nav__title for=__nav_3_17> <span class="md-nav__icon md-icon"></span> ğŸ§ Linuxå†…æ ¸æºç  </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../chapter_linux/ebpf/1-ebpf/ class=md-nav__link> <span class=md-ellipsis> ğŸ” eBPFä¸ºä»€ä¹ˆå¾ˆé‡è¦ä»¥åŠå®ƒçš„å‘å±•å² </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_linux/ebpf/ebpf_hello/ class=md-nav__link> <span class=md-ellipsis> ğŸ‘‹ ä»ä¸€ä¸ªHello Worldç¨‹åºå…¥é—¨eBPF </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_linux/net/net_in/ class=md-nav__link> <span class=md-ellipsis> ğŸŒ Linuxå†…æ ¸ä¸­ç½‘ç»œæ˜¯å¦‚ä½•è¿›æ¥çš„ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_linux/problem/cpu/ class=md-nav__link> <span class=md-ellipsis> ğŸ’» CPUé—®é¢˜åˆ†æ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_linux/problem/memory/ class=md-nav__link> <span class=md-ellipsis> ğŸ§  Linuxå†…å­˜ç›¸å…³å‘½ä»¤ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_linux/problem/disk/ class=md-nav__link> <span class=md-ellipsis> ğŸ’¾ Linuxç£ç›˜ç›¸å…³å‘½ä»¤ </span> </a> </li> <li class=md-nav__item> <a href=../../chapter_linux/problem/net/ class=md-nav__link> <span class=md-ellipsis> ğŸŒ Linuxç½‘ç»œç›¸å…³å‘½ä»¤ </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=nioservercnxnfactory><strong>å¯æœåŠ¡ç«¯ç½‘ç»œç›‘å¬è¿æ¥NIOServerCnxnFactory</strong><a class=headerlink href=#nioservercnxnfactory title="Permanent link">&para;</a></h1> <h2 id=_1><strong>ç®€ä»‹</strong><a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>å›åˆ°QuorumPeerçš„start()æ–¹æ³•ï¼Œæ•°æ®æ¢å¤ä¹‹åå¼€å§‹è¿›è¡Œç½‘ç»œäº¤äº’ çš„startServerCnxnFactory();</p> <h3 id=startservercnxnfactory><strong>startServerCnxnFactory</strong><a class=headerlink href=#startservercnxnfactory title="Permanent link">&para;</a></h3> <p>ç»§ç»­å¾€ä¸‹çœ‹ï¼š</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startServerCnxnFactory</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cnxnFactory</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>        </span><span class=n>cnxnFactory</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>secureCnxnFactory</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=w>        </span><span class=n>secureCnxnFactory</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=p>}</span>
</span></code></pre></div> <p>åœ¨QuorumPeerMainç±»å‹ä¸­çš„runFromConfigæ–¹æ³•ä¸­ è°ƒç”¨ServerCnxnFactory.createFactory(); æ–¹æ³•åˆ›å»ºè¿æ¥å·¥å‚ åœ¨åˆ›å»ºå·¥å‚å¯¹è±¡æ–¹æ³•ä¸­é€šè¿‡åˆ¤æ–­JVMå‚æ•°zookeeper.serverCnxnFactoryå·¥å‚ç±»å‹é…ç½®å‚æ•°æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨çš„è¯å°†ä¼šé»˜è®¤NIOServerCnxnFactoryç±»å‹</p> <p>åˆ›å»ºè¿æ¥å¯¹è±¡çš„ä»£ç å¦‚ä¸‹ï¼š QuorumPeerMainç±»å‹çš„runFromConfigæ–¹æ³•ä¸­çš„è°ƒç”¨</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=na>getClientPortAddress</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=kc>null</span><span class=p>){</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=n>cnxnFactory</span><span class=w> </span><span class=o>=</span><span class=n>ServerCnxnFactory</span><span class=p>.</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=nf>createFactory</span><span class=p>();</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=w>                </span><span class=n>cnxnFactory</span><span class=p>.</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=nf>configure</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=na>getClientPortAddress</span><span class=p>(),</span><span class=n>config</span><span class=p>.</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=nf>getMaxClientCnxns</span><span class=p>(),</span><span class=n>config</span><span class=p>.</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=nf>getClientPortListenBacklog</span><span class=p>(),</span><span class=w> </span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>config</span><span class=p>.</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=nf>getSecureClientPortAddress</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=kc>null</span><span class=p>){</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=n>secureCnxnFactory</span><span class=w> </span><span class=o>=</span><span class=n>ServerCnxnFactory</span><span class=p>.</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a><span class=nf>createFactory</span><span class=p>();</span>
</span><span id=__span-1-20><a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a><span class=w>                </span><span class=n>secureCnxnFactory</span><span class=p>.</span>
</span><span id=__span-1-21><a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a>
</span><span id=__span-1-22><a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a><span class=nf>configure</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=na>getSecureClientPortAddress</span><span class=p>(),</span><span class=n>config</span><span class=p>.</span>
</span><span id=__span-1-23><a id=__codelineno-1-23 name=__codelineno-1-23 href=#__codelineno-1-23></a>
</span><span id=__span-1-24><a id=__codelineno-1-24 name=__codelineno-1-24 href=#__codelineno-1-24></a><span class=nf>getMaxClientCnxns</span><span class=p>(),</span><span class=n>config</span><span class=p>.</span>
</span><span id=__span-1-25><a id=__codelineno-1-25 name=__codelineno-1-25 href=#__codelineno-1-25></a>
</span><span id=__span-1-26><a id=__codelineno-1-26 name=__codelineno-1-26 href=#__codelineno-1-26></a><span class=nf>getClientPortListenBacklog</span><span class=p>(),</span><span class=w> </span><span class=kc>true</span><span class=p>);</span>
</span><span id=__span-1-27><a id=__codelineno-1-27 name=__codelineno-1-27 href=#__codelineno-1-27></a><span class=w>        </span><span class=p>}</span>
</span></code></pre></div> <p>ServerCnxnFactoryçš„createFactoryæ ¹æ®å‚æ•°ç±»å‹åˆ›å»ºå¯¹è±¡</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>ServerCnxnFactory</span><span class=w> </span><span class=nf>createFactory</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>serverCnxnFactoryName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>getProperty</span><span class=p>(</span><span class=n>ZOOKEEPER_SERVER_CNXN_FACTORY</span><span class=p>);</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>serverCnxnFactoryName</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>        </span><span class=n>serverCnxnFactoryName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NIOServerCnxnFactory</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>        </span><span class=n>ServerCnxnFactory</span><span class=w> </span><span class=n>serverCnxnFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ServerCnxnFactory</span><span class=p>)</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>serverCnxnFactoryName</span><span class=p>)</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>                </span><span class=p>.</span><span class=na>getDeclaredConstructor</span><span class=p>()</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>                </span><span class=p>.</span><span class=na>newInstance</span><span class=p>();</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&quot;Using {} as server connection factory&quot;</span><span class=p>,</span><span class=w> </span><span class=n>serverCnxnFactoryName</span><span class=p>);</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>serverCnxnFactory</span><span class=p>;</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=w>        </span><span class=n>IOException</span><span class=w> </span><span class=n>ioe</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IOException</span><span class=p>(</span><span class=s>&quot;Couldn&#39;t instantiate &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>serverCnxnFactoryName</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=n>ioe</span><span class=p>;</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=p>}</span>
</span></code></pre></div> <p>è¿æ¥å·¥å‚å¯åŠ¨ç³»ç»Ÿæä¾›äº†å±æ€§æ¥æŒ‡å®šè¿æ¥å·¥å‚å¯¹è±¡é»˜è®¤æƒ…å†µä¸‹ä¼šä½¿ç”¨ NIOServerCnxnFactory -JDKè‡ªå¸¦çš„NIOå·¥å…·å¦‚æœæŒ‡å®šäº†å±æ€§<code>zookeeper.serverCnxnFactory</code>æ¯”å¦‚NettyServerCnxnFactory -Nettyçš„NIOå·¥å…·ç±»å‹åˆ™åœ¨ä¸Šé¢åˆå§‹åŒ–çš„æ—¶å€™ä¼šåŠ è½½å¯¹åº”ç±»å‹,æ ¹æ®æˆ‘ä»¬å®¢æˆ·ç«¯é…ç½®çš„clientPortæ¥å¯ç”¨å¯¹åº”ç«¯å£æä¾›æŸ¥è¯¢åŠŸèƒ½ã€‚</p> <p>è¿™ä¸ªé€šä¿¡å®ç°å…ˆçœ‹çœ‹åˆ«äººæ€ä¹ˆè¯´ Zookeeperä½œä¸ºä¸€ä¸ªæœåŠ¡å™¨,è‡ªç„¶è¦ä¸å®¢æˆ·ç«¯è¿›è¡Œç½‘ç»œé€šä¿¡,å¦‚ä½•é«˜æ•ˆçš„ä¸å®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡, ZooKeeperä¸­ä½¿ç”¨ServerCnxnFactoryç®¡ç†ä¸å®¢æˆ·ç«¯çš„è¿æ¥,å…¶æœ‰ä¸¤ä¸ªå®ç°,</p> <ul> <li>ä¸€ä¸ªæ˜¯NIOServerCnxnFactory,ä½¿ç”¨ <strong>JavaåŸç”ŸNIOå®ç°</strong> ;</li> <li>ä¸€ä¸ªæ˜¯NettyServerCnxnFactory, ä½¿ç”¨ <strong>Nettyå®ç°</strong> ;</li> </ul> <p>ä½¿ç”¨ServerCnxnä»£è¡¨ä¸€ä¸ªå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„è¿æ¥. <img alt=14-cnxnfactory.png src=/img/chapter_zookeeper/14-cnxnfactory.png> ServerCnxnFactory æ³¨:ä¸‹æ–‡æˆ–æ³¨é‡Šä¸­çš„è¿æ¥å°±æ˜¯å®¢æˆ·ç«¯å‘èµ·çš„TCPè¿æ¥,ä¹Ÿå³SocketChannelç±» ZooKeeperå¯ä»¥é€šè¿‡è®¾ç½®ç³»ç»Ÿå±æ€§zookeeper.serverCnxnFactoryé…ç½®ServerCnxnFactoryçš„å®ç°ç±»,é»˜è®¤ä½¿ç”¨NIOServerCnxnFactory NIOServerCnxnFactory</p> <h2 id=reactoriomain-sub-reactor><strong>ä¸»ä»Reactorç½‘ç»œIOæ¨¡å‹main-sub reactor</strong><a class=headerlink href=#reactoriomain-sub-reactor title="Permanent link">&para;</a></h2> <p><img alt=14-2-reactor.png src=/img/chapter_zookeeper/14-2-reactor.png> ä¸€èˆ¬ä½¿ç”¨Java NIOçš„æ€è·¯ä¸ºä½¿ç”¨1ä¸ªçº¿ç¨‹ç»„ç›‘å¬OP_ACCEPTäº‹ä»¶,è´Ÿè´£å¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥;ä½¿ç”¨1ä¸ªçº¿ç¨‹ç»„ç›‘å¬å®¢æˆ·ç«¯è¿æ¥çš„OP_READå’ŒOP_WRITEäº‹ä»¶,å¤„ç†IOäº‹ä»¶( nettyä¾¿æ˜¯å¦‚æ­¤å®ç°).</p> <p>ä½†ZooKeeperå¹¶ä¸æ˜¯å¦‚æ­¤åˆ’åˆ†çº¿ç¨‹åŠŸèƒ½çš„,NIOServerCnxnFactoryå¯åŠ¨æ—¶ä¼šå¯åŠ¨å››ç±»çº¿ç¨‹</p> <ul> <li><strong>accept thread:</strong> è¯¥çº¿ç¨‹ <strong>æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥</strong> ,å¹¶å°†å…¶åˆ†é…ç»™selector thread(å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹)</li> <li><strong>selector thread:</strong> è¯¥çº¿ç¨‹ <strong>æ‰§è¡Œselect()</strong> ,ç”±äºåœ¨å¤„ç†å¤§é‡è¿æ¥æ—¶,select()ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆ,å› æ­¤å¯åŠ¨å¤šä¸ªselector thread,ä½¿ç”¨ç³»ç»Ÿå±æ€§zookeeper.nio.numSelectorThreadsé…ç½®è¯¥ç±»çº¿ç¨‹æ•°,é»˜è®¤ä¸ªæ•°ä¸º æ ¸å¿ƒæ•°/2â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾âˆšæ ¸å¿ƒæ•°/2(è‡³å°‘ä¸€ä¸ª)</li> <li><strong>worker thread:</strong> è¯¥çº¿ç¨‹æ‰§è¡Œ <strong>åŸºæœ¬çš„å¥—æ¥å­—è¯»å†™</strong> ,ä½¿ç”¨ç³»ç»Ÿå±æ€§zookeeper.nio.numWorkerThreadsé…ç½®è¯¥ç±»çº¿ç¨‹æ•°,é»˜è®¤ä¸ºæ ¸å¿ƒæ•°âˆ—2æ ¸å¿ƒæ•°âˆ—2.å¦‚æœè¯¥ç±»çº¿ç¨‹æ•°ä¸º0,åˆ™å¦å¤–å¯åŠ¨ä¸€çº¿ç¨‹è¿›è¡ŒIOå¤„ç†,è§ä¸‹æ–‡worker threadä»‹ç»</li> <li><strong>connection expiration thread:</strong> è‹¥è¿æ¥ä¸Šçš„ <strong>sessionå·²è¿‡æœŸ</strong> ,åˆ™å…³é—­è¯¥è¿æ¥</li> </ul> <p>å¯ä»¥çœ‹å‡º,ZooKeeperä¸­å¯¹çº¿ç¨‹éœ€è¦å¤„ç†çš„å·¥ä½œåšäº†æ›´ç»†çš„æ‹†åˆ†.å…¶è®¤ä¸ºåœ¨æœ‰å¤§é‡å®¢æˆ·ç«¯è¿æ¥çš„æƒ…å†µä¸‹, <code>selector.select()</code> ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆ,å› æ­¤å…¶å°† <code>selector.select()</code> æ‹†åˆ†å‡ºæ¥,äº¤ç”± <code>selector thread</code> å¤„ç†. çº¿ç¨‹é—´é€šä¿¡</p> <h2 id=_2><strong>åŒæ­¥é˜Ÿåˆ—</strong><a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <p>ä¸Šè¿°å„ç±»çº¿ç¨‹ä¹‹é—´é€šè¿‡åŒæ­¥é˜Ÿåˆ—é€šä¿¡.è¿™ä¸€å°èŠ‚æˆ‘ä»¬çœ‹ä¸‹å„ç±»çº¿ç¨‹é€šä¿¡ä½¿ç”¨å“ªå‡ ä¸ªåŒæ­¥é˜Ÿåˆ—?å„æœ‰ä»€ä¹ˆç”¨å¤„</p> <h3 id=selectorthreadacceptedqueue><strong>SelectorThread.acceptedQueue</strong><a class=headerlink href=#selectorthreadacceptedqueue title="Permanent link">&para;</a></h3> <p>acceptedQueueæ˜¯LinkedBlockingQueue<socketchannel>ç±»å‹çš„, åœ¨selector threadä¸­.å…¶ä¸­åŒ…å«äº†accept threadæ¥æ”¶çš„å®¢æˆ·ç«¯è¿æ¥,ç”±selector threadè´Ÿè´£å°†å®¢æˆ·ç«¯è¿æ¥æ³¨å†Œåˆ°selectorä¸Š,ç›‘å¬OP_READå’ŒOP_WRITE.</p> <h3 id=selectorthreadupdatequeue><strong>SelectorThread.updateQueue</strong><a class=headerlink href=#selectorthreadupdatequeue title="Permanent link">&para;</a></h3> <p>updateQueueå’ŒacceptedQueueä¸€æ ·,ä¹Ÿæ˜¯LinkedBlockingQueue<socketchannel>ç±»å‹çš„,åœ¨selector threadä¸­.ä½†æ˜¯è¦è¯´æ˜ç™½è¯¥é˜Ÿåˆ—çš„ä½œç”¨,å°±è¦å¯¹Java NIOçš„å®ç°éå¸¸äº†è§£äº†. _Java NIOä½¿ç”¨epollï¼ˆLinuxä¸­ï¼‰ç³»ç»Ÿè°ƒç”¨,ä¸”æ˜¯æ°´å¹³è§¦å‘,ä¹Ÿå³è‹¥selector.select()å‘ç°socketChannelä¸­æœ‰äº‹ä»¶å‘ç”Ÿ,æ¯”å¦‚æœ‰æ•°æ®å¯è¯», åªè¦æ²¡æœ‰å°†è¿™äº›æ•°æ®ä»socketChannelè¯»å–å®Œæ¯•,ä¸‹ä¸€æ¬¡selector.select()è¿˜æ˜¯ä¼šæ£€æµ‹åˆ°æœ‰äº‹ä»¶å‘ç”Ÿ,ç›´è‡³æ•°æ®è¢«è¯»å–å®Œæ¯•. ZooKeeperä¸€ç›´è®¤ä¸ºselector.select()æ˜¯æ€§èƒ½çš„ç“¶é¢ˆ,ä¸ºäº†æé«˜selector.select()çš„æ€§èƒ½,é¿å…ä¸Šè¿°æ°´å¹³è§¦å‘æ¨¡å¼çš„ç¼ºé™·,ZooKeeperåœ¨å¤„ç†IOçš„è¿‡ç¨‹ä¸­, ä¼šè®©socketChannelä¸å†ç›‘å¬OP_READå’ŒOP_WRITEäº‹ä»¶,è¿™æ ·å°±å¯ä»¥å‡è½»selector.select()çš„è´Ÿæ‹…. _</p> <p><strong>æ­¤æ—¶ä¾¿å‡ºç°ä¸€ä¸ªé—®é¢˜,IOå¤„ç†å®Œæ¯•å,å¦‚ä½•è®©socketChannelå†ç›‘å¬OP_READå’ŒOP_WRITEäº‹ä»¶?</strong> æœ‰çš„å°ä¼™ä¼´å¯èƒ½è®¤ä¸ºè¿™ä»¶äº‹æƒ…éå¸¸å®¹æ˜“,worker threadå¤„ç†IOç»“æŸå,ç›´æ¥è°ƒç”¨key.interestOps(OP_READ &amp; OP_WRITE)ä¸å°±å¯ä»¥äº†å—? äº‹æƒ…å¹¶æ²¡æœ‰è¿™ç®€å•,æ˜¯å› ä¸ºselector.select()æ˜¯åœ¨selector threadä¸­æ‰§è¡Œçš„, è‹¥åœ¨ <strong>selector.select()çš„è¿‡ç¨‹ä¸­</strong> ,worker threadè°ƒç”¨äº† <strong>key.interestOps(OP_READ &amp; OP_WRITE)</strong> , <strong>å¯èƒ½ä¼šé˜»å¡selector.select()</strong> .</p> <p>ZooKeeperä¸ºäº†è¿½æ±‚æ€§èƒ½çš„æè‡´,è®¾è®¡ä¸ºç”±selector threadè°ƒç”¨key.interestOps(OP_READ &amp; OP_WRITE), å› æ­¤worker threadå°±éœ€åœ¨IOå¤„ç†å®Œæ¯•åå‘Šè¯‰selector threadè¯¥socketChannelå¯ä»¥å»ç›‘å¬OP_READå’ŒOP_WRITEäº‹ä»¶äº†, <strong>updateQueueå°±æ˜¯å­˜æ”¾é‚£äº›éœ€è¦ç›‘å¬OP_READå’ŒOP_WRITEäº‹ä»¶çš„</strong></p> <h3 id=socketchannelnioservercnxnoutgoingbuffers><strong>socketChannel.NIOServerCnxn.outgoingBuffers</strong><a class=headerlink href=#socketchannelnioservercnxnoutgoingbuffers title="Permanent link">&para;</a></h3> <p>outgoingBufferså­˜æ”¾å¾…å‘é€ç»™å®¢æˆ·ç«¯çš„å“åº”æ•°æ®. æ³¨:æ—¢ç„¶key.interestOps(OP_READ &amp; OP_WRITE)ä¼šé˜»å¡selector.select(),é‚£ä¹ˆaccepted.register(selector, SelectionKey.OP_READ) ä¹Ÿä¼šé˜»å¡selector.select(), å› æ­¤æ¥æ”¶åˆ°çš„å®¢æˆ·ç«¯è¿æ¥æ³¨å†Œåˆ°selectorä¸Šä¹Ÿè¦åœ¨selector threadä¸Šæ‰§è¡Œ,è¿™ä¹Ÿæ˜¯acceptedQueueå­˜åœ¨çš„ç†ç”±</p> <h2 id=nioservercnxnfactory_1><strong>NIOServerCnxnFactory çš„åˆå§‹åŒ–é…ç½®æ–¹æ³•</strong><a class=headerlink href=#nioservercnxnfactory_1 title="Permanent link">&para;</a></h2> <p>äº†è§£äº†çº¿ç¨‹IOæ¨¡å‹æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¯åŠ¨çš„æºç ï¼š NIOServerCnxnFactoryçš„é…ç½®æ–¹æ³•ï¼Œè¿™ä¸ªæ˜¯åœ¨Zookeeperå¯åŠ¨æ—¶å‰é¢åŠ è½½é…ç½®ä¿¡æ¯æ—¶å€™ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼š</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=nd>@Override</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configure</span><span class=p>(</span><span class=n>InetSocketAddress</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>maxcc</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>backlog</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>secure</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>secure</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnsupportedOperationException</span><span class=p>(</span><span class=s>&quot;SSL isn&#39;t supported in NIOServerCnxn&quot;</span><span class=p>);</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>    </span><span class=n>configureSaslLogin</span><span class=p>();</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>    </span><span class=n>maxClientCnxns</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>maxcc</span><span class=p>;</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=w>    </span><span class=n>initMaxCnxns</span><span class=p>();</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=w>    </span><span class=n>sessionlessCnxnTimeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>getInteger</span><span class=p>(</span><span class=n>ZOOKEEPER_NIO_SESSIONLESS_CNXN_TIMEOUT</span><span class=p>,</span><span class=w> </span><span class=mi>10000</span><span class=p>);</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=w>    </span><span class=c1>// We also use the sessionlessCnxnTimeout as expiring interval for</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=w>    </span><span class=c1>// cnxnExpiryQueue. These don&#39;t need to be the same, but the expiring</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=w>    </span><span class=c1>// interval passed into the ExpiryQueue() constructor below should be</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=w>    </span><span class=c1>// less than or equal to the timeout.</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=w>    </span><span class=n>cnxnExpiryQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ExpiryQueue</span><span class=o>&lt;</span><span class=n>NIOServerCnxn</span><span class=o>&gt;</span><span class=p>(</span><span class=n>sessionlessCnxnTimeout</span><span class=p>);</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=w>    </span><span class=n>expirerThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConnectionExpirerThread</span><span class=p>();</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>numCores</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>availableProcessors</span><span class=p>();</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=w>    </span><span class=c1>// 32 cores sweet spot seems to be 4 selector threads</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a><span class=w>    </span><span class=n>numSelectorThreads</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>getInteger</span><span class=p>(</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a><span class=w>            </span><span class=n>ZOOKEEPER_NIO_NUM_SELECTOR_THREADS</span><span class=p>,</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=w>            </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>sqrt</span><span class=p>((</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=n>numCores</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>2</span><span class=p>),</span><span class=w> </span><span class=mi>1</span><span class=p>));</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>numSelectorThreads</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IOException</span><span class=p>(</span><span class=s>&quot;numSelectorThreads must be at least 1&quot;</span><span class=p>);</span>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a><span class=w>    </span><span class=n>numWorkerThreads</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>getInteger</span><span class=p>(</span><span class=n>ZOOKEEPER_NIO_NUM_WORKER_THREADS</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>numCores</span><span class=p>);</span>
</span><span id=__span-3-28><a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a><span class=w>    </span><span class=n>workerShutdownTimeoutMS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>getLong</span><span class=p>(</span><span class=n>ZOOKEEPER_NIO_SHUTDOWN_TIMEOUT</span><span class=p>,</span><span class=w> </span><span class=mi>5000</span><span class=p>);</span>
</span><span id=__span-3-29><a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a>
</span><span id=__span-3-30><a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>logMsg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Configuring NIO connection handler with &quot;</span>
</span><span id=__span-3-31><a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a><span class=w>            </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>sessionlessCnxnTimeout</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>1000</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;s sessionless connection timeout, &quot;</span>
</span><span id=__span-3-32><a id=__codelineno-3-32 name=__codelineno-3-32 href=#__codelineno-3-32></a><span class=w>            </span><span class=o>+</span><span class=w> </span><span class=n>numSelectorThreads</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; selector thread(s), &quot;</span>
</span><span id=__span-3-33><a id=__codelineno-3-33 name=__codelineno-3-33 href=#__codelineno-3-33></a><span class=w>            </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>numWorkerThreads</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>numWorkerThreads</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&quot;no&quot;</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; worker threads, and &quot;</span>
</span><span id=__span-3-34><a id=__codelineno-3-34 name=__codelineno-3-34 href=#__codelineno-3-34></a><span class=w>            </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>directBufferBytes</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s>&quot;gathered writes.&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=s>&quot;&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>directBufferBytes</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>1024</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; kB direct buffers.&quot;</span><span class=p>));</span>
</span><span id=__span-3-35><a id=__codelineno-3-35 name=__codelineno-3-35 href=#__codelineno-3-35></a><span class=w>    </span><span class=n>LOG</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=n>logMsg</span><span class=p>);</span>
</span><span id=__span-3-36><a id=__codelineno-3-36 name=__codelineno-3-36 href=#__codelineno-3-36></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>numSelectorThreads</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-37><a id=__codelineno-3-37 name=__codelineno-3-37 href=#__codelineno-3-37></a><span class=w>        </span><span class=n>selectorThreads</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>SelectorThread</span><span class=p>(</span><span class=n>i</span><span class=p>));</span>
</span><span id=__span-3-38><a id=__codelineno-3-38 name=__codelineno-3-38 href=#__codelineno-3-38></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-3-39><a id=__codelineno-3-39 name=__codelineno-3-39 href=#__codelineno-3-39></a>
</span><span id=__span-3-40><a id=__codelineno-3-40 name=__codelineno-3-40 href=#__codelineno-3-40></a><span class=w>    </span><span class=n>listenBacklog</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>backlog</span><span class=p>;</span>
</span><span id=__span-3-41><a id=__codelineno-3-41 name=__codelineno-3-41 href=#__codelineno-3-41></a><span class=c1>//åˆ›å»ºsocketå¯¹è±¡ï¼Œè·å–æ–‡ä»¶æè¿°ç¬¦</span>
</span><span id=__span-3-42><a id=__codelineno-3-42 name=__codelineno-3-42 href=#__codelineno-3-42></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>ss</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ServerSocketChannel</span><span class=p>.</span><span class=na>open</span><span class=p>();</span>
</span><span id=__span-3-43><a id=__codelineno-3-43 name=__codelineno-3-43 href=#__codelineno-3-43></a><span class=w>    </span><span class=n>ss</span><span class=p>.</span><span class=na>socket</span><span class=p>().</span><span class=na>setReuseAddress</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span><span id=__span-3-44><a id=__codelineno-3-44 name=__codelineno-3-44 href=#__codelineno-3-44></a><span class=w>    </span><span class=n>LOG</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&quot;binding to port {}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>);</span>
</span><span id=__span-3-45><a id=__codelineno-3-45 name=__codelineno-3-45 href=#__codelineno-3-45></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>listenBacklog</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-46><a id=__codelineno-3-46 name=__codelineno-3-46 href=#__codelineno-3-46></a><span class=w>        </span><span class=n>ss</span><span class=p>.</span><span class=na>socket</span><span class=p>().</span><span class=na>bind</span><span class=p>(</span><span class=n>addr</span><span class=p>);</span>
</span><span id=__span-3-47><a id=__codelineno-3-47 name=__codelineno-3-47 href=#__codelineno-3-47></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-48><a id=__codelineno-3-48 name=__codelineno-3-48 href=#__codelineno-3-48></a><span class=w>        </span><span class=n>ss</span><span class=p>.</span><span class=na>socket</span><span class=p>().</span><span class=na>bind</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>listenBacklog</span><span class=p>);</span>
</span><span id=__span-3-49><a id=__codelineno-3-49 name=__codelineno-3-49 href=#__codelineno-3-49></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-3-50><a id=__codelineno-3-50 name=__codelineno-3-50 href=#__codelineno-3-50></a><span class=w>    </span><span class=n>ss</span><span class=p>.</span><span class=na>configureBlocking</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-3-51><a id=__codelineno-3-51 name=__codelineno-3-51 href=#__codelineno-3-51></a><span class=w>    </span><span class=n>acceptThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AcceptThread</span><span class=p>(</span><span class=n>ss</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>selectorThreads</span><span class=p>);</span>
</span><span id=__span-3-52><a id=__codelineno-3-52 name=__codelineno-3-52 href=#__codelineno-3-52></a><span class=p>}</span>
</span></code></pre></div> <h2 id=nioservercnxnfactory_2><strong>NIOServerCnxnFactoryçš„å¯åŠ¨æ–¹æ³•</strong><a class=headerlink href=#nioservercnxnfactory_2 title="Permanent link">&para;</a></h2> <div class="language-java highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=nd>@Override</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>    </span><span class=n>stopped</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=c1>//å¯åŠ¨å·¥ä½œçº¿ç¨‹</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>workerPool</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>        </span><span class=n>workerPool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WorkerService</span><span class=p>(</span><span class=s>&quot;NIOWorker&quot;</span><span class=p>,</span><span class=w> </span><span class=n>numWorkerThreads</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=c1>//å¯åŠ¨selectorçº¿ç¨‹</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>SelectorThread</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>selectorThreads</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>thread</span><span class=p>.</span><span class=na>getState</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>State</span><span class=p>.</span><span class=na>NEW</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=w>            </span><span class=n>thread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=c1>//å¯åŠ¨acceptçº¿ç¨‹</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=w>    </span><span class=c1>// ensure thread is started once and only once</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>acceptThread</span><span class=p>.</span><span class=na>getState</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>State</span><span class=p>.</span><span class=na>NEW</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=w>        </span><span class=n>acceptThread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=c1>//å¯åŠ¨è¿‡æœŸå¤„ç†çº¿ç¨‹</span>
</span><span id=__span-4-20><a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>expirerThread</span><span class=p>.</span><span class=na>getState</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>State</span><span class=p>.</span><span class=na>NEW</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-21><a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=w>        </span><span class=n>expirerThread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>
</span><span id=__span-4-22><a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-4-23><a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a><span class=p>}</span>
</span></code></pre></div> <h2 id=acceptthread><strong>AcceptThread</strong><a class=headerlink href=#acceptthread title="Permanent link">&para;</a></h2> <h3 id=acceptthread_1><strong>AcceptThreadç±»å‹æºç </strong><a class=headerlink href=#acceptthread_1 title="Permanent link">&para;</a></h3> <p>accept threadçš„æºç å¦‚ä¸‹ï¼šå…ˆå…¨å±€çœ‹ä¸‹ï¼š</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kd>private</span><span class=w> </span><span class=kd>class</span> <span class=nc>AcceptThread</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractSelectThread</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ServerSocketChannel</span><span class=w> </span><span class=n>acceptSocket</span><span class=p>;</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>acceptKey</span><span class=p>;</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>RateLogger</span><span class=w> </span><span class=n>acceptErrorLogger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RateLogger</span><span class=p>(</span><span class=n>LOG</span><span class=p>);</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Collection</span><span class=o>&lt;</span><span class=n>SelectorThread</span><span class=o>&gt;</span><span class=w> </span><span class=n>selectorThreads</span><span class=p>;</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectorThread</span><span class=o>&gt;</span><span class=w> </span><span class=n>selectorIterator</span><span class=p>;</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>reconfiguring</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AcceptThread</span><span class=p>(</span><span class=n>ServerSocketChannel</span><span class=w> </span><span class=n>ss</span><span class=p>,</span><span class=w> </span><span class=n>InetSocketAddress</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>SelectorThread</span><span class=o>&gt;</span><span class=w> </span><span class=n>selectorThreads</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=s>&quot;NIOServerCxnFactory.AcceptThread:&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>addr</span><span class=p>);</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>acceptSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ss</span><span class=p>;</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=c1>//å‘é€šé“æ³¨å†Œæ¥æ”¶äº‹ä»¶</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>acceptKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>acceptSocket</span><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>selector</span><span class=p>,</span><span class=w> </span><span class=n>SelectionKey</span><span class=p>.</span><span class=na>OP_ACCEPT</span><span class=p>);</span>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>selectorThreads</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Collections</span><span class=p>.</span><span class=na>unmodifiableList</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>SelectorThread</span><span class=o>&gt;</span><span class=p>(</span><span class=n>selectorThreads</span><span class=p>));</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a><span class=w>        </span><span class=n>selectorIterator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>selectorThreads</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stopped</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>acceptSocket</span><span class=p>.</span><span class=na>socket</span><span class=p>().</span><span class=na>isClosed</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a><span class=c1>//æœªå…³é—­åˆ™å¾ªç¯æ‰§è¡Œselectæ–¹æ³•</span>
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a><span class=w>                    </span><span class=n>select</span><span class=p>();</span>
</span><span id=__span-5-25><a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-26><a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a><span class=w>                    </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Ignoring unexpected runtime exception&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-5-27><a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-28><a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a><span class=w>                    </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Ignoring unexpected exception&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-5-29><a id=__codelineno-5-29 name=__codelineno-5-29 href=#__codelineno-5-29></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-5-30><a id=__codelineno-5-30 name=__codelineno-5-30 href=#__codelineno-5-30></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-5-31><a id=__codelineno-5-31 name=__codelineno-5-31 href=#__codelineno-5-31></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-32><a id=__codelineno-5-32 name=__codelineno-5-32 href=#__codelineno-5-32></a><span class=w>            </span><span class=n>closeSelector</span><span class=p>();</span>
</span><span id=__span-5-33><a id=__codelineno-5-33 name=__codelineno-5-33 href=#__codelineno-5-33></a><span class=w>            </span><span class=c1>// This will wake up the selector threads, and tell the</span>
</span><span id=__span-5-34><a id=__codelineno-5-34 name=__codelineno-5-34 href=#__codelineno-5-34></a><span class=w>            </span><span class=c1>// worker thread pool to begin shutdown.</span>
</span><span id=__span-5-35><a id=__codelineno-5-35 name=__codelineno-5-35 href=#__codelineno-5-35></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>reconfiguring</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-36><a id=__codelineno-5-36 name=__codelineno-5-36 href=#__codelineno-5-36></a><span class=w>                </span><span class=n>NIOServerCnxnFactory</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>stop</span><span class=p>();</span>
</span><span id=__span-5-37><a id=__codelineno-5-37 name=__codelineno-5-37 href=#__codelineno-5-37></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-5-38><a id=__codelineno-5-38 name=__codelineno-5-38 href=#__codelineno-5-38></a><span class=w>            </span><span class=n>LOG</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&quot;accept thread exitted run method&quot;</span><span class=p>);</span>
</span><span id=__span-5-39><a id=__codelineno-5-39 name=__codelineno-5-39 href=#__codelineno-5-39></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-5-40><a id=__codelineno-5-40 name=__codelineno-5-40 href=#__codelineno-5-40></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-5-41><a id=__codelineno-5-41 name=__codelineno-5-41 href=#__codelineno-5-41></a>
</span><span id=__span-5-42><a id=__codelineno-5-42 name=__codelineno-5-42 href=#__codelineno-5-42></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>select</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-43><a id=__codelineno-5-43 name=__codelineno-5-43 href=#__codelineno-5-43></a><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-44><a id=__codelineno-5-44 name=__codelineno-5-44 href=#__codelineno-5-44></a><span class=c1>//é˜»å¡åˆ°è‡³å°‘æœ‰ä¸€ä¸ªé€šé“åœ¨ä½ æ³¨å†Œçš„äº‹ä»¶ä¸Šå°±ç»ªäº†ã€‚</span>
</span><span id=__span-5-45><a id=__codelineno-5-45 name=__codelineno-5-45 href=#__codelineno-5-45></a><span class=w>            </span><span class=n>selector</span><span class=p>.</span><span class=na>select</span><span class=p>();</span>
</span><span id=__span-5-46><a id=__codelineno-5-46 name=__codelineno-5-46 href=#__codelineno-5-46></a><span class=c1>//ä¸€æ—¦è°ƒç”¨select()æ–¹æ³•ï¼Œå¹¶ä¸”è¿”å›å€¼ä¸ä¸º0æ—¶ï¼Œåˆ™ å¯ä»¥é€šè¿‡è°ƒç”¨Selectorçš„selectedKeys()æ–¹æ³•æ¥è®¿é—®å·²é€‰æ‹©é”®é›†åˆ</span>
</span><span id=__span-5-47><a id=__codelineno-5-47 name=__codelineno-5-47 href=#__codelineno-5-47></a><span class=w>            </span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span><span class=w> </span><span class=n>selectedKeys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selector</span><span class=p>.</span><span class=na>selectedKeys</span><span class=p>().</span><span class=na>iterator</span><span class=p>();</span>
</span><span id=__span-5-48><a id=__codelineno-5-48 name=__codelineno-5-48 href=#__codelineno-5-48></a><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stopped</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>selectedKeys</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-49><a id=__codelineno-5-49 name=__codelineno-5-49 href=#__codelineno-5-49></a><span class=w>                </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selectedKeys</span><span class=p>.</span><span class=na>next</span><span class=p>();</span>
</span><span id=__span-5-50><a id=__codelineno-5-50 name=__codelineno-5-50 href=#__codelineno-5-50></a><span class=w>                </span><span class=n>selectedKeys</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span>
</span><span id=__span-5-51><a id=__codelineno-5-51 name=__codelineno-5-51 href=#__codelineno-5-51></a>
</span><span id=__span-5-52><a id=__codelineno-5-52 name=__codelineno-5-52 href=#__codelineno-5-52></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>key</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-53><a id=__codelineno-5-53 name=__codelineno-5-53 href=#__codelineno-5-53></a><span class=w>                    </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-5-54><a id=__codelineno-5-54 name=__codelineno-5-54 href=#__codelineno-5-54></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-5-55><a id=__codelineno-5-55 name=__codelineno-5-55 href=#__codelineno-5-55></a><span class=c1>//æµ‹è¯•æ­¤é”®çš„é€šé“æ˜¯å¦å·²å‡†å¤‡å¥½æ¥å—æ–°çš„å¥—æ¥å­—è¿æ¥ã€‚</span>
</span><span id=__span-5-56><a id=__codelineno-5-56 name=__codelineno-5-56 href=#__codelineno-5-56></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>isAcceptable</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-57><a id=__codelineno-5-57 name=__codelineno-5-57 href=#__codelineno-5-57></a><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>doAccept</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-58><a id=__codelineno-5-58 name=__codelineno-5-58 href=#__codelineno-5-58></a><span class=w>                        </span><span class=c1>// If unable to pull a new connection off the accept</span>
</span><span id=__span-5-59><a id=__codelineno-5-59 name=__codelineno-5-59 href=#__codelineno-5-59></a><span class=w>                        </span><span class=c1>// queue, pause accepting to give us time to free</span>
</span><span id=__span-5-60><a id=__codelineno-5-60 name=__codelineno-5-60 href=#__codelineno-5-60></a><span class=w>                        </span><span class=c1>// up file descriptors and so the accept thread</span>
</span><span id=__span-5-61><a id=__codelineno-5-61 name=__codelineno-5-61 href=#__codelineno-5-61></a><span class=w>                        </span><span class=c1>// doesn&#39;t spin in a tight loop.</span>
</span><span id=__span-5-62><a id=__codelineno-5-62 name=__codelineno-5-62 href=#__codelineno-5-62></a><span class=w>                        </span><span class=n>pauseAccept</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</span><span id=__span-5-63><a id=__codelineno-5-63 name=__codelineno-5-63 href=#__codelineno-5-63></a><span class=w>                    </span><span class=p>}</span>
</span><span id=__span-5-64><a id=__codelineno-5-64 name=__codelineno-5-64 href=#__codelineno-5-64></a><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-65><a id=__codelineno-5-65 name=__codelineno-5-65 href=#__codelineno-5-65></a><span class=w>                    </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Unexpected ops in accept select {}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>readyOps</span><span class=p>());</span>
</span><span id=__span-5-66><a id=__codelineno-5-66 name=__codelineno-5-66 href=#__codelineno-5-66></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-5-67><a id=__codelineno-5-67 name=__codelineno-5-67 href=#__codelineno-5-67></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-5-68><a id=__codelineno-5-68 name=__codelineno-5-68 href=#__codelineno-5-68></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-69><a id=__codelineno-5-69 name=__codelineno-5-69 href=#__codelineno-5-69></a><span class=w>            </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Ignoring IOException while selecting&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-5-70><a id=__codelineno-5-70 name=__codelineno-5-70 href=#__codelineno-5-70></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-5-71><a id=__codelineno-5-71 name=__codelineno-5-71 href=#__codelineno-5-71></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-5-72><a id=__codelineno-5-72 name=__codelineno-5-72 href=#__codelineno-5-72></a>
</span><span id=__span-5-73><a id=__codelineno-5-73 name=__codelineno-5-73 href=#__codelineno-5-73></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>doAccept</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-74><a id=__codelineno-5-74 name=__codelineno-5-74 href=#__codelineno-5-74></a><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>accepted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-5-75><a id=__codelineno-5-75 name=__codelineno-5-75 href=#__codelineno-5-75></a><span class=w>        </span><span class=n>SocketChannel</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-5-76><a id=__codelineno-5-76 name=__codelineno-5-76 href=#__codelineno-5-76></a><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-77><a id=__codelineno-5-77 name=__codelineno-5-77 href=#__codelineno-5-77></a><span class=c1>// accept() æ–¹æ³•ç›‘å¬æ–°è¿›æ¥çš„è¿æ¥ã€‚å½“ accept()æ–¹æ³•è¿”å›çš„æ—¶å€™,å®ƒè¿”å›ä¸€ä¸ªåŒ…å«æ–°è¿›æ¥çš„è¿æ¥çš„ SocketChannelã€‚å› æ­¤, accept()æ–¹æ³•ä¼šä¸€ç›´é˜»å¡åˆ°æœ‰æ–°è¿æ¥åˆ°è¾¾</span>
</span><span id=__span-5-78><a id=__codelineno-5-78 name=__codelineno-5-78 href=#__codelineno-5-78></a><span class=w>            </span><span class=n>sc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>acceptSocket</span><span class=p>.</span><span class=na>accept</span><span class=p>();</span>
</span><span id=__span-5-79><a id=__codelineno-5-79 name=__codelineno-5-79 href=#__codelineno-5-79></a><span class=w>            </span><span class=n>accepted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-5-80><a id=__codelineno-5-80 name=__codelineno-5-80 href=#__codelineno-5-80></a><span class=c1>//å½“å‰è¿æ¥æ•°è¶…è¿‡é…ç½®æœ€å¤§è¿æ¥æ•°é‡åˆ™æ‹’ç»æ¥å—æ–°è¿›è¿æ¥</span>
</span><span id=__span-5-81><a id=__codelineno-5-81 name=__codelineno-5-81 href=#__codelineno-5-81></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>limitTotalNumberOfCnxns</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-82><a id=__codelineno-5-82 name=__codelineno-5-82 href=#__codelineno-5-82></a><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IOException</span><span class=p>(</span><span class=s>&quot;Too many connections max allowed is &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>maxCnxns</span><span class=p>);</span>
</span><span id=__span-5-83><a id=__codelineno-5-83 name=__codelineno-5-83 href=#__codelineno-5-83></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-5-84><a id=__codelineno-5-84 name=__codelineno-5-84 href=#__codelineno-5-84></a><span class=c1>//è·å–å½“å‰è¿æ¥çš„åœ°å€</span>
</span><span id=__span-5-85><a id=__codelineno-5-85 name=__codelineno-5-85 href=#__codelineno-5-85></a><span class=w>            </span><span class=n>InetAddress</span><span class=w> </span><span class=n>ia</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sc</span><span class=p>.</span><span class=na>socket</span><span class=p>().</span><span class=na>getInetAddress</span><span class=p>();</span>
</span><span id=__span-5-86><a id=__codelineno-5-86 name=__codelineno-5-86 href=#__codelineno-5-86></a><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>cnxncount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getClientCnxnCount</span><span class=p>(</span><span class=n>ia</span><span class=p>);</span>
</span><span id=__span-5-87><a id=__codelineno-5-87 name=__codelineno-5-87 href=#__codelineno-5-87></a><span class=c1>//å•ä¸ªå®¢æˆ·ç«¯é“¾æ¥æ•°é‡è¶…è¿‡ä¸Šé™</span>
</span><span id=__span-5-88><a id=__codelineno-5-88 name=__codelineno-5-88 href=#__codelineno-5-88></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>maxClientCnxns</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>cnxncount</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>maxClientCnxns</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-89><a id=__codelineno-5-89 name=__codelineno-5-89 href=#__codelineno-5-89></a><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IOException</span><span class=p>(</span><span class=s>&quot;Too many connections from &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ia</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; - max is &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>maxClientCnxns</span><span class=p>);</span>
</span><span id=__span-5-90><a id=__codelineno-5-90 name=__codelineno-5-90 href=#__codelineno-5-90></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-5-91><a id=__codelineno-5-91 name=__codelineno-5-91 href=#__codelineno-5-91></a>
</span><span id=__span-5-92><a id=__codelineno-5-92 name=__codelineno-5-92 href=#__codelineno-5-92></a><span class=w>            </span><span class=n>LOG</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&quot;Accepted socket connection from {}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>sc</span><span class=p>.</span><span class=na>socket</span><span class=p>().</span><span class=na>getRemoteSocketAddress</span><span class=p>());</span>
</span><span id=__span-5-93><a id=__codelineno-5-93 name=__codelineno-5-93 href=#__codelineno-5-93></a><span class=c1>//å¯ä»¥è®¾ç½® SocketChannel ä¸ºéé˜»å¡æ¨¡å¼ï¼ˆnon-blocking modeï¼‰.è®¾ç½®ä¹‹åï¼Œå°±å¯ä»¥åœ¨å¼‚æ­¥æ¨¡å¼ä¸‹è°ƒç”¨connect(), read() å’Œwrite()äº†ã€‚</span>
</span><span id=__span-5-94><a id=__codelineno-5-94 name=__codelineno-5-94 href=#__codelineno-5-94></a>
</span><span id=__span-5-95><a id=__codelineno-5-95 name=__codelineno-5-95 href=#__codelineno-5-95></a><span class=w>            </span><span class=n>sc</span><span class=p>.</span><span class=na>configureBlocking</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-5-96><a id=__codelineno-5-96 name=__codelineno-5-96 href=#__codelineno-5-96></a>
</span><span id=__span-5-97><a id=__codelineno-5-97 name=__codelineno-5-97 href=#__codelineno-5-97></a><span class=w>            </span><span class=c1>// Round-robin assign this connection to a selector thread</span>
</span><span id=__span-5-98><a id=__codelineno-5-98 name=__codelineno-5-98 href=#__codelineno-5-98></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>selectorIterator</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-99><a id=__codelineno-5-99 name=__codelineno-5-99 href=#__codelineno-5-99></a><span class=w>                </span><span class=n>selectorIterator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selectorThreads</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span>
</span><span id=__span-5-100><a id=__codelineno-5-100 name=__codelineno-5-100 href=#__codelineno-5-100></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-5-101><a id=__codelineno-5-101 name=__codelineno-5-101 href=#__codelineno-5-101></a><span class=c1>//è·å–å½“å‰çš„Selectorçº¿ç¨‹</span>
</span><span id=__span-5-102><a id=__codelineno-5-102 name=__codelineno-5-102 href=#__codelineno-5-102></a><span class=w>            </span><span class=n>SelectorThread</span><span class=w> </span><span class=n>selectorThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selectorIterator</span><span class=p>.</span><span class=na>next</span><span class=p>();</span>
</span><span id=__span-5-103><a id=__codelineno-5-103 name=__codelineno-5-103 href=#__codelineno-5-103></a><span class=c1>//è°ƒç”¨é€‰æ‹©çº¿ç¨‹çš„æ¥æ”¶è¯·æ±‚æ–¹æ³•*å°†æ–°æ¥å—çš„è¿æ¥æ”¾åˆ°ç­‰å¾…æ·»åŠ çš„é˜Ÿåˆ—ä¸­ã€‚ </span>
</span><span id=__span-5-104><a id=__codelineno-5-104 name=__codelineno-5-104 href=#__codelineno-5-104></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>selectorThread</span><span class=p>.</span><span class=na>addAcceptedConnection</span><span class=p>(</span><span class=n>sc</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-105><a id=__codelineno-5-105 name=__codelineno-5-105 href=#__codelineno-5-105></a><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IOException</span><span class=p>(</span><span class=s>&quot;Unable to add connection to selector queue&quot;</span>
</span><span id=__span-5-106><a id=__codelineno-5-106 name=__codelineno-5-106 href=#__codelineno-5-106></a><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>stopped</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s>&quot; (shutdown in progress)&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=p>));</span>
</span><span id=__span-5-107><a id=__codelineno-5-107 name=__codelineno-5-107 href=#__codelineno-5-107></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-5-108><a id=__codelineno-5-108 name=__codelineno-5-108 href=#__codelineno-5-108></a><span class=w>            </span><span class=n>acceptErrorLogger</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span>
</span><span id=__span-5-109><a id=__codelineno-5-109 name=__codelineno-5-109 href=#__codelineno-5-109></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-110><a id=__codelineno-5-110 name=__codelineno-5-110 href=#__codelineno-5-110></a><span class=w>            </span><span class=c1>// accept, maxClientCnxns, configureBlocking</span>
</span><span id=__span-5-111><a id=__codelineno-5-111 name=__codelineno-5-111 href=#__codelineno-5-111></a><span class=w>            </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>CONNECTION_REJECTED</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-5-112><a id=__codelineno-5-112 name=__codelineno-5-112 href=#__codelineno-5-112></a><span class=w>            </span><span class=n>acceptErrorLogger</span><span class=p>.</span><span class=na>rateLimitLog</span><span class=p>(</span><span class=s>&quot;Error accepting new connection: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span>
</span><span id=__span-5-113><a id=__codelineno-5-113 name=__codelineno-5-113 href=#__codelineno-5-113></a><span class=w>            </span><span class=n>fastCloseSock</span><span class=p>(</span><span class=n>sc</span><span class=p>);</span>
</span><span id=__span-5-114><a id=__codelineno-5-114 name=__codelineno-5-114 href=#__codelineno-5-114></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-5-115><a id=__codelineno-5-115 name=__codelineno-5-115 href=#__codelineno-5-115></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>accepted</span><span class=p>;</span>
</span><span id=__span-5-116><a id=__codelineno-5-116 name=__codelineno-5-116 href=#__codelineno-5-116></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-5-117><a id=__codelineno-5-117 name=__codelineno-5-117 href=#__codelineno-5-117></a>
</span><span id=__span-5-118><a id=__codelineno-5-118 name=__codelineno-5-118 href=#__codelineno-5-118></a><span class=p>}</span>
</span></code></pre></div> <h3 id=pauseaccept><strong>pauseAcceptæš‚åœæ¥æ”¶</strong><a class=headerlink href=#pauseaccept title="Permanent link">&para;</a></h3> <div class="language-java highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=c1>//å¦‚æœæ— æ³•å°†æ–°è¿æ¥ä»æ¥å—é˜Ÿåˆ—ä¸­æ‹‰å‡ºï¼Œåˆ™æš‚åœæ¥å—ä»¥ç»™æˆ‘ä»¬æ—¶é—´é‡Šæ”¾æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™æ ·æ¥å—çº¿ç¨‹å°±ä¸ä¼šåœ¨ä¸€ä¸ªç´§å¯†çš„å¾ªç¯ä¸­æ—‹è½¬ã€‚</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>pauseAccept</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>millisecs</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>    </span><span class=n>acceptKey</span><span class=p>.</span><span class=na>interestOps</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=w>        </span><span class=n>selector</span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>millisecs</span><span class=p>);</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=w>        </span><span class=c1>// ignore</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>        </span><span class=n>acceptKey</span><span class=p>.</span><span class=na>interestOps</span><span class=p>(</span><span class=n>SelectionKey</span><span class=p>.</span><span class=na>OP_ACCEPT</span><span class=p>);</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=p>}</span>
</span></code></pre></div> <h2 id=selectorthread><strong>SelectorThread</strong><a class=headerlink href=#selectorthread title="Permanent link">&para;</a></h2> <h3 id=selectorthread_1><strong>SelectorThreadç±»å‹æºç </strong><a class=headerlink href=#selectorthread_1 title="Permanent link">&para;</a></h3> <p>SelectorThread SelectorThreadä»AcceptThreadæ¥æ”¶æ–°æ¥æ”¶çš„è¿æ¥ï¼Œå¹¶è´Ÿè´£é€‰æ‹©è¿æ¥ä¹‹é—´çš„I/Oå‡†å¤‡æƒ…å†µã€‚ è¿™ä¸ªçº¿ç¨‹æ˜¯å”¯ä¸€ä¸€ä¸ªå¯¹é€‰æ‹©å™¨æ‰§è¡Œ <strong>éçº¿ç¨‹å®‰å…¨æˆ–æ½œåœ¨é˜»å¡è°ƒç”¨çš„çº¿ç¨‹</strong> (æ³¨å†Œæ–°è¿æ¥å’Œè¯»å†™æ“ä½œ)ã€‚ å°†ä¸€ä¸ªè¿æ¥åˆ†é…ç»™ä¸€ä¸ªSelectorThreadæ˜¯æ°¸ä¹…çš„ï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ªSelectorThreadä¼šä¸è¿™ä¸ªè¿æ¥äº¤äº’ã€‚ æœ‰1-Nä¸ªSelectorThreadsï¼Œè¿æ¥å¹³å‡åˆ†é…åœ¨SelectorThreadsä¹‹é—´ã€‚</p> <p>å¦‚æœæœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ± ï¼Œå½“ä¸€ä¸ªè¿æ¥æœ‰I/Oæ¥æ‰§è¡Œæ—¶ï¼ŒSelectorThreadé€šè¿‡æ¸…é™¤å®ƒæ„Ÿå…´è¶£çš„æ“ä½œå°†å®ƒä»é€‰æ‹©ä¸­åˆ é™¤ï¼Œå¹¶å®‰æ’I/Oç”±å·¥ä½œçº¿ç¨‹å¤„ç†ã€‚</p> <p>å½“å·¥ä½œå®Œæˆæ—¶ï¼Œè¿æ¥è¢«æ”¾ç½®åœ¨å°±ç»ªé˜Ÿåˆ—ä¸Šï¼Œä»¥æ¢å¤å…¶æ„Ÿå…´è¶£çš„æ“ä½œå¹¶æ¢å¤é€‰æ‹©ã€‚</p> <p>å¦‚æœæ²¡æœ‰å·¥ä½œçº¿ç¨‹æ± ï¼ŒSelectorThreadå°†ç›´æ¥æ‰§è¡ŒI/Oæ“ä½œã€‚</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=kd>class</span> <span class=nc>SelectorThread</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractSelectThread</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>;</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Queue</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;</span><span class=w> </span><span class=n>acceptedQueue</span><span class=p>;</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Queue</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span><span class=w> </span><span class=n>updateQueue</span><span class=p>;</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>SelectorThread</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=s>&quot;NIOServerCxnFactory.SelectorThread-&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>id</span><span class=p>);</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>id</span><span class=p>;</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=w>        </span><span class=n>acceptedQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedBlockingQueue</span><span class=o>&lt;</span><span class=n>SocketChannel</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=w>        </span><span class=n>updateQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedBlockingQueue</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span><span class=p>();</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a><span class=w>    </span><span class=cm>/**</span>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a><span class=cm>     * Place new accepted connection onto a queue for adding. Do this</span>
</span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=cm>     * so only the selector thread modifies what keys are registered</span>
</span><span id=__span-7-17><a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a><span class=cm>     * with the selector.</span>
</span><span id=__span-7-18><a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a><span class=cm>     å°†æ–°æ¥å—çš„è¿æ¥æ”¾åˆ°è¦æ·»åŠ çš„é˜Ÿåˆ—ä¸Šã€‚è¿™æ ·ï¼Œåªæœ‰é€‰æ‹©å™¨çº¿ç¨‹ä¿®æ”¹å‘é€‰æ‹©å™¨æ³¨å†Œçš„é”®ã€‚</span>
</span><span id=__span-7-19><a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a><span class=cm>     */</span>
</span><span id=__span-7-20><a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>addAcceptedConnection</span><span class=p>(</span><span class=n>SocketChannel</span><span class=w> </span><span class=n>accepted</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-21><a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stopped</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>acceptedQueue</span><span class=p>.</span><span class=na>offer</span><span class=p>(</span><span class=n>accepted</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-22><a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-7-23><a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-7-24><a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a><span class=w>        </span><span class=c1>//å”¤é†’selector è°ƒç”¨çš„çˆ¶ç±»å‹AbstractSelectThreadä¸­çš„wakeupSelectoræ–¹æ³•</span>
</span><span id=__span-7-25><a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a><span class=w>        </span><span class=n>wakeupSelector</span><span class=p>();</span>
</span><span id=__span-7-26><a id=__codelineno-7-26 name=__codelineno-7-26 href=#__codelineno-7-26></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-7-27><a id=__codelineno-7-27 name=__codelineno-7-27 href=#__codelineno-7-27></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-28><a id=__codelineno-7-28 name=__codelineno-7-28 href=#__codelineno-7-28></a>
</span><span id=__span-7-29><a id=__codelineno-7-29 name=__codelineno-7-29 href=#__codelineno-7-29></a><span class=w>    </span><span class=cm>/**</span>
</span><span id=__span-7-30><a id=__codelineno-7-30 name=__codelineno-7-30 href=#__codelineno-7-30></a><span class=cm>     * Place interest op update requests onto a queue so that only the</span>
</span><span id=__span-7-31><a id=__codelineno-7-31 name=__codelineno-7-31 href=#__codelineno-7-31></a><span class=cm>     * selector thread modifies interest ops, because interest ops</span>
</span><span id=__span-7-32><a id=__codelineno-7-32 name=__codelineno-7-32 href=#__codelineno-7-32></a><span class=cm>     * reads/sets are potentially blocking operations if other select</span>
</span><span id=__span-7-33><a id=__codelineno-7-33 name=__codelineno-7-33 href=#__codelineno-7-33></a><span class=cm>     * operations are happening.</span>
</span><span id=__span-7-34><a id=__codelineno-7-34 name=__codelineno-7-34 href=#__codelineno-7-34></a><span class=cm>     */</span>
</span><span id=__span-7-35><a id=__codelineno-7-35 name=__codelineno-7-35 href=#__codelineno-7-35></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>addInterestOpsUpdateRequest</span><span class=p>(</span><span class=n>SelectionKey</span><span class=w> </span><span class=n>sk</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-36><a id=__codelineno-7-36 name=__codelineno-7-36 href=#__codelineno-7-36></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stopped</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>updateQueue</span><span class=p>.</span><span class=na>offer</span><span class=p>(</span><span class=n>sk</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-37><a id=__codelineno-7-37 name=__codelineno-7-37 href=#__codelineno-7-37></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-7-38><a id=__codelineno-7-38 name=__codelineno-7-38 href=#__codelineno-7-38></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-7-39><a id=__codelineno-7-39 name=__codelineno-7-39 href=#__codelineno-7-39></a><span class=w>        </span><span class=n>wakeupSelector</span><span class=p>();</span>
</span><span id=__span-7-40><a id=__codelineno-7-40 name=__codelineno-7-40 href=#__codelineno-7-40></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-7-41><a id=__codelineno-7-41 name=__codelineno-7-41 href=#__codelineno-7-41></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-42><a id=__codelineno-7-42 name=__codelineno-7-42 href=#__codelineno-7-42></a>
</span><span id=__span-7-43><a id=__codelineno-7-43 name=__codelineno-7-43 href=#__codelineno-7-43></a><span class=w>    </span><span class=cm>/**</span>
</span><span id=__span-7-44><a id=__codelineno-7-44 name=__codelineno-7-44 href=#__codelineno-7-44></a><span class=cm>     * The main loop for the thread selects() on the connections and</span>
</span><span id=__span-7-45><a id=__codelineno-7-45 name=__codelineno-7-45 href=#__codelineno-7-45></a><span class=cm>     * dispatches ready I/O work requests, then registers all pending</span>
</span><span id=__span-7-46><a id=__codelineno-7-46 name=__codelineno-7-46 href=#__codelineno-7-46></a><span class=cm>     * newly accepted connections and updates any interest ops on the</span>
</span><span id=__span-7-47><a id=__codelineno-7-47 name=__codelineno-7-47 href=#__codelineno-7-47></a><span class=cm>     * queue.</span>
</span><span id=__span-7-48><a id=__codelineno-7-48 name=__codelineno-7-48 href=#__codelineno-7-48></a><span class=cm>     çº¿ç¨‹çš„ä¸»å¾ªç¯åœ¨è¿æ¥ä¸Šé€‰æ‹©()å¹¶åˆ†æ´¾å‡†å¤‡å¥½çš„I/Oå·¥ä½œè¯·æ±‚ï¼Œç„¶åæ³¨å†Œæ‰€æœ‰ç­‰å¾…çš„æ–°æ¥å—çš„è¿æ¥å¹¶æ›´æ–°é˜Ÿåˆ—ä¸Šçš„ä»»ä½•æ„Ÿå…´è¶£çš„æ“ä½œã€‚</span>
</span><span id=__span-7-49><a id=__codelineno-7-49 name=__codelineno-7-49 href=#__codelineno-7-49></a><span class=cm>     */</span>
</span><span id=__span-7-50><a id=__codelineno-7-50 name=__codelineno-7-50 href=#__codelineno-7-50></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-51><a id=__codelineno-7-51 name=__codelineno-7-51 href=#__codelineno-7-51></a><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-52><a id=__codelineno-7-52 name=__codelineno-7-52 href=#__codelineno-7-52></a><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stopped</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-53><a id=__codelineno-7-53 name=__codelineno-7-53 href=#__codelineno-7-53></a><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-54><a id=__codelineno-7-54 name=__codelineno-7-54 href=#__codelineno-7-54></a>
</span><span id=__span-7-55><a id=__codelineno-7-55 name=__codelineno-7-55 href=#__codelineno-7-55></a><span class=w>                    </span><span class=n>select</span><span class=p>();</span>
</span><span id=__span-7-56><a id=__codelineno-7-56 name=__codelineno-7-56 href=#__codelineno-7-56></a><span class=w>                    </span><span class=n>processAcceptedConnections</span><span class=p>();</span>
</span><span id=__span-7-57><a id=__codelineno-7-57 name=__codelineno-7-57 href=#__codelineno-7-57></a><span class=w>                    </span><span class=n>processInterestOpsUpdateRequests</span><span class=p>();</span>
</span><span id=__span-7-58><a id=__codelineno-7-58 name=__codelineno-7-58 href=#__codelineno-7-58></a><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-59><a id=__codelineno-7-59 name=__codelineno-7-59 href=#__codelineno-7-59></a><span class=w>                    </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Ignoring unexpected runtime exception&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-7-60><a id=__codelineno-7-60 name=__codelineno-7-60 href=#__codelineno-7-60></a><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-61><a id=__codelineno-7-61 name=__codelineno-7-61 href=#__codelineno-7-61></a><span class=w>                    </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Ignoring unexpected exception&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-7-62><a id=__codelineno-7-62 name=__codelineno-7-62 href=#__codelineno-7-62></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-7-63><a id=__codelineno-7-63 name=__codelineno-7-63 href=#__codelineno-7-63></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-7-64><a id=__codelineno-7-64 name=__codelineno-7-64 href=#__codelineno-7-64></a>
</span><span id=__span-7-65><a id=__codelineno-7-65 name=__codelineno-7-65 href=#__codelineno-7-65></a><span class=w>            </span><span class=c1>// Close connections still pending on the selector. Any others</span>
</span><span id=__span-7-66><a id=__codelineno-7-66 name=__codelineno-7-66 href=#__codelineno-7-66></a><span class=w>            </span><span class=c1>// with in-flight work, let drain out of the work queue.</span>
</span><span id=__span-7-67><a id=__codelineno-7-67 name=__codelineno-7-67 href=#__codelineno-7-67></a><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>SelectionKey</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>selector</span><span class=p>.</span><span class=na>keys</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-68><a id=__codelineno-7-68 name=__codelineno-7-68 href=#__codelineno-7-68></a><span class=w>                </span><span class=n>NIOServerCnxn</span><span class=w> </span><span class=n>cnxn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>NIOServerCnxn</span><span class=p>)</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>attachment</span><span class=p>();</span>
</span><span id=__span-7-69><a id=__codelineno-7-69 name=__codelineno-7-69 href=#__codelineno-7-69></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cnxn</span><span class=p>.</span><span class=na>isSelectable</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-70><a id=__codelineno-7-70 name=__codelineno-7-70 href=#__codelineno-7-70></a><span class=w>                    </span><span class=n>cnxn</span><span class=p>.</span><span class=na>close</span><span class=p>(</span><span class=n>ServerCnxn</span><span class=p>.</span><span class=na>DisconnectReason</span><span class=p>.</span><span class=na>SERVER_SHUTDOWN</span><span class=p>);</span>
</span><span id=__span-7-71><a id=__codelineno-7-71 name=__codelineno-7-71 href=#__codelineno-7-71></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-7-72><a id=__codelineno-7-72 name=__codelineno-7-72 href=#__codelineno-7-72></a><span class=w>                </span><span class=n>cleanupSelectionKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-7-73><a id=__codelineno-7-73 name=__codelineno-7-73 href=#__codelineno-7-73></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-7-74><a id=__codelineno-7-74 name=__codelineno-7-74 href=#__codelineno-7-74></a><span class=w>            </span><span class=n>SocketChannel</span><span class=w> </span><span class=n>accepted</span><span class=p>;</span>
</span><span id=__span-7-75><a id=__codelineno-7-75 name=__codelineno-7-75 href=#__codelineno-7-75></a><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>accepted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>acceptedQueue</span><span class=p>.</span><span class=na>poll</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-76><a id=__codelineno-7-76 name=__codelineno-7-76 href=#__codelineno-7-76></a><span class=w>                </span><span class=n>fastCloseSock</span><span class=p>(</span><span class=n>accepted</span><span class=p>);</span>
</span><span id=__span-7-77><a id=__codelineno-7-77 name=__codelineno-7-77 href=#__codelineno-7-77></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-7-78><a id=__codelineno-7-78 name=__codelineno-7-78 href=#__codelineno-7-78></a><span class=w>            </span><span class=n>updateQueue</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
</span><span id=__span-7-79><a id=__codelineno-7-79 name=__codelineno-7-79 href=#__codelineno-7-79></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-80><a id=__codelineno-7-80 name=__codelineno-7-80 href=#__codelineno-7-80></a><span class=w>            </span><span class=n>closeSelector</span><span class=p>();</span>
</span><span id=__span-7-81><a id=__codelineno-7-81 name=__codelineno-7-81 href=#__codelineno-7-81></a><span class=w>            </span><span class=c1>// This will wake up the accept thread and the other selector</span>
</span><span id=__span-7-82><a id=__codelineno-7-82 name=__codelineno-7-82 href=#__codelineno-7-82></a><span class=w>            </span><span class=c1>// threads, and tell the worker thread pool to begin shutdown.</span>
</span><span id=__span-7-83><a id=__codelineno-7-83 name=__codelineno-7-83 href=#__codelineno-7-83></a><span class=w>            </span><span class=n>NIOServerCnxnFactory</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>stop</span><span class=p>();</span>
</span><span id=__span-7-84><a id=__codelineno-7-84 name=__codelineno-7-84 href=#__codelineno-7-84></a><span class=w>            </span><span class=n>LOG</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&quot;selector thread exitted run method&quot;</span><span class=p>);</span>
</span><span id=__span-7-85><a id=__codelineno-7-85 name=__codelineno-7-85 href=#__codelineno-7-85></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-7-86><a id=__codelineno-7-86 name=__codelineno-7-86 href=#__codelineno-7-86></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-87><a id=__codelineno-7-87 name=__codelineno-7-87 href=#__codelineno-7-87></a>
</span><span id=__span-7-88><a id=__codelineno-7-88 name=__codelineno-7-88 href=#__codelineno-7-88></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>select</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-89><a id=__codelineno-7-89 name=__codelineno-7-89 href=#__codelineno-7-89></a><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-90><a id=__codelineno-7-90 name=__codelineno-7-90 href=#__codelineno-7-90></a><span class=c1>//é€‰æ‹©ä¸€ç»„é”®ï¼Œå…¶å¯¹åº”çš„é€šé“å·²å‡†å¤‡å¥½è¿›è¡ŒI/Oæ“ä½œã€‚</span>
</span><span id=__span-7-91><a id=__codelineno-7-91 name=__codelineno-7-91 href=#__codelineno-7-91></a><span class=w>            </span><span class=n>selector</span><span class=p>.</span><span class=na>select</span><span class=p>();</span>
</span><span id=__span-7-92><a id=__codelineno-7-92 name=__codelineno-7-92 href=#__codelineno-7-92></a><span class=c1>//è¿”å›é€‰æ‹©å™¨çš„é€‰å®šé”®é›†ã€‚</span>
</span><span id=__span-7-93><a id=__codelineno-7-93 name=__codelineno-7-93 href=#__codelineno-7-93></a><span class=w>            </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span><span class=w> </span><span class=n>selected</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selector</span><span class=p>.</span><span class=na>selectedKeys</span><span class=p>();</span>
</span><span id=__span-7-94><a id=__codelineno-7-94 name=__codelineno-7-94 href=#__codelineno-7-94></a><span class=w>            </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span><span class=w> </span><span class=n>selectedList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span><span class=p>(</span><span class=n>selected</span><span class=p>);</span>
</span><span id=__span-7-95><a id=__codelineno-7-95 name=__codelineno-7-95 href=#__codelineno-7-95></a><span class=w>            </span><span class=n>Collections</span><span class=p>.</span><span class=na>shuffle</span><span class=p>(</span><span class=n>selectedList</span><span class=p>);</span>
</span><span id=__span-7-96><a id=__codelineno-7-96 name=__codelineno-7-96 href=#__codelineno-7-96></a><span class=w>            </span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span><span class=w> </span><span class=n>selectedKeys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selectedList</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span>
</span><span id=__span-7-97><a id=__codelineno-7-97 name=__codelineno-7-97 href=#__codelineno-7-97></a><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stopped</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>selectedKeys</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-98><a id=__codelineno-7-98 name=__codelineno-7-98 href=#__codelineno-7-98></a><span class=w>                </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selectedKeys</span><span class=p>.</span><span class=na>next</span><span class=p>();</span>
</span><span id=__span-7-99><a id=__codelineno-7-99 name=__codelineno-7-99 href=#__codelineno-7-99></a><span class=w>                </span><span class=n>selected</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-7-100><a id=__codelineno-7-100 name=__codelineno-7-100 href=#__codelineno-7-100></a>
</span><span id=__span-7-101><a id=__codelineno-7-101 name=__codelineno-7-101 href=#__codelineno-7-101></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>key</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-102><a id=__codelineno-7-102 name=__codelineno-7-102 href=#__codelineno-7-102></a><span class=w>                    </span><span class=n>cleanupSelectionKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-7-103><a id=__codelineno-7-103 name=__codelineno-7-103 href=#__codelineno-7-103></a><span class=w>                    </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-7-104><a id=__codelineno-7-104 name=__codelineno-7-104 href=#__codelineno-7-104></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-7-105><a id=__codelineno-7-105 name=__codelineno-7-105 href=#__codelineno-7-105></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>isReadable</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>isWritable</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-106><a id=__codelineno-7-106 name=__codelineno-7-106 href=#__codelineno-7-106></a><span class=c1>//å®‰æ’I/Oå¤„ç†ä¸ç»™å®šçš„SelectionKeyå…³è”çš„è¿æ¥ã€‚å¦‚æœä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ± æ²¡æœ‰è¢«ä½¿ç”¨ï¼ŒI/Oå°†ç›´æ¥ç”±è¿™ä¸ªçº¿ç¨‹è¿è¡Œã€‚</span>
</span><span id=__span-7-107><a id=__codelineno-7-107 name=__codelineno-7-107 href=#__codelineno-7-107></a><span class=w>                    </span><span class=n>handleIO</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-7-108><a id=__codelineno-7-108 name=__codelineno-7-108 href=#__codelineno-7-108></a><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-109><a id=__codelineno-7-109 name=__codelineno-7-109 href=#__codelineno-7-109></a><span class=w>                    </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Unexpected ops in select {}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>readyOps</span><span class=p>());</span>
</span><span id=__span-7-110><a id=__codelineno-7-110 name=__codelineno-7-110 href=#__codelineno-7-110></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-7-111><a id=__codelineno-7-111 name=__codelineno-7-111 href=#__codelineno-7-111></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-7-112><a id=__codelineno-7-112 name=__codelineno-7-112 href=#__codelineno-7-112></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-113><a id=__codelineno-7-113 name=__codelineno-7-113 href=#__codelineno-7-113></a><span class=w>            </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Ignoring IOException while selecting&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-7-114><a id=__codelineno-7-114 name=__codelineno-7-114 href=#__codelineno-7-114></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-7-115><a id=__codelineno-7-115 name=__codelineno-7-115 href=#__codelineno-7-115></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-116><a id=__codelineno-7-116 name=__codelineno-7-116 href=#__codelineno-7-116></a>
</span><span id=__span-7-117><a id=__codelineno-7-117 name=__codelineno-7-117 href=#__codelineno-7-117></a><span class=w>    </span><span class=cm>/**</span>
</span><span id=__span-7-118><a id=__codelineno-7-118 name=__codelineno-7-118 href=#__codelineno-7-118></a><span class=cm>     * Schedule I/O for processing on the connection associated with</span>
</span><span id=__span-7-119><a id=__codelineno-7-119 name=__codelineno-7-119 href=#__codelineno-7-119></a><span class=cm>     * the given SelectionKey. If a worker thread pool is not being used,</span>
</span><span id=__span-7-120><a id=__codelineno-7-120 name=__codelineno-7-120 href=#__codelineno-7-120></a><span class=cm>     * I/O is run directly by this thread.</span>
</span><span id=__span-7-121><a id=__codelineno-7-121 name=__codelineno-7-121 href=#__codelineno-7-121></a><span class=cm>     å®‰æ’I/Oå¤„ç†ä¸ç»™å®šçš„SelectionKeyå…³è”çš„è¿æ¥ã€‚å¦‚æœä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ± æ²¡æœ‰è¢«ä½¿ç”¨ï¼ŒI/Oå°†ç›´æ¥ç”±è¿™ä¸ªçº¿ç¨‹è¿è¡Œã€‚</span>
</span><span id=__span-7-122><a id=__codelineno-7-122 name=__codelineno-7-122 href=#__codelineno-7-122></a><span class=cm>     */</span>
</span><span id=__span-7-123><a id=__codelineno-7-123 name=__codelineno-7-123 href=#__codelineno-7-123></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleIO</span><span class=p>(</span><span class=n>SelectionKey</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-124><a id=__codelineno-7-124 name=__codelineno-7-124 href=#__codelineno-7-124></a><span class=w>        </span><span class=n>IOWorkRequest</span><span class=w> </span><span class=n>workRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IOWorkRequest</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-7-125><a id=__codelineno-7-125 name=__codelineno-7-125 href=#__codelineno-7-125></a><span class=w>        </span><span class=n>NIOServerCnxn</span><span class=w> </span><span class=n>cnxn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>NIOServerCnxn</span><span class=p>)</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>attachment</span><span class=p>();</span>
</span><span id=__span-7-126><a id=__codelineno-7-126 name=__codelineno-7-126 href=#__codelineno-7-126></a>
</span><span id=__span-7-127><a id=__codelineno-7-127 name=__codelineno-7-127 href=#__codelineno-7-127></a><span class=w>        </span><span class=c1>// Stop selecting this key while processing on its</span>
</span><span id=__span-7-128><a id=__codelineno-7-128 name=__codelineno-7-128 href=#__codelineno-7-128></a><span class=w>        </span><span class=c1>// connectionåœ¨å¤„ç†å…¶è¿æ¥æ—¶åœæ­¢é€‰æ‹©æ­¤é”®</span>
</span><span id=__span-7-129><a id=__codelineno-7-129 name=__codelineno-7-129 href=#__codelineno-7-129></a><span class=w>        </span><span class=n>cnxn</span><span class=p>.</span><span class=na>disableSelectable</span><span class=p>();</span>
</span><span id=__span-7-130><a id=__codelineno-7-130 name=__codelineno-7-130 href=#__codelineno-7-130></a><span class=c1>//æ¸…é™¤å…´è¶£ç»„</span>
</span><span id=__span-7-131><a id=__codelineno-7-131 name=__codelineno-7-131 href=#__codelineno-7-131></a><span class=w>        </span><span class=n>key</span><span class=p>.</span><span class=na>interestOps</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-7-132><a id=__codelineno-7-132 name=__codelineno-7-132 href=#__codelineno-7-132></a><span class=c1>//åˆ·æ–°è¿æ¥çš„Sessionè¶…æ—¶æ—¶é—´</span>
</span><span id=__span-7-133><a id=__codelineno-7-133 name=__codelineno-7-133 href=#__codelineno-7-133></a><span class=w>        </span><span class=n>touchCnxn</span><span class=p>(</span><span class=n>cnxn</span><span class=p>);</span>
</span><span id=__span-7-134><a id=__codelineno-7-134 name=__codelineno-7-134 href=#__codelineno-7-134></a><span class=c1>//æ‰§è¡ŒIOçº¿ç¨‹æ¥è§¦å‘IOè¯»å†™å·¥ä½œ</span>
</span><span id=__span-7-135><a id=__codelineno-7-135 name=__codelineno-7-135 href=#__codelineno-7-135></a><span class=w>        </span><span class=n>workerPool</span><span class=p>.</span><span class=na>schedule</span><span class=p>(</span><span class=n>workRequest</span><span class=p>);</span>
</span><span id=__span-7-136><a id=__codelineno-7-136 name=__codelineno-7-136 href=#__codelineno-7-136></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-137><a id=__codelineno-7-137 name=__codelineno-7-137 href=#__codelineno-7-137></a>
</span><span id=__span-7-138><a id=__codelineno-7-138 name=__codelineno-7-138 href=#__codelineno-7-138></a><span class=w>    </span><span class=cm>/**</span>
</span><span id=__span-7-139><a id=__codelineno-7-139 name=__codelineno-7-139 href=#__codelineno-7-139></a><span class=cm>     * Iterate over the queue of accepted connections that have been</span>
</span><span id=__span-7-140><a id=__codelineno-7-140 name=__codelineno-7-140 href=#__codelineno-7-140></a><span class=cm>     * assigned to this thread but not yet placed on the selector.</span>
</span><span id=__span-7-141><a id=__codelineno-7-141 name=__codelineno-7-141 href=#__codelineno-7-141></a><span class=cm>     */</span>
</span><span id=__span-7-142><a id=__codelineno-7-142 name=__codelineno-7-142 href=#__codelineno-7-142></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processAcceptedConnections</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-143><a id=__codelineno-7-143 name=__codelineno-7-143 href=#__codelineno-7-143></a><span class=w>        </span><span class=n>SocketChannel</span><span class=w> </span><span class=n>accepted</span><span class=p>;</span>
</span><span id=__span-7-144><a id=__codelineno-7-144 name=__codelineno-7-144 href=#__codelineno-7-144></a><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stopped</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>accepted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>acceptedQueue</span><span class=p>.</span><span class=na>poll</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-145><a id=__codelineno-7-145 name=__codelineno-7-145 href=#__codelineno-7-145></a><span class=w>            </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-7-146><a id=__codelineno-7-146 name=__codelineno-7-146 href=#__codelineno-7-146></a><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-147><a id=__codelineno-7-147 name=__codelineno-7-147 href=#__codelineno-7-147></a><span class=w>                </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accepted</span><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>selector</span><span class=p>,</span><span class=w> </span><span class=n>SelectionKey</span><span class=p>.</span><span class=na>OP_READ</span><span class=p>);</span>
</span><span id=__span-7-148><a id=__codelineno-7-148 name=__codelineno-7-148 href=#__codelineno-7-148></a><span class=w>                </span><span class=n>NIOServerCnxn</span><span class=w> </span><span class=n>cnxn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createConnection</span><span class=p>(</span><span class=n>accepted</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span>
</span><span id=__span-7-149><a id=__codelineno-7-149 name=__codelineno-7-149 href=#__codelineno-7-149></a><span class=w>                </span><span class=n>key</span><span class=p>.</span><span class=na>attach</span><span class=p>(</span><span class=n>cnxn</span><span class=p>);</span>
</span><span id=__span-7-150><a id=__codelineno-7-150 name=__codelineno-7-150 href=#__codelineno-7-150></a><span class=w>                </span><span class=n>addCnxn</span><span class=p>(</span><span class=n>cnxn</span><span class=p>);</span>
</span><span id=__span-7-151><a id=__codelineno-7-151 name=__codelineno-7-151 href=#__codelineno-7-151></a><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-152><a id=__codelineno-7-152 name=__codelineno-7-152 href=#__codelineno-7-152></a><span class=w>                </span><span class=c1>// register, createConnection</span>
</span><span id=__span-7-153><a id=__codelineno-7-153 name=__codelineno-7-153 href=#__codelineno-7-153></a><span class=w>                </span><span class=n>cleanupSelectionKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-7-154><a id=__codelineno-7-154 name=__codelineno-7-154 href=#__codelineno-7-154></a><span class=w>                </span><span class=n>fastCloseSock</span><span class=p>(</span><span class=n>accepted</span><span class=p>);</span>
</span><span id=__span-7-155><a id=__codelineno-7-155 name=__codelineno-7-155 href=#__codelineno-7-155></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-7-156><a id=__codelineno-7-156 name=__codelineno-7-156 href=#__codelineno-7-156></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-7-157><a id=__codelineno-7-157 name=__codelineno-7-157 href=#__codelineno-7-157></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-158><a id=__codelineno-7-158 name=__codelineno-7-158 href=#__codelineno-7-158></a>
</span><span id=__span-7-159><a id=__codelineno-7-159 name=__codelineno-7-159 href=#__codelineno-7-159></a><span class=w>    </span><span class=cm>/**</span>
</span><span id=__span-7-160><a id=__codelineno-7-160 name=__codelineno-7-160 href=#__codelineno-7-160></a><span class=cm>     * Iterate over the queue of connections ready to resume selection,</span>
</span><span id=__span-7-161><a id=__codelineno-7-161 name=__codelineno-7-161 href=#__codelineno-7-161></a><span class=cm>     * and restore their interest ops selection mask.</span>
</span><span id=__span-7-162><a id=__codelineno-7-162 name=__codelineno-7-162 href=#__codelineno-7-162></a><span class=cm>     */</span>
</span><span id=__span-7-163><a id=__codelineno-7-163 name=__codelineno-7-163 href=#__codelineno-7-163></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processInterestOpsUpdateRequests</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-164><a id=__codelineno-7-164 name=__codelineno-7-164 href=#__codelineno-7-164></a><span class=w>        </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>key</span><span class=p>;</span>
</span><span id=__span-7-165><a id=__codelineno-7-165 name=__codelineno-7-165 href=#__codelineno-7-165></a><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stopped</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>updateQueue</span><span class=p>.</span><span class=na>poll</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-166><a id=__codelineno-7-166 name=__codelineno-7-166 href=#__codelineno-7-166></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>key</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-167><a id=__codelineno-7-167 name=__codelineno-7-167 href=#__codelineno-7-167></a><span class=w>                </span><span class=n>cleanupSelectionKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-7-168><a id=__codelineno-7-168 name=__codelineno-7-168 href=#__codelineno-7-168></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-7-169><a id=__codelineno-7-169 name=__codelineno-7-169 href=#__codelineno-7-169></a><span class=w>            </span><span class=n>NIOServerCnxn</span><span class=w> </span><span class=n>cnxn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>NIOServerCnxn</span><span class=p>)</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>attachment</span><span class=p>();</span>
</span><span id=__span-7-170><a id=__codelineno-7-170 name=__codelineno-7-170 href=#__codelineno-7-170></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cnxn</span><span class=p>.</span><span class=na>isSelectable</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-171><a id=__codelineno-7-171 name=__codelineno-7-171 href=#__codelineno-7-171></a><span class=w>                </span><span class=n>key</span><span class=p>.</span><span class=na>interestOps</span><span class=p>(</span><span class=n>cnxn</span><span class=p>.</span><span class=na>getInterestOps</span><span class=p>());</span>
</span><span id=__span-7-172><a id=__codelineno-7-172 name=__codelineno-7-172 href=#__codelineno-7-172></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-7-173><a id=__codelineno-7-173 name=__codelineno-7-173 href=#__codelineno-7-173></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-7-174><a id=__codelineno-7-174 name=__codelineno-7-174 href=#__codelineno-7-174></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-175><a id=__codelineno-7-175 name=__codelineno-7-175 href=#__codelineno-7-175></a>
</span><span id=__span-7-176><a id=__codelineno-7-176 name=__codelineno-7-176 href=#__codelineno-7-176></a><span class=p>}</span>
</span></code></pre></div> <p>é’ˆå¯¹SelectorThreadæˆ‘ä»¬ä¸€å…±çœ‹3ä¸ªæ“ä½œ,è¿™3ä¸ªæ“ä½œé€šè¿‡whileæ¥åšæ— é™å¾ªç¯ï¼Œå½“ <strong>stopå˜é‡è®¾ç½®ä¸ºtrueæ—¶å€™ç»ˆæ­¢å¾ªç¯</strong> ï¼Œ åœ¨whileæ— é™å¾ªç¯ä¸­, çº¿ç¨‹çš„ä¸»å¾ªç¯åœ¨è¿æ¥ä¸Šé€‰æ‹©()å¹¶åˆ†æ´¾å‡†å¤‡å¥½çš„I/Oå·¥ä½œè¯·æ±‚ï¼Œç„¶åæ³¨å†Œæ‰€æœ‰ç­‰å¾…çš„æ–°æ¥å—çš„è¿æ¥å¹¶æ›´æ–°é˜Ÿåˆ—ä¸Šçš„ä»»ä½•æ„Ÿå…´è¶£çš„æ“ä½œã€‚</p> <ul> <li><strong>select();</strong> åœ¨è¿æ¥ä¸Šé€‰æ‹©()å¹¶åˆ†æ´¾å‡†å¤‡å¥½çš„I/Oå·¥ä½œè¯·æ±‚</li> <li><strong>processAcceptedConnections();</strong> å¤„ç†acceptçº¿ç¨‹æ–°åˆ†æ´¾çš„è¿æ¥, // (1)å°†æ–°è¿æ¥æ³¨å†Œåˆ°selectorä¸Š;(2) åŒ…è£…ä¸ºNIOServerCnxnåæ³¨å†Œåˆ°NIOServerCnxnFactoryä¸­</li> <li><strong>processInterestOpsUpdateRequests();</strong> æ›´æ–°updateQueueä¸­è¿æ¥çš„ç›‘å¬äº‹ä»¶</li> </ul> <h3 id=processacceptedconnections><strong>å¤„ç†è¢«æ¥å—çš„è¿æ¥è¯·æ±‚processAcceptedConnections</strong><a class=headerlink href=#processacceptedconnections title="Permanent link">&para;</a></h3> <p>æ¥ä¸‹æ¥è¯¦ç»†çœ‹ä¸‹processAcceptedConnectionså¦‚ä½•å¤„ç†å¯ä»¥æ¥æ”¶çš„è¿æ¥çš„ï¼š</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processAcceptedConnections</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=w>    </span><span class=n>SocketChannel</span><span class=w> </span><span class=n>accepted</span><span class=p>;</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stopped</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>accepted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>acceptedQueue</span><span class=p>.</span><span class=na>poll</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=w>        </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=c1>//ä¸ºSocketChannelæ³¨å†ŒOP_READäº‹ä»¶ç”¨æ¥æ¥æ”¶è¯»è¯·æ±‚</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=w>            </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accepted</span><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>selector</span><span class=p>,</span><span class=w> </span><span class=n>SelectionKey</span><span class=p>.</span><span class=na>OP_READ</span><span class=p>);</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=w>            </span><span class=n>NIOServerCnxn</span><span class=w> </span><span class=n>cnxn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createConnection</span><span class=p>(</span><span class=n>accepted</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=c1>//å°†ç»™å®šå¯¹è±¡é™„åŠ åˆ°æ­¤é”®ä¸Šã€‚åœ¨å¤„ç†è¿æ¥ï¼Œè¯»å–IOæ•°æ®çš„æ—¶å€™éƒ½ä¼šä½¿ç”¨åˆ°æ­¤å¯¹è±¡æ¥æ“ä½œ</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a><span class=w>            </span><span class=n>key</span><span class=p>.</span><span class=na>attach</span><span class=p>(</span><span class=n>cnxn</span><span class=p>);</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=c1>//å°†åŒä¸€IPå®¢æˆ·ç«¯çš„è¿æ¥ç¼“å­˜è‡³NIOServerCnxnFactoryç±»å‹ä¸­çš„ipMapå¯¹è±¡ä¸­ç”¨äºé™åˆ¶åŒä¸€å®¢æˆ·ç«¯çš„è¿æ¥æ•°é‡ï¼Œå¦‚æœåŒä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥æ•°é‡è¿‡å¤šåˆ™æŠ›å‡ºToo many connectionsé”™è¯¯ï¼Œæ‹’ç»acceptè¿æ¥</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=w>            </span><span class=n>addCnxn</span><span class=p>(</span><span class=n>cnxn</span><span class=p>);</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=w>            </span><span class=c1>// register, createConnection</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a><span class=w>            </span><span class=n>cleanupSelectionKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a><span class=w>            </span><span class=n>fastCloseSock</span><span class=p>(</span><span class=n>accepted</span><span class=p>);</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a><span class=p>}</span>
</span></code></pre></div> <h3 id=createconnection><strong>createConnection</strong><a class=headerlink href=#createconnection title="Permanent link">&para;</a></h3> <p>ä¸ºSocketChannelæ³¨å†ŒOP_READäº‹ä»¶ç”¨æ¥æ¥æ”¶è¯»è¯·æ±‚ä¹‹åå¼€å§‹åˆ›å»ºè¿æ¥å¯¹è±¡å¦‚ä¸‹ï¼š åˆ›å»ºè¿æ¥å¦‚ä¸‹ï¼š</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=kd>protected</span><span class=w> </span><span class=n>NIOServerCnxn</span><span class=w> </span><span class=nf>createConnection</span><span class=p>(</span><span class=n>SocketChannel</span><span class=w> </span><span class=n>sock</span><span class=p>,</span><span class=w> </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>sk</span><span class=p>,</span><span class=w> </span><span class=n>SelectorThread</span><span class=w> </span><span class=n>selectorThread</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NIOServerCnxn</span><span class=p>(</span><span class=n>zkServer</span><span class=p>,</span><span class=w> </span><span class=n>sock</span><span class=p>,</span><span class=w> </span><span class=n>sk</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>selectorThread</span><span class=p>);</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=p>}</span>
</span></code></pre></div> <h4 id=nioservercnxn><strong>çœ‹ä¸‹NIOServerCnxnçš„æ„é€ å™¨</strong><a class=headerlink href=#nioservercnxn title="Permanent link">&para;</a></h4> <div class="language-java highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=kd>public</span><span class=w> </span><span class=nf>NIOServerCnxn</span><span class=p>(</span><span class=n>ZooKeeperServer</span><span class=w> </span><span class=n>zk</span><span class=p>,</span><span class=w> </span><span class=n>SocketChannel</span><span class=w> </span><span class=n>sock</span><span class=p>,</span><span class=w> </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>sk</span><span class=p>,</span><span class=w> </span><span class=n>NIOServerCnxnFactory</span><span class=w> </span><span class=n>factory</span><span class=p>,</span><span class=w> </span><span class=n>SelectorThread</span><span class=w> </span><span class=n>selectorThread</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=w>    </span><span class=kd>super</span><span class=p>(</span><span class=n>zk</span><span class=p>);</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>sock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sock</span><span class=p>;</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>sk</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sk</span><span class=p>;</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>factory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>factory</span><span class=p>;</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>selectorThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selectorThread</span><span class=p>;</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>factory</span><span class=p>.</span><span class=na>login</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>zooKeeperSaslServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ZooKeeperSaslServer</span><span class=p>(</span><span class=n>factory</span><span class=p>.</span><span class=na>login</span><span class=p>);</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=c1>//å…³é—­Nagleç®—æ³•ç®—æ³•ï¼Œä¸éœ€è¦ç¼“å­˜å»¶è¿Ÿå‘é€</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a><span class=w>    </span><span class=n>sock</span><span class=p>.</span><span class=na>socket</span><span class=p>().</span><span class=na>setTcpNoDelay</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=w>    </span><span class=o>/*</span><span class=w> </span><span class=n>set</span><span class=w> </span><span class=n>socket</span><span class=w> </span><span class=n>ling</span><span class=w> </span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=n>SO_LINGERè¿˜æœ‰ä¸€ä¸ªä½œç”¨å°±æ˜¯ç”¨æ¥å‡å°‘TIME_WAITå¥—æ¥å­—çš„æ•°é‡</span><span class=err>ã€‚</span><span class=n>åœ¨è®¾ç½®SO_LINGERé€‰é¡¹æ—¶</span><span class=err>ï¼Œ</span><span class=n>æŒ‡å®šç­‰å¾…æ—¶é—´ä¸º0</span><span class=err>ï¼Œ</span><span class=n>æ­¤æ—¶è°ƒç”¨ä¸»åŠ¨å…³é—­æ—¶ä¸ä¼šå‘é€FINæ¥ç»“æŸè¿æ¥</span><span class=err>ï¼Œ</span><span class=n>è€Œæ˜¯ç›´æ¥å°†è¿æ¥è®¾ç½®ä¸ºCLOSEçŠ¶æ€</span><span class=err>ï¼Œ</span><span class=n>æ¸…é™¤å¥—æ¥å­—ä¸­çš„å‘é€å’Œæ¥æ”¶ç¼“å†²åŒº</span><span class=err>ï¼Œ</span><span class=n>ç›´æ¥å¯¹å¯¹ç«¯å‘é€RSTåŒ…</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a><span class=c1>//ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ˜¯å¦å¼€å¯SoLingerï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå¦‚æœå¼€å¯SoLingeræŒç»­æ—¶é—´</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a><span class=w>    </span><span class=n>sock</span><span class=p>.</span><span class=na>socket</span><span class=p>().</span><span class=na>setSoLinger</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=w>    </span><span class=n>InetAddress</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>InetSocketAddress</span><span class=p>)</span><span class=w> </span><span class=n>sock</span><span class=p>.</span><span class=na>socket</span><span class=p>().</span><span class=na>getRemoteSocketAddress</span><span class=p>()).</span><span class=na>getAddress</span><span class=p>();</span>
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a><span class=c1>//ç¼“å­˜è¿œç¨‹ipåœ°å€</span>
</span><span id=__span-10-19><a id=__codelineno-10-19 name=__codelineno-10-19 href=#__codelineno-10-19></a><span class=w>    </span><span class=n>addAuthInfo</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Id</span><span class=p>(</span><span class=s>&quot;ip&quot;</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>.</span><span class=na>getHostAddress</span><span class=p>()));</span>
</span><span id=__span-10-20><a id=__codelineno-10-20 name=__codelineno-10-20 href=#__codelineno-10-20></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>sessionTimeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>factory</span><span class=p>.</span><span class=na>sessionlessCnxnTimeout</span><span class=p>;</span>
</span><span id=__span-10-21><a id=__codelineno-10-21 name=__codelineno-10-21 href=#__codelineno-10-21></a><span class=p>}</span>
</span></code></pre></div> <h3 id=updatequeueprocessinterestopsupdaterequests><strong>æ›´æ–°updateQueueä¸­è¿æ¥çš„ç›‘å¬äº‹ä»¶processInterestOpsUpdateRequests</strong><a class=headerlink href=#updatequeueprocessinterestopsupdaterequests title="Permanent link">&para;</a></h3> <p>processInterestOpsUpdateRequests()æ–¹æ³•ï¼š å‰é¢æˆ‘ä»¬è¯´è¿‡å¤„ç†IOäº‹ä»¶æ—¶å€™ä¼šåœæ­¢è®¢é˜…äº‹ä»¶ï¼ŒIOå¤„ç†å®Œæ¯•ä¹‹ååˆ™è·å–updateQueueä¸­è¿æ¥çš„ç›‘å¬äº‹ä»¶æ¥è®¢é˜…interestOps</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processInterestOpsUpdateRequests</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=w>    </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>key</span><span class=p>;</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stopped</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>updateQueue</span><span class=p>.</span><span class=na>poll</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>key</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=w>            </span><span class=n>cleanupSelectionKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=w>        </span><span class=n>NIOServerCnxn</span><span class=w> </span><span class=n>cnxn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>NIOServerCnxn</span><span class=p>)</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>attachment</span><span class=p>();</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cnxn</span><span class=p>.</span><span class=na>isSelectable</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=w>            </span><span class=n>key</span><span class=p>.</span><span class=na>interestOps</span><span class=p>(</span><span class=n>cnxn</span><span class=p>.</span><span class=na>getInterestOps</span><span class=p>());</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=p>}</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=p>}</span>
</span></code></pre></div> <h3 id=io><strong>å¤„ç†IOäº‹ä»¶</strong><a class=headerlink href=#io title="Permanent link">&para;</a></h3> <h4 id=ioworkrequest><strong>IOWorkRequest</strong><a class=headerlink href=#ioworkrequest title="Permanent link">&para;</a></h4> <p>IOWorkRequestå¤„ç†IOäº‹ä»¶å‘ç”Ÿæ—¶æœºå½“SocketChannelä¸Šæœ‰æ•°æ®å¯è¯»æ—¶,worker threadè°ƒç”¨NIOServerCnxn.doIO()è¿›è¡Œè¯»æ“ä½œ</p> <p>ç²˜åŒ…æ‹†åŒ…é—®é¢˜ å¤„ç†è¯»äº‹ä»¶æ¯”è¾ƒéº»çƒ¦çš„é—®é¢˜å°±æ˜¯é€šè¿‡TCPå‘é€çš„æŠ¥æ–‡ä¼šå‡ºç°ç²˜åŒ…æ‹†åŒ…é—®é¢˜,Zookeeperä¸ºäº†è§£å†³æ­¤é—®é¢˜,åœ¨è®¾è®¡é€šä¿¡åè®®æ—¶å°†æŠ¥æ–‡åˆ†ä¸º3ä¸ªéƒ¨åˆ†:</p> <ul> <li>è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“çš„é•¿åº¦(4ä¸ªå­—èŠ‚)</li> <li>è¯·æ±‚å¤´</li> <li>è¯·æ±‚ä½“</li> </ul> <p>æ³¨:</p> <ol> <li>è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“ä¹Ÿç»†åˆ†ä¸ºæ›´å°çš„éƒ¨åˆ†,ä½†åœ¨æ­¤ä¸åšæ·±å…¥ç ”ç©¶,åªéœ€çŸ¥é“è¯·æ±‚çš„å‰4ä¸ªå­—èŠ‚æ˜¯è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“çš„é•¿åº¦å³å¯.</li> <li>å°†è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“ç§°ä¹‹ä¸ºpayload åœ¨æŠ¥æ–‡å¤´å¢åŠ äº†4ä¸ªå­—èŠ‚çš„é•¿åº¦å­—æ®µ,è¡¨ç¤ºæ•´ä¸ªæŠ¥æ–‡é™¤é•¿åº¦å­—æ®µä¹‹å¤–çš„é•¿åº¦.æœåŠ¡ç«¯å¯æ ¹æ®è¯¥é•¿åº¦å°†ç²˜åŒ…æ‹†åŒ…çš„æŠ¥æ–‡åˆ†ç¦»æˆ–ç»„åˆä¸ºå®Œæ•´çš„æŠ¥æ–‡.</li> </ol> <h3 id=nioservercnxn_1><strong>NIOServerCnxnè¯»å–æ•°æ®æµç¨‹</strong><a class=headerlink href=#nioservercnxn_1 title="Permanent link">&para;</a></h3> <p>NIOServerCnxnè¯»å–æ•°æ®æµç¨‹å¦‚ä¸‹:</p> <p>NIOServerCnxnä¸­æœ‰ä¸¤ä¸ªå±æ€§,ä¸€ä¸ªæ˜¯lenBuffer,å®¹é‡ä¸º4ä¸ªå­—èŠ‚,ç”¨äºè¯»å–é•¿åº¦ä¿¡æ¯.ä¸€ä¸ªæ˜¯incomingBuffer,å…¶åˆå§‹åŒ–æ—¶å³ä¸ºlenBuffer,ä½†æ˜¯è¯»å–é•¿åº¦ä¿¡æ¯å,å°±ä¸ºincomingBufferåˆ†é…å¯¹åº”çš„ç©ºé—´ç”¨äºè¯»å–payload æ ¹æ®è¯·æ±‚æŠ¥æ–‡çš„é•¿åº¦åˆ†é…incomingBufferçš„å¤§å° å°†è¯»åˆ°çš„å­—èŠ‚å­˜æ”¾åœ¨incomingBufferä¸­,ç›´è‡³è¯»æ»¡( ç”±äºç¬¬2æ­¥ä¸­ä¸ºincomingBufferåˆ†é…çš„é•¿åº¦åˆšå¥½æ˜¯æŠ¥æ–‡çš„é•¿åº¦,æ­¤æ—¶incomingBufferä¸­åˆšå¥½æ—¶ä¸€ä¸ªæŠ¥æ–‡) å¤„ç†æŠ¥æ–‡</p> <h3 id=ioworkrequest_1><strong>IOWorkRequest</strong><a class=headerlink href=#ioworkrequest_1 title="Permanent link">&para;</a></h3> <div class="language-java highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=kd>private</span><span class=w> </span><span class=kd>class</span> <span class=nc>IOWorkRequest</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>WorkerService</span><span class=p>.</span><span class=na>WorkRequest</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>SelectorThread</span><span class=w> </span><span class=n>selectorThread</span><span class=p>;</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>key</span><span class=p>;</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>NIOServerCnxn</span><span class=w> </span><span class=n>cnxn</span><span class=p>;</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=w>    </span><span class=n>IOWorkRequest</span><span class=p>(</span><span class=n>SelectorThread</span><span class=w> </span><span class=n>selectorThread</span><span class=p>,</span><span class=w> </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>selectorThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selectorThread</span><span class=p>;</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>key</span><span class=p>;</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>cnxn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>NIOServerCnxn</span><span class=p>)</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>attachment</span><span class=p>();</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doWork</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>key</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a><span class=w>            </span><span class=n>selectorThread</span><span class=p>.</span><span class=na>cleanupSelectionKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a><span class=w>            </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>isReadable</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>isWritable</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20 href=#__codelineno-12-20></a><span class=c1>//å¯è¯»æˆ–è€…å¯å†™åˆ™è¿›è¡Œ IOæ“ä½œ</span>
</span><span id=__span-12-21><a id=__codelineno-12-21 name=__codelineno-12-21 href=#__codelineno-12-21></a><span class=w>            </span><span class=n>cnxn</span><span class=p>.</span><span class=na>doIO</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-12-22><a id=__codelineno-12-22 name=__codelineno-12-22 href=#__codelineno-12-22></a>
</span><span id=__span-12-23><a id=__codelineno-12-23 name=__codelineno-12-23 href=#__codelineno-12-23></a><span class=w>            </span><span class=c1>// Check if we shutdown or doIO() closed this connection</span>
</span><span id=__span-12-24><a id=__codelineno-12-24 name=__codelineno-12-24 href=#__codelineno-12-24></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stopped</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-25><a id=__codelineno-12-25 name=__codelineno-12-25 href=#__codelineno-12-25></a><span class=w>                </span><span class=n>cnxn</span><span class=p>.</span><span class=na>close</span><span class=p>(</span><span class=n>ServerCnxn</span><span class=p>.</span><span class=na>DisconnectReason</span><span class=p>.</span><span class=na>SERVER_SHUTDOWN</span><span class=p>);</span>
</span><span id=__span-12-26><a id=__codelineno-12-26 name=__codelineno-12-26 href=#__codelineno-12-26></a><span class=w>                </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-12-27><a id=__codelineno-12-27 name=__codelineno-12-27 href=#__codelineno-12-27></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-12-28><a id=__codelineno-12-28 name=__codelineno-12-28 href=#__codelineno-12-28></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>key</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-29><a id=__codelineno-12-29 name=__codelineno-12-29 href=#__codelineno-12-29></a><span class=w>                </span><span class=n>selectorThread</span><span class=p>.</span><span class=na>cleanupSelectionKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-12-30><a id=__codelineno-12-30 name=__codelineno-12-30 href=#__codelineno-12-30></a><span class=w>                </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-12-31><a id=__codelineno-12-31 name=__codelineno-12-31 href=#__codelineno-12-31></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-12-32><a id=__codelineno-12-32 name=__codelineno-12-32 href=#__codelineno-12-32></a><span class=w>            </span><span class=n>touchCnxn</span><span class=p>(</span><span class=n>cnxn</span><span class=p>);</span>
</span><span id=__span-12-33><a id=__codelineno-12-33 name=__codelineno-12-33 href=#__codelineno-12-33></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-12-34><a id=__codelineno-12-34 name=__codelineno-12-34 href=#__codelineno-12-34></a>
</span><span id=__span-12-35><a id=__codelineno-12-35 name=__codelineno-12-35 href=#__codelineno-12-35></a><span class=w>        </span><span class=c1>// Mark this connection as once again ready for selection</span>
</span><span id=__span-12-36><a id=__codelineno-12-36 name=__codelineno-12-36 href=#__codelineno-12-36></a><span class=w>        </span><span class=n>cnxn</span><span class=p>.</span><span class=na>enableSelectable</span><span class=p>();</span>
</span><span id=__span-12-37><a id=__codelineno-12-37 name=__codelineno-12-37 href=#__codelineno-12-37></a><span class=w>        </span><span class=c1>// Push an update request on the queue to resume selecting</span>
</span><span id=__span-12-38><a id=__codelineno-12-38 name=__codelineno-12-38 href=#__codelineno-12-38></a><span class=w>        </span><span class=c1>// on the current set of interest ops, which may have changed</span>
</span><span id=__span-12-39><a id=__codelineno-12-39 name=__codelineno-12-39 href=#__codelineno-12-39></a><span class=w>        </span><span class=c1>// as a result of the I/O operations we just performed.</span>
</span><span id=__span-12-40><a id=__codelineno-12-40 name=__codelineno-12-40 href=#__codelineno-12-40></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>selectorThread</span><span class=p>.</span><span class=na>addInterestOpsUpdateRequest</span><span class=p>(</span><span class=n>key</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-41><a id=__codelineno-12-41 name=__codelineno-12-41 href=#__codelineno-12-41></a><span class=w>            </span><span class=n>cnxn</span><span class=p>.</span><span class=na>close</span><span class=p>(</span><span class=n>ServerCnxn</span><span class=p>.</span><span class=na>DisconnectReason</span><span class=p>.</span><span class=na>CONNECTION_MODE_CHANGED</span><span class=p>);</span>
</span><span id=__span-12-42><a id=__codelineno-12-42 name=__codelineno-12-42 href=#__codelineno-12-42></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-12-43><a id=__codelineno-12-43 name=__codelineno-12-43 href=#__codelineno-12-43></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-12-44><a id=__codelineno-12-44 name=__codelineno-12-44 href=#__codelineno-12-44></a>
</span><span id=__span-12-45><a id=__codelineno-12-45 name=__codelineno-12-45 href=#__codelineno-12-45></a><span class=w>    </span><span class=nd>@Override</span>
</span><span id=__span-12-46><a id=__codelineno-12-46 name=__codelineno-12-46 href=#__codelineno-12-46></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cleanup</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-47><a id=__codelineno-12-47 name=__codelineno-12-47 href=#__codelineno-12-47></a><span class=w>        </span><span class=n>cnxn</span><span class=p>.</span><span class=na>close</span><span class=p>(</span><span class=n>ServerCnxn</span><span class=p>.</span><span class=na>DisconnectReason</span><span class=p>.</span><span class=na>CLEAN_UP</span><span class=p>);</span>
</span><span id=__span-12-48><a id=__codelineno-12-48 name=__codelineno-12-48 href=#__codelineno-12-48></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-12-49><a id=__codelineno-12-49 name=__codelineno-12-49 href=#__codelineno-12-49></a>
</span><span id=__span-12-50><a id=__codelineno-12-50 name=__codelineno-12-50 href=#__codelineno-12-50></a><span class=p>}</span>
</span></code></pre></div> <h4 id=nioservercnxndoio><strong>NIOServerCnxnçš„doIO</strong><a class=headerlink href=#nioservercnxndoio title="Permanent link">&para;</a></h4> <p>å¯ä»¥å‚è€ƒè¿™ä¸ªåšå®¢ï¼š <a href=https://blog.csdn.net/jpf254/article/details/80792086>https://blog.csdn.net/jpf254/article/details/80792086</a></p> <div class="language-java highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=c1>//å¤„ç†IO</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=kt>void</span><span class=w> </span><span class=nf>doIO</span><span class=p>(</span><span class=n>SelectionKey</span><span class=w> </span><span class=n>k</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isSocketOpen</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=w>            </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;trying to do i/o on a null socket for session: 0x{}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>toHexString</span><span class=p>(</span><span class=n>sessionId</span><span class=p>));</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=w>            </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>k</span><span class=p>.</span><span class=na>isReadable</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=w>            </span><span class=c1>//ä»æ­¤é€šé“è¯»å–å­—èŠ‚åºåˆ—åˆ°ç»™å®šç¼“å†²åŒºã€‚</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=w>            </span><span class=c1>//è‹¥æ˜¯å®¢æˆ·ç«¯è¯·æ±‚,æ­¤æ—¶è§¦å‘è¯»äº‹ä»¶</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=w>            </span><span class=c1>//åˆå§‹åŒ–æ—¶incomingBufferå³æ—¶lengthBuffer,åªåˆ†é…äº†4ä¸ªå­—èŠ‚,ä¾›ç”¨æˆ·è¯»å–ä¸€ä¸ªint(æ­¤intå€¼å°±æ˜¯æ­¤æ¬¡è¯·æ±‚æŠ¥æ–‡çš„æ€»é•¿åº¦)</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>rc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sock</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>);</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rc</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=w>                </span><span class=n>handleFailedRead</span><span class=p>();</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=c1>//è¿”å›å½“å‰ä½ç½®å’Œé™åˆ¶ä¹‹é—´çš„å…ƒç´ æ•°</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a><span class=cm>/*</span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a><span class=cm>                åªæœ‰incomingBuffer.remaining() == 0,æ‰ä¼šè¿›è¡Œä¸‹ä¸€æ­¥çš„å¤„ç†,å¦åˆ™ä¸€ç›´è¯»å–æ•°æ®ç›´åˆ°incomingBufferè¯»æ»¡,æ­¤æ—¶æœ‰ä¸¤ç§å¯èƒ½:</span>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a><span class=cm>                1.incomingBufferå°±æ˜¯lenBuffer,æ­¤æ—¶incomingBufferçš„å†…å®¹æ˜¯æ­¤æ¬¡è¯·æ±‚æŠ¥æ–‡çš„é•¿åº¦.</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a><span class=cm>                æ ¹æ®lenBufferä¸ºincomingBufferåˆ†é…ç©ºé—´åè°ƒç”¨readPayload().</span>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a><span class=cm>                åœ¨readPayload()ä¸­ä¼šç«‹é©¬è¿›è¡Œä¸€æ¬¡æ•°æ®è¯»å–,(1)è‹¥å¯ä»¥å°†incomingBufferè¯»æ»¡,åˆ™incomingBufferä¸­å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚,å¤„ç†è¯¥è¯·æ±‚;</span>
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24 href=#__codelineno-13-24></a><span class=cm>                (2)è‹¥ä¸èƒ½å°†incomingBufferè¯»æ»¡,è¯´æ˜å‡ºç°äº†æ‹†åŒ…é—®é¢˜,æ­¤æ—¶ä¸èƒ½æ„é€ ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚,åªèƒ½ç­‰å¾…å®¢æˆ·ç«¯ç»§ç»­å‘é€æ•°æ®,ç­‰åˆ°ä¸‹æ¬¡socketChannelå¯è¯»æ—¶,ç»§ç»­å°†æ•°æ®è¯»å–åˆ°incomingBufferä¸­</span>
</span><span id=__span-13-25><a id=__codelineno-13-25 name=__codelineno-13-25 href=#__codelineno-13-25></a><span class=cm>                2.incomingBufferä¸æ˜¯lenBuffer,è¯´æ˜ä¸Šæ¬¡è¯»å–æ—¶å‡ºç°äº†æ‹†åŒ…é—®é¢˜,incomingBufferä¸­åªæœ‰ä¸€ä¸ªè¯·æ±‚çš„éƒ¨åˆ†æ•°æ®.</span>
</span><span id=__span-13-26><a id=__codelineno-13-26 name=__codelineno-13-26 href=#__codelineno-13-26></a><span class=cm>                è€Œè¿™æ¬¡è¯»å–çš„æ•°æ®åŠ ä¸Šä¸Šæ¬¡è¯»å–çš„æ•°æ®å‡‘æˆäº†ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚,è°ƒç”¨readPayload()</span>
</span><span id=__span-13-27><a id=__codelineno-13-27 name=__codelineno-13-27 href=#__codelineno-13-27></a><span class=cm>               */</span>
</span><span id=__span-13-28><a id=__codelineno-13-28 name=__codelineno-13-28 href=#__codelineno-13-28></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>remaining</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-29><a id=__codelineno-13-29 name=__codelineno-13-29 href=#__codelineno-13-29></a><span class=w>                </span><span class=kt>boolean</span><span class=w> </span><span class=n>isPayload</span><span class=p>;</span>
</span><span id=__span-13-30><a id=__codelineno-13-30 name=__codelineno-13-30 href=#__codelineno-13-30></a><span class=c1>//ä¸€ä¸ªæ˜¯lenBuffer,å®¹é‡ä¸º4ä¸ªå­—èŠ‚,ç”¨äºè¯»å–é•¿åº¦ä¿¡æ¯.ä¸€ä¸ªæ˜¯incomingBuffer,å…¶åˆå§‹åŒ–æ—¶å³ä¸ºlenBuffer,ä½†æ˜¯è¯»å–é•¿åº¦ä¿¡æ¯å,å°±ä¸ºincomingBufferåˆ†é…å¯¹åº”çš„ç©ºé—´ç”¨äºè¯»å–payload</span>
</span><span id=__span-13-31><a id=__codelineno-13-31 name=__codelineno-13-31 href=#__codelineno-13-31></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>incomingBuffer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>lenBuffer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// start of next request</span>
</span><span id=__span-13-32><a id=__codelineno-13-32 name=__codelineno-13-32 href=#__codelineno-13-32></a><span class=c1>//åˆ‡æ¢ä¸ºè¯»å°±ç»ªçŠ¶æ€</span>
</span><span id=__span-13-33><a id=__codelineno-13-33 name=__codelineno-13-33 href=#__codelineno-13-33></a>
</span><span id=__span-13-34><a id=__codelineno-13-34 name=__codelineno-13-34 href=#__codelineno-13-34></a><span class=w>                    </span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>flip</span><span class=p>();</span>
</span><span id=__span-13-35><a id=__codelineno-13-35 name=__codelineno-13-35 href=#__codelineno-13-35></a><span class=c1>//åœ¨æ­¤ç¼“å†²åŒºçš„å½“å‰ä½ç½®è¯»å–æ¥ä¸‹æ¥çš„å››ä¸ªå­—èŠ‚ï¼Œæ ¹æ®å½“å‰å­—èŠ‚é¡ºåºå°†å®ƒä»¬ç»„åˆæˆä¸€ä¸ª int å€¼ï¼Œç„¶åå°†ä½ç½®å¢åŠ  4</span>
</span><span id=__span-13-36><a id=__codelineno-13-36 name=__codelineno-13-36 href=#__codelineno-13-36></a><span class=c1>//è¿™é‡Œåªæœ‰ä¼ è¾“çš„æ•°æ®ä¸ºå››å­—å‘½ä»¤æ—¶å€™æ‰ä¸ºfalseåé¢ä¸éœ€è¦è¯»å–æ•°æ®å†…å®¹ç»“æœä¸ºfalseç›´æ¥è¿”å›</span>
</span><span id=__span-13-37><a id=__codelineno-13-37 name=__codelineno-13-37 href=#__codelineno-13-37></a><span class=w>                    </span><span class=n>isPayload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>readLength</span><span class=p>(</span><span class=n>k</span><span class=p>);</span>
</span><span id=__span-13-38><a id=__codelineno-13-38 name=__codelineno-13-38 href=#__codelineno-13-38></a><span class=w>                    </span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
</span><span id=__span-13-39><a id=__codelineno-13-39 name=__codelineno-13-39 href=#__codelineno-13-39></a><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-40><a id=__codelineno-13-40 name=__codelineno-13-40 href=#__codelineno-13-40></a><span class=w>                    </span><span class=c1>// continuation</span>
</span><span id=__span-13-41><a id=__codelineno-13-41 name=__codelineno-13-41 href=#__codelineno-13-41></a><span class=w>                    </span><span class=n>isPayload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-13-42><a id=__codelineno-13-42 name=__codelineno-13-42 href=#__codelineno-13-42></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-13-43><a id=__codelineno-13-43 name=__codelineno-13-43 href=#__codelineno-13-43></a><span class=c1>//ä¸æ˜¯å››å­—å‘½ä»¤åˆ™è¯»å–è¯¦ç»†å†…å®¹</span>
</span><span id=__span-13-44><a id=__codelineno-13-44 name=__codelineno-13-44 href=#__codelineno-13-44></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isPayload</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// not the case for 4letterword</span>
</span><span id=__span-13-45><a id=__codelineno-13-45 name=__codelineno-13-45 href=#__codelineno-13-45></a><span class=w>                    </span><span class=n>readPayload</span><span class=p>();</span>
</span><span id=__span-13-46><a id=__codelineno-13-46 name=__codelineno-13-46 href=#__codelineno-13-46></a><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-47><a id=__codelineno-13-47 name=__codelineno-13-47 href=#__codelineno-13-47></a><span class=w>                    </span><span class=c1>// four letter words take care</span>
</span><span id=__span-13-48><a id=__codelineno-13-48 name=__codelineno-13-48 href=#__codelineno-13-48></a><span class=w>                    </span><span class=c1>// need not do anything else</span>
</span><span id=__span-13-49><a id=__codelineno-13-49 name=__codelineno-13-49 href=#__codelineno-13-49></a><span class=c1>//å››å­—å‘½ä»¤è¯·æ±‚å‰é¢å·²ç»è¿›è¡Œè¿‡å¤„ç†åˆ™ç›´æ¥è¿”å›</span>
</span><span id=__span-13-50><a id=__codelineno-13-50 name=__codelineno-13-50 href=#__codelineno-13-50></a><span class=w>                    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-13-51><a id=__codelineno-13-51 name=__codelineno-13-51 href=#__codelineno-13-51></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-13-52><a id=__codelineno-13-52 name=__codelineno-13-52 href=#__codelineno-13-52></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-13-53><a id=__codelineno-13-53 name=__codelineno-13-53 href=#__codelineno-13-53></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-13-54><a id=__codelineno-13-54 name=__codelineno-13-54 href=#__codelineno-13-54></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>k</span><span class=p>.</span><span class=na>isWritable</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-55><a id=__codelineno-13-55 name=__codelineno-13-55 href=#__codelineno-13-55></a><span class=w>            </span><span class=n>handleWrite</span><span class=p>(</span><span class=n>k</span><span class=p>);</span>
</span><span id=__span-13-56><a id=__codelineno-13-56 name=__codelineno-13-56 href=#__codelineno-13-56></a>
</span><span id=__span-13-57><a id=__codelineno-13-57 name=__codelineno-13-57 href=#__codelineno-13-57></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>initialized</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>getReadInterest</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>getWriteInterest</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-58><a id=__codelineno-13-58 name=__codelineno-13-58 href=#__codelineno-13-58></a><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CloseRequestException</span><span class=p>(</span><span class=s>&quot;responded to info probe&quot;</span><span class=p>,</span><span class=w> </span><span class=n>DisconnectReason</span><span class=p>.</span><span class=na>INFO_PROBE</span><span class=p>);</span>
</span><span id=__span-13-59><a id=__codelineno-13-59 name=__codelineno-13-59 href=#__codelineno-13-59></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-13-60><a id=__codelineno-13-60 name=__codelineno-13-60 href=#__codelineno-13-60></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-13-61><a id=__codelineno-13-61 name=__codelineno-13-61 href=#__codelineno-13-61></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>CancelledKeyException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-62><a id=__codelineno-13-62 name=__codelineno-13-62 href=#__codelineno-13-62></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;CancelledKeyException causing close of session: 0x{}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>toHexString</span><span class=p>(</span><span class=n>sessionId</span><span class=p>));</span>
</span><span id=__span-13-63><a id=__codelineno-13-63 name=__codelineno-13-63 href=#__codelineno-13-63></a>
</span><span id=__span-13-64><a id=__codelineno-13-64 name=__codelineno-13-64 href=#__codelineno-13-64></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&quot;CancelledKeyException stack trace&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-13-65><a id=__codelineno-13-65 name=__codelineno-13-65 href=#__codelineno-13-65></a>
</span><span id=__span-13-66><a id=__codelineno-13-66 name=__codelineno-13-66 href=#__codelineno-13-66></a><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>DisconnectReason</span><span class=p>.</span><span class=na>CANCELLED_KEY_EXCEPTION</span><span class=p>);</span>
</span><span id=__span-13-67><a id=__codelineno-13-67 name=__codelineno-13-67 href=#__codelineno-13-67></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>CloseRequestException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-68><a id=__codelineno-13-68 name=__codelineno-13-68 href=#__codelineno-13-68></a><span class=w>        </span><span class=c1>// expecting close to log session closure</span>
</span><span id=__span-13-69><a id=__codelineno-13-69 name=__codelineno-13-69 href=#__codelineno-13-69></a><span class=w>        </span><span class=n>close</span><span class=p>();</span>
</span><span id=__span-13-70><a id=__codelineno-13-70 name=__codelineno-13-70 href=#__codelineno-13-70></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>EndOfStreamException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-71><a id=__codelineno-13-71 name=__codelineno-13-71 href=#__codelineno-13-71></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Unexpected exception&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-13-72><a id=__codelineno-13-72 name=__codelineno-13-72 href=#__codelineno-13-72></a><span class=w>        </span><span class=c1>// expecting close to log session closure</span>
</span><span id=__span-13-73><a id=__codelineno-13-73 name=__codelineno-13-73 href=#__codelineno-13-73></a><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getReason</span><span class=p>());</span>
</span><span id=__span-13-74><a id=__codelineno-13-74 name=__codelineno-13-74 href=#__codelineno-13-74></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ClientCnxnLimitException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-75><a id=__codelineno-13-75 name=__codelineno-13-75 href=#__codelineno-13-75></a><span class=w>        </span><span class=c1>// Common case exception, print at debug level</span>
</span><span id=__span-13-76><a id=__codelineno-13-76 name=__codelineno-13-76 href=#__codelineno-13-76></a><span class=w>        </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>CONNECTION_REJECTED</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-13-77><a id=__codelineno-13-77 name=__codelineno-13-77 href=#__codelineno-13-77></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Closing session 0x{}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>toHexString</span><span class=p>(</span><span class=n>sessionId</span><span class=p>),</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-13-78><a id=__codelineno-13-78 name=__codelineno-13-78 href=#__codelineno-13-78></a><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>DisconnectReason</span><span class=p>.</span><span class=na>CLIENT_CNX_LIMIT</span><span class=p>);</span>
</span><span id=__span-13-79><a id=__codelineno-13-79 name=__codelineno-13-79 href=#__codelineno-13-79></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-80><a id=__codelineno-13-80 name=__codelineno-13-80 href=#__codelineno-13-80></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Close of session 0x{}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>toHexString</span><span class=p>(</span><span class=n>sessionId</span><span class=p>),</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-13-81><a id=__codelineno-13-81 name=__codelineno-13-81 href=#__codelineno-13-81></a><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>DisconnectReason</span><span class=p>.</span><span class=na>IO_EXCEPTION</span><span class=p>);</span>
</span><span id=__span-13-82><a id=__codelineno-13-82 name=__codelineno-13-82 href=#__codelineno-13-82></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-13-83><a id=__codelineno-13-83 name=__codelineno-13-83 href=#__codelineno-13-83></a><span class=p>}</span>
</span></code></pre></div> <h3 id=readpayload><strong>readPayload</strong><a class=headerlink href=#readpayload title="Permanent link">&para;</a></h3> <div class="language-java highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=cm>/**</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=cm> * æœ‰ä¸¤ç§æƒ…å†µä¼šè°ƒç”¨æ­¤æ–¹æ³•:</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=cm> * 1.æ ¹æ®lengthBufferçš„å€¼ä¸ºincomingBufferåˆ†é…ç©ºé—´å,æ­¤æ—¶å°šæœªå°†æ•°æ®ä»socketChannelè¯»å–è‡³incomingBufferä¸­</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=cm> * 2.å·²ç»å°†æ•°æ®ä»socketChannelä¸­è¯»å–è‡³incomingBuffer,ä¸”è¯»å–å®Œæ¯•</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=cm> * &lt;p&gt;</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=cm> * Read the request payload (everything following the length prefix)</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=cm> */</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>readPayload</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ClientCnxnLimitException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>remaining</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// have we read length bytes?</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=c1>//å¯¹åº”æƒ…å†µ1,æ­¤æ—¶åˆšä¸ºincomingBufferåˆ†é…ç©ºé—´,incomingBufferä¸ºç©º,è¿›è¡Œä¸€æ¬¡æ•°æ®è¯»å–</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=w>        </span><span class=c1>//(1)è‹¥å°†incomingBufferè¯»æ»¡,åˆ™ç›´æ¥è¿›è¡Œå¤„ç†;</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a><span class=w>        </span><span class=c1>//(2)è‹¥æœªå°†incomingBufferè¯»æ»¡,åˆ™è¯´æ˜æ­¤æ¬¡å‘é€çš„æ•°æ®ä¸èƒ½æ„æˆä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚,åˆ™ç­‰å¾…ä¸‹ä¸€æ¬¡æ•°æ®åˆ°è¾¾åè°ƒç”¨doIo()æ—¶å†æ¬¡å°†æ•°æ®</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=w>        </span><span class=c1>//ä»socketChannelè¯»å–è‡³incomingBuffer</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>rc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sock</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>);</span><span class=w> </span><span class=c1>// sock is non-blocking, so ok</span>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rc</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a><span class=w>            </span><span class=n>handleFailedRead</span><span class=p>();</span>
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a>
</span><span id=__span-14-22><a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>remaining</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// have we read length bytes?</span>
</span><span id=__span-14-23><a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a><span class=w>        </span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>flip</span><span class=p>();</span>
</span><span id=__span-14-24><a id=__codelineno-14-24 name=__codelineno-14-24 href=#__codelineno-14-24></a><span class=c1>//ä¸ç®¡æ˜¯æƒ…å†µ1è¿˜æ˜¯æƒ…å†µ2,æ­¤æ—¶incomingBufferå·²è¯»æ»¡,å…¶ä¸­å†…å®¹å¿…æ˜¯ä¸€ä¸ªrequest,å¤„ç†è¯¥request</span>
</span><span id=__span-14-25><a id=__codelineno-14-25 name=__codelineno-14-25 href=#__codelineno-14-25></a><span class=w>        </span><span class=c1>//æ›´æ–°ç»Ÿè®¡å€¼</span>
</span><span id=__span-14-26><a id=__codelineno-14-26 name=__codelineno-14-26 href=#__codelineno-14-26></a><span class=w>        </span><span class=n>packetReceived</span><span class=p>(</span><span class=mi>4</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>remaining</span><span class=p>());</span>
</span><span id=__span-14-27><a id=__codelineno-14-27 name=__codelineno-14-27 href=#__codelineno-14-27></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>initialized</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-28><a id=__codelineno-14-28 name=__codelineno-14-28 href=#__codelineno-14-28></a><span class=o>/</span><span class=n>å¤„ç†è¿æ¥è¯·æ±‚</span>
</span><span id=__span-14-29><a id=__codelineno-14-29 name=__codelineno-14-29 href=#__codelineno-14-29></a><span class=w>            </span><span class=nf>readConnectRequest</span><span class=p>();</span>
</span><span id=__span-14-30><a id=__codelineno-14-30 name=__codelineno-14-30 href=#__codelineno-14-30></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-31><a id=__codelineno-14-31 name=__codelineno-14-31 href=#__codelineno-14-31></a><span class=c1>//å¤„ç†æ™®é€šè¯·æ±‚</span>
</span><span id=__span-14-32><a id=__codelineno-14-32 name=__codelineno-14-32 href=#__codelineno-14-32></a><span class=w>            </span><span class=n>readRequest</span><span class=p>();</span>
</span><span id=__span-14-33><a id=__codelineno-14-33 name=__codelineno-14-33 href=#__codelineno-14-33></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-14-34><a id=__codelineno-14-34 name=__codelineno-14-34 href=#__codelineno-14-34></a><span class=c1>//è¯·æ±‚å¤„ç†ç»“æŸ,é‡ç½®lenBufferå’ŒincomingBuffer</span>
</span><span id=__span-14-35><a id=__codelineno-14-35 name=__codelineno-14-35 href=#__codelineno-14-35></a><span class=w>        </span><span class=n>lenBuffer</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
</span><span id=__span-14-36><a id=__codelineno-14-36 name=__codelineno-14-36 href=#__codelineno-14-36></a><span class=w>        </span><span class=n>incomingBuffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lenBuffer</span><span class=p>;</span>
</span><span id=__span-14-37><a id=__codelineno-14-37 name=__codelineno-14-37 href=#__codelineno-14-37></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-14-38><a id=__codelineno-14-38 name=__codelineno-14-38 href=#__codelineno-14-38></a><span class=p>}</span>
</span></code></pre></div> <h3 id=readconnectrequest><strong>readConnectRequest</strong><a class=headerlink href=#readconnectrequest title="Permanent link">&para;</a></h3> <div class="language-java highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=c1>//è¯»å–è¿æ¥æ•°æ®</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>readConnectRequest</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ClientCnxnLimitException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isZKServerRunning</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IOException</span><span class=p>(</span><span class=s>&quot;ZooKeeperServer not running&quot;</span><span class=p>);</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=w>    </span><span class=n>zkServer</span><span class=p>.</span><span class=na>processConnectRequest</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>incomingBuffer</span><span class=p>);</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=w>    </span><span class=n>initialized</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=p>}</span>
</span></code></pre></div> <div class="language-java highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1>//è¯»å–åŒ…æ•°æ®</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>readRequest</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=w>    </span><span class=n>zkServer</span><span class=p>.</span><span class=na>processPacket</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>incomingBuffer</span><span class=p>);</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=p>}</span>
</span></code></pre></div> <p>ZooKeeperServerå¤„ç†è¿æ¥è¯·æ±‚ï¼šprocessConnectRequest å¯ä»¥å‚è€ƒæ–‡ç« ï¼š</p> <ul> <li><a href=https://www.cnblogs.com/Benjious/p/11462064.html>https://www.cnblogs.com/Benjious/p/11462064.html</a> session:</li> <li><a href=https://my.oschina.net/anxiaole/blog/3217373>https://my.oschina.net/anxiaole/blog/3217373</a></li> <li><a href=https://segmentfault.com/a/1190000022193168>https://segmentfault.com/a/1190000022193168</a></li> </ul> <h4 id=processconnectrequest><strong>å¤„ç†è¿æ¥è¯·æ±‚processConnectRequest</strong><a class=headerlink href=#processconnectrequest title="Permanent link">&para;</a></h4> <p>è°ƒç”¨ä»£ç å¦‚ä¸‹ï¼š zkServer.processConnectRequest(this, incomingBuffer);</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=n>è§£æä»£ç å¦‚ä¸‹</span><span class=err>ï¼š</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=nd>@SuppressFBWarnings</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;IS2_INCONSISTENT_SYNC&quot;</span><span class=p>,</span><span class=w> </span><span class=n>justification</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;the value won&#39;t change after startup&quot;</span><span class=p>)</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processConnectRequest</span><span class=p>(</span><span class=n>ServerCnxn</span><span class=w> </span><span class=n>cnxn</span><span class=p>,</span><span class=w> </span><span class=n>ByteBuffer</span><span class=w> </span><span class=n>incomingBuffer</span><span class=p>)</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ClientCnxnLimitException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=w>    </span><span class=n>BinaryInputArchive</span><span class=w> </span><span class=n>bia</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BinaryInputArchive</span><span class=p>.</span><span class=na>getArchive</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ByteBufferInputStream</span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>));</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=c1>//</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=w>    </span><span class=n>ConnectRequest</span><span class=w> </span><span class=n>connReq</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConnectRequest</span><span class=p>();</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=c1>//ååºåˆ—åŒ–è¿æ¥ä¿¡æ¯</span>
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=w>    </span><span class=n>connReq</span><span class=p>.</span><span class=na>deserialize</span><span class=p>(</span><span class=n>bia</span><span class=p>,</span><span class=w> </span><span class=s>&quot;connect&quot;</span><span class=p>);</span>
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=w>    </span><span class=n>LOG</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span>
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a><span class=w>            </span><span class=s>&quot;Session establishment request from client {} client&#39;s lastZxid is 0x{}&quot;</span><span class=p>,</span>
</span><span id=__span-17-14><a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a><span class=w>            </span><span class=n>cnxn</span><span class=p>.</span><span class=na>getRemoteSocketAddress</span><span class=p>(),</span>
</span><span id=__span-17-15><a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a><span class=w>            </span><span class=n>Long</span><span class=p>.</span><span class=na>toHexString</span><span class=p>(</span><span class=n>connReq</span><span class=p>.</span><span class=na>getLastZxidSeen</span><span class=p>()));</span>
</span><span id=__span-17-16><a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a>
</span><span id=__span-17-17><a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>sessionId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connReq</span><span class=p>.</span><span class=na>getSessionId</span><span class=p>();</span>
</span><span id=__span-17-18><a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>tokensNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-17-19><a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a><span class=c1>//èŠ‚æµæ—¶å€™æ˜¯å¦è€ƒè™‘è¿æ¥æƒé‡é…ç½®å‚æ•°ä¸ºzookeeper.connection_throttle_weight_enabled</span>
</span><span id=__span-17-20><a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a><span class=w>    </span><span class=n>é»˜è®¤å€¼ä¸ºfalse</span>
</span><span id=__span-17-21><a id=__codelineno-17-21 name=__codelineno-17-21 href=#__codelineno-17-21></a><span class=w>    </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>connThrottle</span><span class=p>.</span><span class=na>isConnectionWeightEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-22><a id=__codelineno-17-22 name=__codelineno-17-22 href=#__codelineno-17-22></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sessionId</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-23><a id=__codelineno-17-23 name=__codelineno-17-23 href=#__codelineno-17-23></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localSessionEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-24><a id=__codelineno-17-24 name=__codelineno-17-24 href=#__codelineno-17-24></a><span class=w>                </span><span class=n>tokensNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connThrottle</span><span class=p>.</span><span class=na>getRequiredTokensForLocal</span><span class=p>();</span>
</span><span id=__span-17-25><a id=__codelineno-17-25 name=__codelineno-17-25 href=#__codelineno-17-25></a><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-26><a id=__codelineno-17-26 name=__codelineno-17-26 href=#__codelineno-17-26></a><span class=w>                </span><span class=n>tokensNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connThrottle</span><span class=p>.</span><span class=na>getRequiredTokensForGlobal</span><span class=p>();</span>
</span><span id=__span-17-27><a id=__codelineno-17-27 name=__codelineno-17-27 href=#__codelineno-17-27></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-17-28><a id=__codelineno-17-28 name=__codelineno-17-28 href=#__codelineno-17-28></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-29><a id=__codelineno-17-29 name=__codelineno-17-29 href=#__codelineno-17-29></a><span class=w>            </span><span class=n>tokensNeeded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connThrottle</span><span class=p>.</span><span class=na>getRequiredTokensForRenew</span><span class=p>();</span>
</span><span id=__span-17-30><a id=__codelineno-17-30 name=__codelineno-17-30 href=#__codelineno-17-30></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-17-31><a id=__codelineno-17-31 name=__codelineno-17-31 href=#__codelineno-17-31></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-32><a id=__codelineno-17-32 name=__codelineno-17-32 href=#__codelineno-17-32></a><span class=c1>//ä»¤ç‰Œæ¡¶é™æµç®—æ³•ï¼Œæ˜¯å¦æœ‰å¯ç”¨token</span>
</span><span id=__span-17-33><a id=__codelineno-17-33 name=__codelineno-17-33 href=#__codelineno-17-33></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>connThrottle</span><span class=p>.</span><span class=na>checkLimit</span><span class=p>(</span><span class=n>tokensNeeded</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-34><a id=__codelineno-17-34 name=__codelineno-17-34 href=#__codelineno-17-34></a><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ClientCnxnLimitException</span><span class=p>();</span>
</span><span id=__span-17-35><a id=__codelineno-17-35 name=__codelineno-17-35 href=#__codelineno-17-35></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-36><a id=__codelineno-17-36 name=__codelineno-17-36 href=#__codelineno-17-36></a><span class=w>    </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>CONNECTION_TOKEN_DEFICIT</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>connThrottle</span><span class=p>.</span><span class=na>getDeficit</span><span class=p>());</span>
</span><span id=__span-17-37><a id=__codelineno-17-37 name=__codelineno-17-37 href=#__codelineno-17-37></a><span class=w>    </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>CONNECTION_REQUEST_COUNT</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-17-38><a id=__codelineno-17-38 name=__codelineno-17-38 href=#__codelineno-17-38></a>
</span><span id=__span-17-39><a id=__codelineno-17-39 name=__codelineno-17-39 href=#__codelineno-17-39></a><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>readOnly</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-17-40><a id=__codelineno-17-40 name=__codelineno-17-40 href=#__codelineno-17-40></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-41><a id=__codelineno-17-41 name=__codelineno-17-41 href=#__codelineno-17-41></a><span class=c1>//æ˜¯å¦ä¸ºåªè¯»</span>
</span><span id=__span-17-42><a id=__codelineno-17-42 name=__codelineno-17-42 href=#__codelineno-17-42></a><span class=w>        </span><span class=n>readOnly</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bia</span><span class=p>.</span><span class=na>readBool</span><span class=p>(</span><span class=s>&quot;readOnly&quot;</span><span class=p>);</span>
</span><span id=__span-17-43><a id=__codelineno-17-43 name=__codelineno-17-43 href=#__codelineno-17-43></a><span class=w>        </span><span class=n>cnxn</span><span class=p>.</span><span class=na>isOldClient</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-17-44><a id=__codelineno-17-44 name=__codelineno-17-44 href=#__codelineno-17-44></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-45><a id=__codelineno-17-45 name=__codelineno-17-45 href=#__codelineno-17-45></a><span class=w>        </span><span class=c1>// this is ok -- just a packet from an old client which</span>
</span><span id=__span-17-46><a id=__codelineno-17-46 name=__codelineno-17-46 href=#__codelineno-17-46></a><span class=w>        </span><span class=c1>// doesn&#39;t contain readOnly field</span>
</span><span id=__span-17-47><a id=__codelineno-17-47 name=__codelineno-17-47 href=#__codelineno-17-47></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span>
</span><span id=__span-17-48><a id=__codelineno-17-48 name=__codelineno-17-48 href=#__codelineno-17-48></a><span class=w>                </span><span class=s>&quot;Connection request from old client {}; will be dropped if server is in r-o mode&quot;</span><span class=p>,</span>
</span><span id=__span-17-49><a id=__codelineno-17-49 name=__codelineno-17-49 href=#__codelineno-17-49></a><span class=w>                </span><span class=n>cnxn</span><span class=p>.</span><span class=na>getRemoteSocketAddress</span><span class=p>());</span>
</span><span id=__span-17-50><a id=__codelineno-17-50 name=__codelineno-17-50 href=#__codelineno-17-50></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-51><a id=__codelineno-17-51 name=__codelineno-17-51 href=#__codelineno-17-51></a><span class=c1>//å½“å‰æ˜¯åªè¯»å¯¹è±¡ï¼Œæ•°æ®ä¸ä¸ºåªè¯»æ•°æ®</span>
</span><span id=__span-17-52><a id=__codelineno-17-52 name=__codelineno-17-52 href=#__codelineno-17-52></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>readOnly</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=k>this</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>ReadOnlyZooKeeperServer</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-53><a id=__codelineno-17-53 name=__codelineno-17-53 href=#__codelineno-17-53></a><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Refusing session request for not-read-only client &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>cnxn</span><span class=p>.</span><span class=na>getRemoteSocketAddress</span><span class=p>();</span>
</span><span id=__span-17-54><a id=__codelineno-17-54 name=__codelineno-17-54 href=#__codelineno-17-54></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span>
</span><span id=__span-17-55><a id=__codelineno-17-55 name=__codelineno-17-55 href=#__codelineno-17-55></a><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CloseRequestException</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span><span class=w> </span><span class=n>ServerCnxn</span><span class=p>.</span><span class=na>DisconnectReason</span><span class=p>.</span><span class=na>CLIENT_ZXID_AHEAD</span><span class=p>);</span>
</span><span id=__span-17-56><a id=__codelineno-17-56 name=__codelineno-17-56 href=#__codelineno-17-56></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-57><a id=__codelineno-17-57 name=__codelineno-17-57 href=#__codelineno-17-57></a><span class=c1>//å½“å®¢æˆ·ç«¯çš„å¯è§zxidå¤§äºæœåŠ¡ç«¯çš„æœ€æ–°çš„äº‹ç‰©zxidåˆ™æ‹’ç»å¤„ç†ï¼Œè¿™ç§æƒ…å†µå¯èƒ½å‡ºç°åœ¨æœåŠ¡ç«¯çš„å¿«ç…§å’Œäº‹ç‰©æ—¥å¿—æ–‡ä»¶è¢«åˆ é™¤æ‰åé‡å¯äº†zookeeperå¯¼è‡´æœåŠ¡ç«¯zxidå˜å°æˆ–è€…å‡ºç°è„‘è£‚å®¢æˆ·ç«¯è®¿é—®äº†ä¸åŒçš„åˆ†åŒºä¸‹çš„zookeeperä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯</span>
</span><span id=__span-17-58><a id=__codelineno-17-58 name=__codelineno-17-58 href=#__codelineno-17-58></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>connReq</span><span class=p>.</span><span class=na>getLastZxidSeen</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>zkDb</span><span class=p>.</span><span class=na>dataTree</span><span class=p>.</span><span class=na>lastProcessedZxid</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-59><a id=__codelineno-17-59 name=__codelineno-17-59 href=#__codelineno-17-59></a><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Refusing session request for client &quot;</span>
</span><span id=__span-17-60><a id=__codelineno-17-60 name=__codelineno-17-60 href=#__codelineno-17-60></a><span class=w>                </span><span class=o>+</span><span class=w> </span><span class=n>cnxn</span><span class=p>.</span><span class=na>getRemoteSocketAddress</span><span class=p>()</span>
</span><span id=__span-17-61><a id=__codelineno-17-61 name=__codelineno-17-61 href=#__codelineno-17-61></a><span class=w>                </span><span class=o>+</span><span class=w> </span><span class=s>&quot; as it has seen zxid 0x&quot;</span>
</span><span id=__span-17-62><a id=__codelineno-17-62 name=__codelineno-17-62 href=#__codelineno-17-62></a><span class=w>                </span><span class=o>+</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>toHexString</span><span class=p>(</span><span class=n>connReq</span><span class=p>.</span><span class=na>getLastZxidSeen</span><span class=p>())</span>
</span><span id=__span-17-63><a id=__codelineno-17-63 name=__codelineno-17-63 href=#__codelineno-17-63></a><span class=w>                </span><span class=o>+</span><span class=w> </span><span class=s>&quot; our last zxid is 0x&quot;</span>
</span><span id=__span-17-64><a id=__codelineno-17-64 name=__codelineno-17-64 href=#__codelineno-17-64></a><span class=w>                </span><span class=o>+</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>toHexString</span><span class=p>(</span><span class=n>getZKDatabase</span><span class=p>().</span><span class=na>getDataTreeLastProcessedZxid</span><span class=p>())</span>
</span><span id=__span-17-65><a id=__codelineno-17-65 name=__codelineno-17-65 href=#__codelineno-17-65></a><span class=w>                </span><span class=o>+</span><span class=w> </span><span class=s>&quot; client must try another server&quot;</span><span class=p>;</span>
</span><span id=__span-17-66><a id=__codelineno-17-66 name=__codelineno-17-66 href=#__codelineno-17-66></a>
</span><span id=__span-17-67><a id=__codelineno-17-67 name=__codelineno-17-67 href=#__codelineno-17-67></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span>
</span><span id=__span-17-68><a id=__codelineno-17-68 name=__codelineno-17-68 href=#__codelineno-17-68></a><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CloseRequestException</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span><span class=w> </span><span class=n>ServerCnxn</span><span class=p>.</span><span class=na>DisconnectReason</span><span class=p>.</span><span class=na>NOT_READ_ONLY_CLIENT</span><span class=p>);</span>
</span><span id=__span-17-69><a id=__codelineno-17-69 name=__codelineno-17-69 href=#__codelineno-17-69></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-70><a id=__codelineno-17-70 name=__codelineno-17-70 href=#__codelineno-17-70></a><span class=c1>//åˆå§‹åŒ–sessionè¶…æ—¶å‚æ•°</span>
</span><span id=__span-17-71><a id=__codelineno-17-71 name=__codelineno-17-71 href=#__codelineno-17-71></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>sessionTimeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connReq</span><span class=p>.</span><span class=na>getTimeOut</span><span class=p>();</span>
</span><span id=__span-17-72><a id=__codelineno-17-72 name=__codelineno-17-72 href=#__codelineno-17-72></a><span class=w>    </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>passwd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connReq</span><span class=p>.</span><span class=na>getPasswd</span><span class=p>();</span>
</span><span id=__span-17-73><a id=__codelineno-17-73 name=__codelineno-17-73 href=#__codelineno-17-73></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>minSessionTimeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getMinSessionTimeout</span><span class=p>();</span>
</span><span id=__span-17-74><a id=__codelineno-17-74 name=__codelineno-17-74 href=#__codelineno-17-74></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sessionTimeout</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>minSessionTimeout</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-75><a id=__codelineno-17-75 name=__codelineno-17-75 href=#__codelineno-17-75></a><span class=w>        </span><span class=n>sessionTimeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>minSessionTimeout</span><span class=p>;</span>
</span><span id=__span-17-76><a id=__codelineno-17-76 name=__codelineno-17-76 href=#__codelineno-17-76></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-77><a id=__codelineno-17-77 name=__codelineno-17-77 href=#__codelineno-17-77></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>maxSessionTimeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getMaxSessionTimeout</span><span class=p>();</span>
</span><span id=__span-17-78><a id=__codelineno-17-78 name=__codelineno-17-78 href=#__codelineno-17-78></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sessionTimeout</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>maxSessionTimeout</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-79><a id=__codelineno-17-79 name=__codelineno-17-79 href=#__codelineno-17-79></a><span class=w>        </span><span class=n>sessionTimeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>maxSessionTimeout</span><span class=p>;</span>
</span><span id=__span-17-80><a id=__codelineno-17-80 name=__codelineno-17-80 href=#__codelineno-17-80></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-81><a id=__codelineno-17-81 name=__codelineno-17-81 href=#__codelineno-17-81></a><span class=w>    </span><span class=n>cnxn</span><span class=p>.</span><span class=na>setSessionTimeout</span><span class=p>(</span><span class=n>sessionTimeout</span><span class=p>);</span>
</span><span id=__span-17-82><a id=__codelineno-17-82 name=__codelineno-17-82 href=#__codelineno-17-82></a><span class=w>    </span><span class=c1>// We don&#39;t want to receive any packets until we are sure that the</span>
</span><span id=__span-17-83><a id=__codelineno-17-83 name=__codelineno-17-83 href=#__codelineno-17-83></a><span class=w>    </span><span class=c1>// session is setup</span>
</span><span id=__span-17-84><a id=__codelineno-17-84 name=__codelineno-17-84 href=#__codelineno-17-84></a><span class=w>    </span><span class=n>cnxn</span><span class=p>.</span><span class=na>disableRecv</span><span class=p>();</span>
</span><span id=__span-17-85><a id=__codelineno-17-85 name=__codelineno-17-85 href=#__codelineno-17-85></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sessionId</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-86><a id=__codelineno-17-86 name=__codelineno-17-86 href=#__codelineno-17-86></a><span class=c1>//åˆ›å»ºsessionid</span>
</span><span id=__span-17-87><a id=__codelineno-17-87 name=__codelineno-17-87 href=#__codelineno-17-87></a><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createSession</span><span class=p>(</span><span class=n>cnxn</span><span class=p>,</span><span class=w> </span><span class=n>passwd</span><span class=p>,</span><span class=w> </span><span class=n>sessionTimeout</span><span class=p>);</span>
</span><span id=__span-17-88><a id=__codelineno-17-88 name=__codelineno-17-88 href=#__codelineno-17-88></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span>
</span><span id=__span-17-89><a id=__codelineno-17-89 name=__codelineno-17-89 href=#__codelineno-17-89></a><span class=w>                </span><span class=s>&quot;Client attempting to establish new session: session = 0x{}, zxid = 0x{}, timeout = {}, address = {}&quot;</span><span class=p>,</span>
</span><span id=__span-17-90><a id=__codelineno-17-90 name=__codelineno-17-90 href=#__codelineno-17-90></a><span class=w>                </span><span class=n>Long</span><span class=p>.</span><span class=na>toHexString</span><span class=p>(</span><span class=n>id</span><span class=p>),</span>
</span><span id=__span-17-91><a id=__codelineno-17-91 name=__codelineno-17-91 href=#__codelineno-17-91></a><span class=w>                </span><span class=n>Long</span><span class=p>.</span><span class=na>toHexString</span><span class=p>(</span><span class=n>connReq</span><span class=p>.</span><span class=na>getLastZxidSeen</span><span class=p>()),</span>
</span><span id=__span-17-92><a id=__codelineno-17-92 name=__codelineno-17-92 href=#__codelineno-17-92></a><span class=w>                </span><span class=n>connReq</span><span class=p>.</span><span class=na>getTimeOut</span><span class=p>(),</span>
</span><span id=__span-17-93><a id=__codelineno-17-93 name=__codelineno-17-93 href=#__codelineno-17-93></a><span class=w>                </span><span class=n>cnxn</span><span class=p>.</span><span class=na>getRemoteSocketAddress</span><span class=p>());</span>
</span><span id=__span-17-94><a id=__codelineno-17-94 name=__codelineno-17-94 href=#__codelineno-17-94></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-95><a id=__codelineno-17-95 name=__codelineno-17-95 href=#__codelineno-17-95></a><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>clientSessionId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connReq</span><span class=p>.</span><span class=na>getSessionId</span><span class=p>();</span>
</span><span id=__span-17-96><a id=__codelineno-17-96 name=__codelineno-17-96 href=#__codelineno-17-96></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span>
</span><span id=__span-17-97><a id=__codelineno-17-97 name=__codelineno-17-97 href=#__codelineno-17-97></a><span class=w>                </span><span class=s>&quot;Client attempting to renew session: session = 0x{}, zxid = 0x{}, timeout = {}, address = {}&quot;</span><span class=p>,</span>
</span><span id=__span-17-98><a id=__codelineno-17-98 name=__codelineno-17-98 href=#__codelineno-17-98></a><span class=w>                </span><span class=n>Long</span><span class=p>.</span><span class=na>toHexString</span><span class=p>(</span><span class=n>clientSessionId</span><span class=p>),</span>
</span><span id=__span-17-99><a id=__codelineno-17-99 name=__codelineno-17-99 href=#__codelineno-17-99></a><span class=w>                </span><span class=n>Long</span><span class=p>.</span><span class=na>toHexString</span><span class=p>(</span><span class=n>connReq</span><span class=p>.</span><span class=na>getLastZxidSeen</span><span class=p>()),</span>
</span><span id=__span-17-100><a id=__codelineno-17-100 name=__codelineno-17-100 href=#__codelineno-17-100></a><span class=w>                </span><span class=n>connReq</span><span class=p>.</span><span class=na>getTimeOut</span><span class=p>(),</span>
</span><span id=__span-17-101><a id=__codelineno-17-101 name=__codelineno-17-101 href=#__codelineno-17-101></a><span class=w>                </span><span class=n>cnxn</span><span class=p>.</span><span class=na>getRemoteSocketAddress</span><span class=p>());</span>
</span><span id=__span-17-102><a id=__codelineno-17-102 name=__codelineno-17-102 href=#__codelineno-17-102></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>serverCnxnFactory</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-103><a id=__codelineno-17-103 name=__codelineno-17-103 href=#__codelineno-17-103></a><span class=w>            </span><span class=n>serverCnxnFactory</span><span class=p>.</span><span class=na>closeSession</span><span class=p>(</span><span class=n>sessionId</span><span class=p>,</span><span class=w> </span><span class=n>ServerCnxn</span><span class=p>.</span><span class=na>DisconnectReason</span><span class=p>.</span><span class=na>CLIENT_RECONNECT</span><span class=p>);</span>
</span><span id=__span-17-104><a id=__codelineno-17-104 name=__codelineno-17-104 href=#__codelineno-17-104></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-17-105><a id=__codelineno-17-105 name=__codelineno-17-105 href=#__codelineno-17-105></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>secureServerCnxnFactory</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-106><a id=__codelineno-17-106 name=__codelineno-17-106 href=#__codelineno-17-106></a><span class=w>            </span><span class=n>secureServerCnxnFactory</span><span class=p>.</span><span class=na>closeSession</span><span class=p>(</span><span class=n>sessionId</span><span class=p>,</span><span class=w> </span><span class=n>ServerCnxn</span><span class=p>.</span><span class=na>DisconnectReason</span><span class=p>.</span><span class=na>CLIENT_RECONNECT</span><span class=p>);</span>
</span><span id=__span-17-107><a id=__codelineno-17-107 name=__codelineno-17-107 href=#__codelineno-17-107></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-17-108><a id=__codelineno-17-108 name=__codelineno-17-108 href=#__codelineno-17-108></a><span class=w>        </span><span class=n>cnxn</span><span class=p>.</span><span class=na>setSessionId</span><span class=p>(</span><span class=n>sessionId</span><span class=p>);</span>
</span><span id=__span-17-109><a id=__codelineno-17-109 name=__codelineno-17-109 href=#__codelineno-17-109></a><span class=w>        </span><span class=n>reopenSession</span><span class=p>(</span><span class=n>cnxn</span><span class=p>,</span><span class=w> </span><span class=n>sessionId</span><span class=p>,</span><span class=w> </span><span class=n>passwd</span><span class=p>,</span><span class=w> </span><span class=n>sessionTimeout</span><span class=p>);</span>
</span><span id=__span-17-110><a id=__codelineno-17-110 name=__codelineno-17-110 href=#__codelineno-17-110></a><span class=w>        </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>CONNECTION_REVALIDATE_COUNT</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-17-111><a id=__codelineno-17-111 name=__codelineno-17-111 href=#__codelineno-17-111></a>
</span><span id=__span-17-112><a id=__codelineno-17-112 name=__codelineno-17-112 href=#__codelineno-17-112></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-113><a id=__codelineno-17-113 name=__codelineno-17-113 href=#__codelineno-17-113></a><span class=p>}</span>
</span><span id=__span-17-114><a id=__codelineno-17-114 name=__codelineno-17-114 href=#__codelineno-17-114></a>
</span><span id=__span-17-115><a id=__codelineno-17-115 name=__codelineno-17-115 href=#__codelineno-17-115></a>
</span><span id=__span-17-116><a id=__codelineno-17-116 name=__codelineno-17-116 href=#__codelineno-17-116></a><span class=err>####</span>
</span><span id=__span-17-117><a id=__codelineno-17-117 name=__codelineno-17-117 href=#__codelineno-17-117></a><span class=n>åˆ›å»ºä¼šè¯ä¸æäº¤ä¼šè¯</span><span class=w> </span><span class=n>createSession</span>
</span><span id=__span-17-118><a id=__codelineno-17-118 name=__codelineno-17-118 href=#__codelineno-17-118></a>
</span><span id=__span-17-119><a id=__codelineno-17-119 name=__codelineno-17-119 href=#__codelineno-17-119></a><span class=c1>//åˆ›å»ºsessionä»£ç </span>
</span><span id=__span-17-120><a id=__codelineno-17-120 name=__codelineno-17-120 href=#__codelineno-17-120></a><span class=kt>long</span><span class=w> </span><span class=nf>createSession</span><span class=p>(</span><span class=n>ServerCnxn</span><span class=w> </span><span class=n>cnxn</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>passwd</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>timeout</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-121><a id=__codelineno-17-121 name=__codelineno-17-121 href=#__codelineno-17-121></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>passwd</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-122><a id=__codelineno-17-122 name=__codelineno-17-122 href=#__codelineno-17-122></a><span class=w>        </span><span class=c1>// Possible since it&#39;s just deserialized from a packet on the wire.</span>
</span><span id=__span-17-123><a id=__codelineno-17-123 name=__codelineno-17-123 href=#__codelineno-17-123></a><span class=w>        </span><span class=n>passwd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>;</span>
</span><span id=__span-17-124><a id=__codelineno-17-124 name=__codelineno-17-124 href=#__codelineno-17-124></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-125><a id=__codelineno-17-125 name=__codelineno-17-125 href=#__codelineno-17-125></a><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>sessionId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sessionTracker</span><span class=p>.</span><span class=na>createSession</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span>
</span><span id=__span-17-126><a id=__codelineno-17-126 name=__codelineno-17-126 href=#__codelineno-17-126></a><span class=w>    </span><span class=n>Random</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>(</span><span class=n>sessionId</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>superSecret</span><span class=p>);</span>
</span><span id=__span-17-127><a id=__codelineno-17-127 name=__codelineno-17-127 href=#__codelineno-17-127></a><span class=w>    </span><span class=n>r</span><span class=p>.</span><span class=na>nextBytes</span><span class=p>(</span><span class=n>passwd</span><span class=p>);</span>
</span><span id=__span-17-128><a id=__codelineno-17-128 name=__codelineno-17-128 href=#__codelineno-17-128></a><span class=w>    </span><span class=n>ByteBuffer</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ByteBuffer</span><span class=p>.</span><span class=na>allocate</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span><span id=__span-17-129><a id=__codelineno-17-129 name=__codelineno-17-129 href=#__codelineno-17-129></a><span class=w>    </span><span class=n>to</span><span class=p>.</span><span class=na>putInt</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span>
</span><span id=__span-17-130><a id=__codelineno-17-130 name=__codelineno-17-130 href=#__codelineno-17-130></a><span class=w>    </span><span class=n>cnxn</span><span class=p>.</span><span class=na>setSessionId</span><span class=p>(</span><span class=n>sessionId</span><span class=p>);</span>
</span><span id=__span-17-131><a id=__codelineno-17-131 name=__codelineno-17-131 href=#__codelineno-17-131></a><span class=w>    </span><span class=n>Request</span><span class=w> </span><span class=n>si</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Request</span><span class=p>(</span><span class=n>cnxn</span><span class=p>,</span><span class=w> </span><span class=n>sessionId</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>OpCode</span><span class=p>.</span><span class=na>createSession</span><span class=p>,</span><span class=w> </span><span class=n>to</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span>
</span><span id=__span-17-132><a id=__codelineno-17-132 name=__codelineno-17-132 href=#__codelineno-17-132></a><span class=c1>//få°è£…sessionä¿¡æ¯è¯·æ±‚æäº¤è¯·æ±‚</span>
</span><span id=__span-17-133><a id=__codelineno-17-133 name=__codelineno-17-133 href=#__codelineno-17-133></a><span class=w>    </span><span class=n>submitRequest</span><span class=p>(</span><span class=n>si</span><span class=p>);</span>
</span><span id=__span-17-134><a id=__codelineno-17-134 name=__codelineno-17-134 href=#__codelineno-17-134></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>sessionId</span><span class=p>;</span>
</span><span id=__span-17-135><a id=__codelineno-17-135 name=__codelineno-17-135 href=#__codelineno-17-135></a><span class=p>}</span>
</span></code></pre></div> <h3 id=session><strong>åˆå§‹åŒ–Session</strong><a class=headerlink href=#session title="Permanent link">&para;</a></h3> <div class="language-java highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=n>ZookeeperæœåŠ¡å™¨ä½¿ç”¨SessionTrackerImplæ¥åˆ›å»ºsessionid</span><span class=err>ï¼Œ</span><span class=n>sessionidæ¯æ¬¡é€’å¢1</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=kd>public</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>createSession</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>sessionTimeout</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>sessionId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nextSessionId</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>();</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=w>    </span><span class=n>trackSession</span><span class=p>(</span><span class=n>sessionId</span><span class=p>,</span><span class=w> </span><span class=n>sessionTimeout</span><span class=p>);</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>sessionId</span><span class=p>;</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=p>}</span>
</span></code></pre></div> <div class="language-java highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=c1>//è¿™é‡Œåˆå§‹åŒ–çš„nextSessionIdæ˜¯ï¼š</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>initializeNextSessionId</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>nextSid</span><span class=p>;</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=w>    </span><span class=n>nextSid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Time</span><span class=p>.</span><span class=na>currentElapsedTime</span><span class=p>()</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>24</span><span class=p>)</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=mi>8</span><span class=p>;</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=w>    </span><span class=n>nextSid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nextSid</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>56</span><span class=p>);</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nextSid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>EphemeralType</span><span class=p>.</span><span class=na>CONTAINER_EPHEMERAL_OWNER</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=w>        </span><span class=o>++</span><span class=n>nextSid</span><span class=p>;</span><span class=w>  </span><span class=c1>// this is an unlikely edge case, but check it just in case</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>nextSid</span><span class=p>;</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=p>}</span>
</span></code></pre></div> <h4 id=_3><strong>è·Ÿè¸ªä¼šè¯è¿‡æœŸæ—¶é—´</strong><a class=headerlink href=#_3 title="Permanent link">&para;</a></h4> <div class="language-java highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=c1>//è·Ÿè¸ªsessionçš„è¿‡æœŸæ—¶é—´</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=nd>@Override</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>trackSession</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>sessionTimeout</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>added</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=w>    </span><span class=n>SessionImpl</span><span class=w> </span><span class=n>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sessionsById</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>id</span><span class=p>);</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>session</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=w>        </span><span class=n>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SessionImpl</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>sessionTimeout</span><span class=p>);</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a><span class=w>    </span><span class=c1>// findbugs2.0.3 complains about get after put.</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a><span class=w>    </span><span class=c1>// long term strategy would be use computeIfAbsent after JDK 1.8</span>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a><span class=c1>//å°†sessionidä¸sessionå¯¹è±¡æ˜ å°„å…³ç³»å­˜å…¥æœ¬åœ°sessionsById Mapç¼“å­˜å¯¹è±¡ä¸­</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14 href=#__codelineno-20-14></a><span class=w>    </span><span class=n>SessionImpl</span><span class=w> </span><span class=n>existedSession</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sessionsById</span><span class=p>.</span><span class=na>putIfAbsent</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>session</span><span class=p>);</span>
</span><span id=__span-20-15><a id=__codelineno-20-15 name=__codelineno-20-15 href=#__codelineno-20-15></a>
</span><span id=__span-20-16><a id=__codelineno-20-16 name=__codelineno-20-16 href=#__codelineno-20-16></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>existedSession</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-17><a id=__codelineno-20-17 name=__codelineno-20-17 href=#__codelineno-20-17></a><span class=w>        </span><span class=n>session</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>existedSession</span><span class=p>;</span>
</span><span id=__span-20-18><a id=__codelineno-20-18 name=__codelineno-20-18 href=#__codelineno-20-18></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-19><a id=__codelineno-20-19 name=__codelineno-20-19 href=#__codelineno-20-19></a><span class=w>        </span><span class=n>added</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-20-20><a id=__codelineno-20-20 name=__codelineno-20-20 href=#__codelineno-20-20></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&quot;Adding session 0x{}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>toHexString</span><span class=p>(</span><span class=n>id</span><span class=p>));</span>
</span><span id=__span-20-21><a id=__codelineno-20-21 name=__codelineno-20-21 href=#__codelineno-20-21></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-20-22><a id=__codelineno-20-22 name=__codelineno-20-22 href=#__codelineno-20-22></a>
</span><span id=__span-20-23><a id=__codelineno-20-23 name=__codelineno-20-23 href=#__codelineno-20-23></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>LOG</span><span class=p>.</span><span class=na>isTraceEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-20-24><a id=__codelineno-20-24 name=__codelineno-20-24 href=#__codelineno-20-24></a><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>actionStr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>added</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s>&quot;Adding&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&quot;Existing&quot;</span><span class=p>;</span>
</span><span id=__span-20-25><a id=__codelineno-20-25 name=__codelineno-20-25 href=#__codelineno-20-25></a><span class=w>        </span><span class=n>ZooTrace</span><span class=p>.</span><span class=na>logTraceMessage</span><span class=p>(</span>
</span><span id=__span-20-26><a id=__codelineno-20-26 name=__codelineno-20-26 href=#__codelineno-20-26></a><span class=w>                </span><span class=n>LOG</span><span class=p>,</span>
</span><span id=__span-20-27><a id=__codelineno-20-27 name=__codelineno-20-27 href=#__codelineno-20-27></a><span class=w>                </span><span class=n>ZooTrace</span><span class=p>.</span><span class=na>SESSION_TRACE_MASK</span><span class=p>,</span>
</span><span id=__span-20-28><a id=__codelineno-20-28 name=__codelineno-20-28 href=#__codelineno-20-28></a><span class=w>                </span><span class=s>&quot;SessionTrackerImpl --- &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>actionStr</span>
</span><span id=__span-20-29><a id=__codelineno-20-29 name=__codelineno-20-29 href=#__codelineno-20-29></a><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&quot; session 0x&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Long</span><span class=p>.</span><span class=na>toHexString</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>sessionTimeout</span><span class=p>);</span>
</span><span id=__span-20-30><a id=__codelineno-20-30 name=__codelineno-20-30 href=#__codelineno-20-30></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-20-31><a id=__codelineno-20-31 name=__codelineno-20-31 href=#__codelineno-20-31></a>
</span><span id=__span-20-32><a id=__codelineno-20-32 name=__codelineno-20-32 href=#__codelineno-20-32></a><span class=w>    </span><span class=n>updateSessionExpiry</span><span class=p>(</span><span class=n>session</span><span class=p>,</span><span class=w> </span><span class=n>sessionTimeout</span><span class=p>);</span>
</span><span id=__span-20-33><a id=__codelineno-20-33 name=__codelineno-20-33 href=#__codelineno-20-33></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>added</span><span class=p>;</span>
</span><span id=__span-20-34><a id=__codelineno-20-34 name=__codelineno-20-34 href=#__codelineno-20-34></a><span class=p>}</span>
</span></code></pre></div> <div class="language-java highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=c1>//å°†å¯¹åº”sessionå¯¹è±¡çš„è¿‡æœŸæ—¶é—´å­˜å…¥sessionExpiryQueue</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updateSessionExpiry</span><span class=p>(</span><span class=n>SessionImpl</span><span class=w> </span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>timeout</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=w>    </span><span class=n>logTraceTouchSession</span><span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=na>sessionId</span><span class=p>,</span><span class=w> </span><span class=n>timeout</span><span class=p>,</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=p>);</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=w>    </span><span class=n>sessionExpiryQueue</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>timeout</span><span class=p>);</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=p>}</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=n>sessionExpiryQueuedçš„updateæ–¹æ³•</span><span class=err>ï¼Œ</span><span class=n>ä»¥tickTimeä¸ºå•ä½å°†è¿‡æœŸæ—¶é—´æ”¾å…¥æ¡¶é›†åˆä¸­</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>update</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>elem</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>timeout</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=n>prevExpiryTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>elemMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>elem</span><span class=p>);</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Time</span><span class=p>.</span><span class=na>currentElapsedTime</span><span class=p>();</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=w>    </span><span class=n>Long</span><span class=w> </span><span class=n>newExpiryTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>roundToNextInterval</span><span class=p>(</span><span class=n>now</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>timeout</span><span class=p>);</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>newExpiryTime</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>prevExpiryTime</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=w>        </span><span class=c1>// No change, so nothing to update</span>
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-21-17><a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-21-18><a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a>
</span><span id=__span-21-19><a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a><span class=w>    </span><span class=c1>// First add the elem to the new expiry time bucket in expiryMap.</span>
</span><span id=__span-21-20><a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a><span class=c1>// expiryMapä¸ºè¿‡æœŸæ—¶é—´æ˜ å°„å…ƒç´ é›†åˆçš„Mapï¼Œkeyä¸ºå•ä½è¿‡æœŸæ—¶é—´ï¼Œvalueä¸ºå½“å‰è¿‡æœŸæ—¶é—´å¯¹åº”çš„é›†åˆ</span>
</span><span id=__span-21-21><a id=__codelineno-21-21 name=__codelineno-21-21 href=#__codelineno-21-21></a><span class=w>    </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>set</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>expiryMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>newExpiryTime</span><span class=p>);</span>
</span><span id=__span-21-22><a id=__codelineno-21-22 name=__codelineno-21-22 href=#__codelineno-21-22></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>set</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-23><a id=__codelineno-21-23 name=__codelineno-21-23 href=#__codelineno-21-23></a><span class=w>        </span><span class=c1>// Construct a ConcurrentHashSet using a ConcurrentHashMap</span>
</span><span id=__span-21-24><a id=__codelineno-21-24 name=__codelineno-21-24 href=#__codelineno-21-24></a><span class=w>        </span><span class=n>set</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Collections</span><span class=p>.</span><span class=na>newSetFromMap</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>E</span><span class=p>,</span><span class=w> </span><span class=n>Boolean</span><span class=o>&gt;</span><span class=p>());</span>
</span><span id=__span-21-25><a id=__codelineno-21-25 name=__codelineno-21-25 href=#__codelineno-21-25></a><span class=w>        </span><span class=c1>// Put the new set in the map, but only if another thread</span>
</span><span id=__span-21-26><a id=__codelineno-21-26 name=__codelineno-21-26 href=#__codelineno-21-26></a><span class=w>        </span><span class=c1>// hasn&#39;t beaten us to it</span>
</span><span id=__span-21-27><a id=__codelineno-21-27 name=__codelineno-21-27 href=#__codelineno-21-27></a><span class=w>        </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>existingSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>expiryMap</span><span class=p>.</span><span class=na>putIfAbsent</span><span class=p>(</span><span class=n>newExpiryTime</span><span class=p>,</span><span class=w> </span><span class=n>set</span><span class=p>);</span>
</span><span id=__span-21-28><a id=__codelineno-21-28 name=__codelineno-21-28 href=#__codelineno-21-28></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>existingSet</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-29><a id=__codelineno-21-29 name=__codelineno-21-29 href=#__codelineno-21-29></a><span class=w>            </span><span class=n>set</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>existingSet</span><span class=p>;</span>
</span><span id=__span-21-30><a id=__codelineno-21-30 name=__codelineno-21-30 href=#__codelineno-21-30></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-21-31><a id=__codelineno-21-31 name=__codelineno-21-31 href=#__codelineno-21-31></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-21-32><a id=__codelineno-21-32 name=__codelineno-21-32 href=#__codelineno-21-32></a><span class=c1>//å­˜å…¥å½“å‰è¿‡æœŸæ—¶é—´å¯¹åº”çš„é›†åˆä¸­</span>
</span><span id=__span-21-33><a id=__codelineno-21-33 name=__codelineno-21-33 href=#__codelineno-21-33></a><span class=w>    </span><span class=n>set</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>elem</span><span class=p>);</span>
</span><span id=__span-21-34><a id=__codelineno-21-34 name=__codelineno-21-34 href=#__codelineno-21-34></a>
</span><span id=__span-21-35><a id=__codelineno-21-35 name=__codelineno-21-35 href=#__codelineno-21-35></a><span class=w>    </span><span class=c1>// Map the elem to the new expiry time. If a different previous</span>
</span><span id=__span-21-36><a id=__codelineno-21-36 name=__codelineno-21-36 href=#__codelineno-21-36></a><span class=w>    </span><span class=c1>// mapping was present, clean up the previous expiry bucket.</span>
</span><span id=__span-21-37><a id=__codelineno-21-37 name=__codelineno-21-37 href=#__codelineno-21-37></a><span class=c1>//</span>
</span><span id=__span-21-38><a id=__codelineno-21-38 name=__codelineno-21-38 href=#__codelineno-21-38></a><span class=w>    </span><span class=n>prevExpiryTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>elemMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>elem</span><span class=p>,</span><span class=w> </span><span class=n>newExpiryTime</span><span class=p>);</span>
</span><span id=__span-21-39><a id=__codelineno-21-39 name=__codelineno-21-39 href=#__codelineno-21-39></a><span class=c1>//å¦‚æœä¹‹å‰çš„è¿‡æœŸæ—¶é—´å¯¹åº”çš„å…ƒç´ å­˜åœ¨åˆ™ç§»é™¤è€æ•°æ®ä¿è¯æ•°æ®æ­£å¸¸åˆ·æ–°</span>
</span><span id=__span-21-40><a id=__codelineno-21-40 name=__codelineno-21-40 href=#__codelineno-21-40></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prevExpiryTime</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>newExpiryTime</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>prevExpiryTime</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-41><a id=__codelineno-21-41 name=__codelineno-21-41 href=#__codelineno-21-41></a><span class=w>        </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>prevSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>expiryMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>prevExpiryTime</span><span class=p>);</span>
</span><span id=__span-21-42><a id=__codelineno-21-42 name=__codelineno-21-42 href=#__codelineno-21-42></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prevSet</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-43><a id=__codelineno-21-43 name=__codelineno-21-43 href=#__codelineno-21-43></a><span class=w>            </span><span class=n>prevSet</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>elem</span><span class=p>);</span>
</span><span id=__span-21-44><a id=__codelineno-21-44 name=__codelineno-21-44 href=#__codelineno-21-44></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-21-45><a id=__codelineno-21-45 name=__codelineno-21-45 href=#__codelineno-21-45></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-21-46><a id=__codelineno-21-46 name=__codelineno-21-46 href=#__codelineno-21-46></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>newExpiryTime</span><span class=p>;</span>
</span><span id=__span-21-47><a id=__codelineno-21-47 name=__codelineno-21-47 href=#__codelineno-21-47></a><span class=p>}</span>
</span></code></pre></div> <h4 id=_4><strong>æäº¤ä¼šè¯</strong><a class=headerlink href=#_4 title="Permanent link">&para;</a></h4> <p>ZookeeperServeræäº¤sessionè¯·æ±‚submitRequest <div class="language-java highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>submitRequest</span><span class=p>(</span><span class=n>Request</span><span class=w> </span><span class=n>si</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=w>    </span><span class=n>enqueueRequest</span><span class=p>(</span><span class=n>si</span><span class=p>);</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=p>}</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>enqueueRequest</span><span class=p>(</span><span class=n>Request</span><span class=w> </span><span class=n>si</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requestThrottler</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a><span class=w>                </span><span class=c1>// Since all requests are passed to the request</span>
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a><span class=w>                </span><span class=c1>// processor it should wait for setting up the request</span>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a><span class=w>                </span><span class=c1>// processor chain. The state will be updated to RUNNING</span>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a><span class=w>                </span><span class=c1>// after the setup.</span>
</span><span id=__span-22-13><a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>INITIAL</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-14><a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a><span class=w>                    </span><span class=n>wait</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
</span><span id=__span-22-15><a id=__codelineno-22-15 name=__codelineno-22-15 href=#__codelineno-22-15></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-22-16><a id=__codelineno-22-16 name=__codelineno-22-16 href=#__codelineno-22-16></a><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-17><a id=__codelineno-22-17 name=__codelineno-22-17 href=#__codelineno-22-17></a><span class=w>                </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Unexpected interruption&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-22-18><a id=__codelineno-22-18 name=__codelineno-22-18 href=#__codelineno-22-18></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-22-19><a id=__codelineno-22-19 name=__codelineno-22-19 href=#__codelineno-22-19></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requestThrottler</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-20><a id=__codelineno-22-20 name=__codelineno-22-20 href=#__codelineno-22-20></a><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&quot;Not started&quot;</span><span class=p>);</span>
</span><span id=__span-22-21><a id=__codelineno-22-21 name=__codelineno-22-21 href=#__codelineno-22-21></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-22-22><a id=__codelineno-22-22 name=__codelineno-22-22 href=#__codelineno-22-22></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-22-23><a id=__codelineno-22-23 name=__codelineno-22-23 href=#__codelineno-22-23></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-22-24><a id=__codelineno-22-24 name=__codelineno-22-24 href=#__codelineno-22-24></a><span class=w>    </span><span class=n>requestThrottler</span><span class=p>.</span><span class=na>submitRequest</span><span class=p>(</span><span class=n>si</span><span class=p>);</span>
</span><span id=__span-22-25><a id=__codelineno-22-25 name=__codelineno-22-25 href=#__codelineno-22-25></a><span class=p>}</span>
</span><span id=__span-22-26><a id=__codelineno-22-26 name=__codelineno-22-26 href=#__codelineno-22-26></a>
</span><span id=__span-22-27><a id=__codelineno-22-27 name=__codelineno-22-27 href=#__codelineno-22-27></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>submitRequest</span><span class=p>(</span><span class=n>Request</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-28><a id=__codelineno-22-28 name=__codelineno-22-28 href=#__codelineno-22-28></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stopping</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-29><a id=__codelineno-22-29 name=__codelineno-22-29 href=#__codelineno-22-29></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&quot;Shutdown in progress. Request cannot be processed&quot;</span><span class=p>);</span>
</span><span id=__span-22-30><a id=__codelineno-22-30 name=__codelineno-22-30 href=#__codelineno-22-30></a><span class=w>        </span><span class=n>dropRequest</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
</span><span id=__span-22-31><a id=__codelineno-22-31 name=__codelineno-22-31 href=#__codelineno-22-31></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-32><a id=__codelineno-22-32 name=__codelineno-22-32 href=#__codelineno-22-32></a><span class=w>        </span><span class=n>submittedRequests</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
</span><span id=__span-22-33><a id=__codelineno-22-33 name=__codelineno-22-33 href=#__codelineno-22-33></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-22-34><a id=__codelineno-22-34 name=__codelineno-22-34 href=#__codelineno-22-34></a><span class=p>}</span>
</span></code></pre></div></p> <p>submittedRequestsä¸ºLinkedBlockingQueueç±»å‹çš„è¯·æ±‚é˜Ÿåˆ—</p> <p>é‚£è¢«æ”¾åˆ°é˜Ÿåˆ—ä¸­çš„è¯·æ±‚æ¥ä¸‹æ¥æ˜¯å¦‚ä½•å¤„ç†å‘¢ï¼š Zookeeperä½¿ç”¨äº†é˜Ÿåˆ—+å¼‚æ­¥çš„æ¨¡å‹ï¼šè¯·æ±‚é“¾å¦‚ä¸‹ï¼š</p> <ul> <li><strong>æäº¤è¯·æ±‚ï¼š</strong> RequestThrottler.run()&gt;Zookeeper.submitRequestNow(Request si)&gt;</li> <li><strong>é¢„å¤„ç†è¯·æ±‚ï¼š</strong> PrepRequestProcessor.processRequest(Request request)</li> <li><strong>è¯·æ±‚æŒä¹…åŒ–ï¼š</strong> SyncReuqestProcessor .run</li> <li><strong>å¤„ç†è¯·æ±‚çš„ä¸šåŠ¡ï¼š</strong> FinalRequestProcessor. processTxn</li> </ul> <h4 id=_5><strong>æäº¤è¯·æ±‚å¤„ç†</strong><a class=headerlink href=#_5 title="Permanent link">&para;</a></h4> <p>å…·ä½“çš„è¯·æ±‚è¯¦æƒ…åˆ°åé¢å†çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬å°±çœ‹å®Œäº†ZookeeperServerä¸­çš„readConnectRequestæ–¹æ³•</p> <p>æ¥ä¸‹æ¥å¯ä»¥çœ‹ä¸‹Zookeeperæ˜¯å¦‚ä½•å¤„ç†åº¦è¯·æ±‚çš„ Zookeeperçš„è¯»è¯·æ±‚å¤„ç†NIOServerCnxnç±»ä¸­çš„readRequest() è°ƒç”¨äº†ZookeeperServerä¸­çš„processPacketæ–¹æ³•</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>readRequest</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=w>    </span><span class=n>zkServer</span><span class=p>.</span><span class=na>processPacket</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>incomingBuffer</span><span class=p>);</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=p>}</span>
</span></code></pre></div> <h3 id=processpacket><strong>processPacket</strong><a class=headerlink href=#processpacket title="Permanent link">&para;</a></h3> <p>å¦‚ä½•å¤„ç†æ•°æ®åŒ…å‘¢å¯ä»¥çœ‹å¦‚ä¸‹ä»£ç ï¼š</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processPacket</span><span class=p>(</span><span class=n>ServerCnxn</span><span class=w> </span><span class=n>cnxn</span><span class=p>,</span><span class=w> </span><span class=n>ByteBuffer</span><span class=w> </span><span class=n>incomingBuffer</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=w>    </span><span class=c1>// We have the request, now process and setup for next</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=c1>//ä½¿ç”¨juteååºåˆ—åŒ–å¯¹è±¡</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=w>    </span><span class=n>InputStream</span><span class=w> </span><span class=n>bais</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ByteBufferInputStream</span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>);</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=w>    </span><span class=n>BinaryInputArchive</span><span class=w> </span><span class=n>bia</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BinaryInputArchive</span><span class=p>.</span><span class=na>getArchive</span><span class=p>(</span><span class=n>bais</span><span class=p>);</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=w>    </span><span class=n>RequestHeader</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RequestHeader</span><span class=p>();</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=w>    </span><span class=n>h</span><span class=p>.</span><span class=na>deserialize</span><span class=p>(</span><span class=n>bia</span><span class=p>,</span><span class=w> </span><span class=s>&quot;header&quot;</span><span class=p>);</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=w>    </span><span class=c1>// Need to increase the outstanding request count first, otherwise</span>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=w>    </span><span class=c1>// there might be a race condition that it enabled recv after</span>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=w>    </span><span class=c1>// processing request and then disabled when check throttling.</span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=w>    </span><span class=c1>//</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=w>    </span><span class=c1>// Be aware that we&#39;re actually checking the global outstanding</span>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=w>    </span><span class=c1>// request before this request.</span>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=w>    </span><span class=c1>//</span>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=w>    </span><span class=c1>// It&#39;s fine if the IOException thrown before we decrease the count</span>
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=w>    </span><span class=c1>// in cnxn, since it will close the cnxn anyway.</span>
</span><span id=__span-24-18><a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a><span class=w>    </span><span class=n>cnxn</span><span class=p>.</span><span class=na>incrOutstandingAndCheckThrottle</span><span class=p>(</span><span class=n>h</span><span class=p>);</span>
</span><span id=__span-24-19><a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a>
</span><span id=__span-24-20><a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a><span class=w>    </span><span class=c1>// Through the magic of byte buffers, txn will not be</span>
</span><span id=__span-24-21><a id=__codelineno-24-21 name=__codelineno-24-21 href=#__codelineno-24-21></a><span class=w>    </span><span class=c1>// pointing</span>
</span><span id=__span-24-22><a id=__codelineno-24-22 name=__codelineno-24-22 href=#__codelineno-24-22></a><span class=w>    </span><span class=c1>// to the start of the txn ä»å½“å‰å¾…è¯»å–ä½ç½®ç”Ÿæˆæ–°çš„åªè¯»Buffer</span>
</span><span id=__span-24-23><a id=__codelineno-24-23 name=__codelineno-24-23 href=#__codelineno-24-23></a><span class=w>    </span><span class=n>incomingBuffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>slice</span><span class=p>();</span>
</span><span id=__span-24-24><a id=__codelineno-24-24 name=__codelineno-24-24 href=#__codelineno-24-24></a><span class=w>    </span><span class=c1>//å¦‚æœå½“å‰è¯·æ±‚æ˜¯è®¤è¯æˆæƒè¯·æ±‚</span>
</span><span id=__span-24-25><a id=__codelineno-24-25 name=__codelineno-24-25 href=#__codelineno-24-25></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=p>.</span><span class=na>getType</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>OpCode</span><span class=p>.</span><span class=na>auth</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-26><a id=__codelineno-24-26 name=__codelineno-24-26 href=#__codelineno-24-26></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&quot;got auth packet {}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>cnxn</span><span class=p>.</span><span class=na>getRemoteSocketAddress</span><span class=p>());</span>
</span><span id=__span-24-27><a id=__codelineno-24-27 name=__codelineno-24-27 href=#__codelineno-24-27></a><span class=w>        </span><span class=n>AuthPacket</span><span class=w> </span><span class=n>authPacket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AuthPacket</span><span class=p>();</span>
</span><span id=__span-24-28><a id=__codelineno-24-28 name=__codelineno-24-28 href=#__codelineno-24-28></a><span class=w>        </span><span class=n>ByteBufferInputStream</span><span class=p>.</span><span class=na>byteBuffer2Record</span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>,</span><span class=w> </span><span class=n>authPacket</span><span class=p>);</span>
</span><span id=__span-24-29><a id=__codelineno-24-29 name=__codelineno-24-29 href=#__codelineno-24-29></a><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>scheme</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>authPacket</span><span class=p>.</span><span class=na>getScheme</span><span class=p>();</span>
</span><span id=__span-24-30><a id=__codelineno-24-30 name=__codelineno-24-30 href=#__codelineno-24-30></a><span class=w>        </span><span class=n>ServerAuthenticationProvider</span><span class=w> </span><span class=n>ap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ProviderRegistry</span><span class=p>.</span><span class=na>getServerProvider</span><span class=p>(</span><span class=n>scheme</span><span class=p>);</span>
</span><span id=__span-24-31><a id=__codelineno-24-31 name=__codelineno-24-31 href=#__codelineno-24-31></a><span class=w>        </span><span class=n>Code</span><span class=w> </span><span class=n>authReturn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>KeeperException</span><span class=p>.</span><span class=na>Code</span><span class=p>.</span><span class=na>AUTHFAILED</span><span class=p>;</span>
</span><span id=__span-24-32><a id=__codelineno-24-32 name=__codelineno-24-32 href=#__codelineno-24-32></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ap</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-33><a id=__codelineno-24-33 name=__codelineno-24-33 href=#__codelineno-24-33></a><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-34><a id=__codelineno-24-34 name=__codelineno-24-34 href=#__codelineno-24-34></a><span class=w>                </span><span class=c1>// handleAuthentication may close the connection, to allow the client to choose</span>
</span><span id=__span-24-35><a id=__codelineno-24-35 name=__codelineno-24-35 href=#__codelineno-24-35></a><span class=w>                </span><span class=c1>// a different server to connect to. å¤„ç†å®¢æˆ·ç«¯è®¤è¯</span>
</span><span id=__span-24-36><a id=__codelineno-24-36 name=__codelineno-24-36 href=#__codelineno-24-36></a><span class=w>                </span><span class=n>authReturn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ap</span><span class=p>.</span><span class=na>handleAuthentication</span><span class=p>(</span>
</span><span id=__span-24-37><a id=__codelineno-24-37 name=__codelineno-24-37 href=#__codelineno-24-37></a><span class=w>                        </span><span class=k>new</span><span class=w> </span><span class=n>ServerAuthenticationProvider</span><span class=p>.</span><span class=na>ServerObjs</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>cnxn</span><span class=p>),</span>
</span><span id=__span-24-38><a id=__codelineno-24-38 name=__codelineno-24-38 href=#__codelineno-24-38></a><span class=w>                        </span><span class=n>authPacket</span><span class=p>.</span><span class=na>getAuth</span><span class=p>());</span>
</span><span id=__span-24-39><a id=__codelineno-24-39 name=__codelineno-24-39 href=#__codelineno-24-39></a><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-40><a id=__codelineno-24-40 name=__codelineno-24-40 href=#__codelineno-24-40></a><span class=w>                </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Caught runtime exception from AuthenticationProvider: {}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>scheme</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-24-41><a id=__codelineno-24-41 name=__codelineno-24-41 href=#__codelineno-24-41></a><span class=w>                </span><span class=n>authReturn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>KeeperException</span><span class=p>.</span><span class=na>Code</span><span class=p>.</span><span class=na>AUTHFAILED</span><span class=p>;</span>
</span><span id=__span-24-42><a id=__codelineno-24-42 name=__codelineno-24-42 href=#__codelineno-24-42></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-24-43><a id=__codelineno-24-43 name=__codelineno-24-43 href=#__codelineno-24-43></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-24-44><a id=__codelineno-24-44 name=__codelineno-24-44 href=#__codelineno-24-44></a><span class=c1>//è®¤è¯æˆåŠŸåˆ™è¿”å›è®¤è¯æˆåŠŸçš„æ¶ˆæ¯        if (authReturn == KeeperException.Code.OK) {</span>
</span><span id=__span-24-45><a id=__codelineno-24-45 name=__codelineno-24-45 href=#__codelineno-24-45></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&quot;Authentication succeeded for scheme: {}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>scheme</span><span class=p>);</span>
</span><span id=__span-24-46><a id=__codelineno-24-46 name=__codelineno-24-46 href=#__codelineno-24-46></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&quot;auth success {}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>cnxn</span><span class=p>.</span><span class=na>getRemoteSocketAddress</span><span class=p>());</span>
</span><span id=__span-24-47><a id=__codelineno-24-47 name=__codelineno-24-47 href=#__codelineno-24-47></a><span class=w>        </span><span class=n>ReplyHeader</span><span class=w> </span><span class=n>rh</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReplyHeader</span><span class=p>(</span><span class=n>h</span><span class=p>.</span><span class=na>getXid</span><span class=p>(),</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>KeeperException</span><span class=p>.</span><span class=na>Code</span><span class=p>.</span><span class=na>OK</span><span class=p>.</span><span class=na>intValue</span><span class=p>());</span>
</span><span id=__span-24-48><a id=__codelineno-24-48 name=__codelineno-24-48 href=#__codelineno-24-48></a><span class=w>        </span><span class=n>cnxn</span><span class=p>.</span><span class=na>sendResponse</span><span class=p>(</span><span class=n>rh</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span>
</span><span id=__span-24-49><a id=__codelineno-24-49 name=__codelineno-24-49 href=#__codelineno-24-49></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-50><a id=__codelineno-24-50 name=__codelineno-24-50 href=#__codelineno-24-50></a><span class=c1>//è®¤è¯å¤±è´¥è¿”å›è®¤è¯å¤±è´¥çš„æ¶ˆæ¯ï¼ŒåŒæ—¶å…³é—­è¿æ¥</span>
</span><span id=__span-24-51><a id=__codelineno-24-51 name=__codelineno-24-51 href=#__codelineno-24-51></a>
</span><span id=__span-24-52><a id=__codelineno-24-52 name=__codelineno-24-52 href=#__codelineno-24-52></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ap</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-53><a id=__codelineno-24-53 name=__codelineno-24-53 href=#__codelineno-24-53></a><span class=w>            </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span>
</span><span id=__span-24-54><a id=__codelineno-24-54 name=__codelineno-24-54 href=#__codelineno-24-54></a><span class=w>                    </span><span class=s>&quot;No authentication provider for scheme: {} has {}&quot;</span><span class=p>,</span>
</span><span id=__span-24-55><a id=__codelineno-24-55 name=__codelineno-24-55 href=#__codelineno-24-55></a><span class=w>                    </span><span class=n>scheme</span><span class=p>,</span>
</span><span id=__span-24-56><a id=__codelineno-24-56 name=__codelineno-24-56 href=#__codelineno-24-56></a><span class=w>                    </span><span class=n>ProviderRegistry</span><span class=p>.</span><span class=na>listProviders</span><span class=p>());</span>
</span><span id=__span-24-57><a id=__codelineno-24-57 name=__codelineno-24-57 href=#__codelineno-24-57></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-58><a id=__codelineno-24-58 name=__codelineno-24-58 href=#__codelineno-24-58></a><span class=w>            </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Authentication failed for scheme: {}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>scheme</span><span class=p>);</span>
</span><span id=__span-24-59><a id=__codelineno-24-59 name=__codelineno-24-59 href=#__codelineno-24-59></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-24-60><a id=__codelineno-24-60 name=__codelineno-24-60 href=#__codelineno-24-60></a><span class=w>        </span><span class=c1>// send a response...</span>
</span><span id=__span-24-61><a id=__codelineno-24-61 name=__codelineno-24-61 href=#__codelineno-24-61></a><span class=w>        </span><span class=n>ReplyHeader</span><span class=w> </span><span class=n>rh</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReplyHeader</span><span class=p>(</span><span class=n>h</span><span class=p>.</span><span class=na>getXid</span><span class=p>(),</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>KeeperException</span><span class=p>.</span><span class=na>Code</span><span class=p>.</span><span class=na>AUTHFAILED</span><span class=p>.</span><span class=na>intValue</span><span class=p>());</span>
</span><span id=__span-24-62><a id=__codelineno-24-62 name=__codelineno-24-62 href=#__codelineno-24-62></a><span class=w>        </span><span class=n>cnxn</span><span class=p>.</span><span class=na>sendResponse</span><span class=p>(</span><span class=n>rh</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span>
</span><span id=__span-24-63><a id=__codelineno-24-63 name=__codelineno-24-63 href=#__codelineno-24-63></a><span class=w>        </span><span class=c1>// ... and close connection</span>
</span><span id=__span-24-64><a id=__codelineno-24-64 name=__codelineno-24-64 href=#__codelineno-24-64></a><span class=w>        </span><span class=n>cnxn</span><span class=p>.</span><span class=na>sendBuffer</span><span class=p>(</span><span class=n>ServerCnxnFactory</span><span class=p>.</span><span class=na>closeConn</span><span class=p>);</span>
</span><span id=__span-24-65><a id=__codelineno-24-65 name=__codelineno-24-65 href=#__codelineno-24-65></a><span class=w>        </span><span class=n>cnxn</span><span class=p>.</span><span class=na>disableRecv</span><span class=p>();</span>
</span><span id=__span-24-66><a id=__codelineno-24-66 name=__codelineno-24-66 href=#__codelineno-24-66></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-24-67><a id=__codelineno-24-67 name=__codelineno-24-67 href=#__codelineno-24-67></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-24-68><a id=__codelineno-24-68 name=__codelineno-24-68 href=#__codelineno-24-68></a><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=n>h</span><span class=p>.</span>
</span><span id=__span-24-69><a id=__codelineno-24-69 name=__codelineno-24-69 href=#__codelineno-24-69></a>
</span><span id=__span-24-70><a id=__codelineno-24-70 name=__codelineno-24-70 href=#__codelineno-24-70></a><span class=nf>getType</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=n>OpCode</span><span class=p>.</span><span class=na>sasl</span><span class=p>){</span>
</span><span id=__span-24-71><a id=__codelineno-24-71 name=__codelineno-24-71 href=#__codelineno-24-71></a>
</span><span id=__span-24-72><a id=__codelineno-24-72 name=__codelineno-24-72 href=#__codelineno-24-72></a><span class=c1>//å¤„ç†saslè®¤è¯</span>
</span><span id=__span-24-73><a id=__codelineno-24-73 name=__codelineno-24-73 href=#__codelineno-24-73></a><span class=n>processSasl</span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>,</span><span class=w> </span><span class=n>cnxn</span><span class=p>,</span><span class=w> </span><span class=n>h</span><span class=p>);</span>
</span><span id=__span-24-74><a id=__codelineno-24-74 name=__codelineno-24-74 href=#__codelineno-24-74></a><span class=w>    </span><span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span><span id=__span-24-75><a id=__codelineno-24-75 name=__codelineno-24-75 href=#__codelineno-24-75></a><span class=c1>//å¤„ç†è¯·æ±‚</span>
</span><span id=__span-24-76><a id=__codelineno-24-76 name=__codelineno-24-76 href=#__codelineno-24-76></a><span class=w>            </span><span class=k>if</span><span class=p>(</span>
</span><span id=__span-24-77><a id=__codelineno-24-77 name=__codelineno-24-77 href=#__codelineno-24-77></a>
</span><span id=__span-24-78><a id=__codelineno-24-78 name=__codelineno-24-78 href=#__codelineno-24-78></a><span class=n>shouldRequireClientSaslAuth</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;!</span>
</span><span id=__span-24-79><a id=__codelineno-24-79 name=__codelineno-24-79 href=#__codelineno-24-79></a>
</span><span id=__span-24-80><a id=__codelineno-24-80 name=__codelineno-24-80 href=#__codelineno-24-80></a><span class=n>hasCnxSASLAuthenticated</span><span class=p>(</span><span class=n>cnxn</span><span class=p>)){</span>
</span><span id=__span-24-81><a id=__codelineno-24-81 name=__codelineno-24-81 href=#__codelineno-24-81></a><span class=c1>//å¦‚æœæ˜¯æœªè®¤è¯è¯·æ±‚åˆ™ç›´æ¥å…³é—­è¿æ¥</span>
</span><span id=__span-24-82><a id=__codelineno-24-82 name=__codelineno-24-82 href=#__codelineno-24-82></a><span class=n>ReplyHeader</span><span class=w> </span><span class=n>replyHeader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReplyHeader</span><span class=p>(</span><span class=n>h</span><span class=p>.</span><span class=na>getXid</span><span class=p>(),</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>Code</span><span class=p>.</span><span class=na>SESSIONCLOSEDREQUIRESASLAUTH</span><span class=p>.</span><span class=na>intValue</span><span class=p>());</span>
</span><span id=__span-24-83><a id=__codelineno-24-83 name=__codelineno-24-83 href=#__codelineno-24-83></a><span class=w>            </span><span class=n>cnxn</span><span class=p>.</span>
</span><span id=__span-24-84><a id=__codelineno-24-84 name=__codelineno-24-84 href=#__codelineno-24-84></a>
</span><span id=__span-24-85><a id=__codelineno-24-85 name=__codelineno-24-85 href=#__codelineno-24-85></a><span class=nf>sendResponse</span><span class=p>(</span><span class=n>replyHeader</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=s>&quot;response&quot;</span><span class=p>);</span>
</span><span id=__span-24-86><a id=__codelineno-24-86 name=__codelineno-24-86 href=#__codelineno-24-86></a><span class=w>            </span><span class=n>cnxn</span><span class=p>.</span>
</span><span id=__span-24-87><a id=__codelineno-24-87 name=__codelineno-24-87 href=#__codelineno-24-87></a>
</span><span id=__span-24-88><a id=__codelineno-24-88 name=__codelineno-24-88 href=#__codelineno-24-88></a><span class=nf>sendCloseSession</span><span class=p>();</span>
</span><span id=__span-24-89><a id=__codelineno-24-89 name=__codelineno-24-89 href=#__codelineno-24-89></a><span class=w>            </span><span class=n>cnxn</span><span class=p>.</span>
</span><span id=__span-24-90><a id=__codelineno-24-90 name=__codelineno-24-90 href=#__codelineno-24-90></a>
</span><span id=__span-24-91><a id=__codelineno-24-91 name=__codelineno-24-91 href=#__codelineno-24-91></a><span class=nf>disableRecv</span><span class=p>();</span>
</span><span id=__span-24-92><a id=__codelineno-24-92 name=__codelineno-24-92 href=#__codelineno-24-92></a><span class=w>        </span><span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span><span id=__span-24-93><a id=__codelineno-24-93 name=__codelineno-24-93 href=#__codelineno-24-93></a><span class=c1>//å¤„ç†è¯·æ±‚</span>
</span><span id=__span-24-94><a id=__codelineno-24-94 name=__codelineno-24-94 href=#__codelineno-24-94></a><span class=n>Request</span><span class=w> </span><span class=n>si</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Request</span><span class=p>(</span><span class=n>cnxn</span><span class=p>,</span><span class=w> </span><span class=n>cnxn</span><span class=p>.</span><span class=na>getSessionId</span><span class=p>(),</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>getXid</span><span class=p>(),</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>getType</span><span class=p>(),</span><span class=w> </span><span class=n>incomingBuffer</span><span class=p>,</span><span class=w> </span><span class=n>cnxn</span><span class=p>.</span><span class=na>getAuthInfo</span><span class=p>());</span>
</span><span id=__span-24-95><a id=__codelineno-24-95 name=__codelineno-24-95 href=#__codelineno-24-95></a><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>limit</span><span class=p>();</span>
</span><span id=__span-24-96><a id=__codelineno-24-96 name=__codelineno-24-96 href=#__codelineno-24-96></a><span class=c1>//æ£€æŸ¥æ˜¯å¦æ˜¯å¤§è¯·æ±‚ï¼Œé€šè¿‡å‚æ•°zookeeper.largeRequestThresholdé…ç½®, </span>
</span><span id=__span-24-97><a id=__codelineno-24-97 name=__codelineno-24-97 href=#__codelineno-24-97></a><span class=w>            </span><span class=k>if</span><span class=p>(</span>
</span><span id=__span-24-98><a id=__codelineno-24-98 name=__codelineno-24-98 href=#__codelineno-24-98></a>
</span><span id=__span-24-99><a id=__codelineno-24-99 name=__codelineno-24-99 href=#__codelineno-24-99></a><span class=n>isLargeRequest</span><span class=p>(</span><span class=n>length</span><span class=p>)){</span>
</span><span id=__span-24-100><a id=__codelineno-24-100 name=__codelineno-24-100 href=#__codelineno-24-100></a><span class=c1>// checkRequestSize will throw IOException if request is rejected</span>
</span><span id=__span-24-101><a id=__codelineno-24-101 name=__codelineno-24-101 href=#__codelineno-24-101></a><span class=n>å¦‚æœæ˜¯å¤§æ•°é‡ä¼ è¾“åˆ™åˆ¤æ–­æœ€å¤§è¯·æ±‚å­—èŠ‚å¤§å°é˜²æ­¢JVMå †å†…å­˜æº¢å‡º</span><span class=p>,</span>
</span><span id=__span-24-102><a id=__codelineno-24-102 name=__codelineno-24-102 href=#__codelineno-24-102></a>
</span><span id=__span-24-103><a id=__codelineno-24-103 name=__codelineno-24-103 href=#__codelineno-24-103></a><span class=n>è¿™ä¸ªé»˜è®¤å¤§å°æ˜¯100KBé€šè¿‡å‚æ•°zookeeper</span><span class=p>.</span><span class=na>largeRequestMaxBytesé…ç½®</span>
</span><span id=__span-24-104><a id=__codelineno-24-104 name=__codelineno-24-104 href=#__codelineno-24-104></a><span class=nf>checkRequestSizeWhenMessageReceived</span><span class=p>(</span><span class=n>length</span><span class=p>);</span>
</span><span id=__span-24-105><a id=__codelineno-24-105 name=__codelineno-24-105 href=#__codelineno-24-105></a><span class=w>                </span><span class=n>si</span><span class=p>.</span>
</span><span id=__span-24-106><a id=__codelineno-24-106 name=__codelineno-24-106 href=#__codelineno-24-106></a>
</span><span id=__span-24-107><a id=__codelineno-24-107 name=__codelineno-24-107 href=#__codelineno-24-107></a><span class=nf>setLargeRequestSize</span><span class=p>(</span><span class=n>length</span><span class=p>);</span>
</span><span id=__span-24-108><a id=__codelineno-24-108 name=__codelineno-24-108 href=#__codelineno-24-108></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-24-109><a id=__codelineno-24-109 name=__codelineno-24-109 href=#__codelineno-24-109></a><span class=w>                    </span><span class=n>si</span><span class=p>.</span>
</span><span id=__span-24-110><a id=__codelineno-24-110 name=__codelineno-24-110 href=#__codelineno-24-110></a>
</span><span id=__span-24-111><a id=__codelineno-24-111 name=__codelineno-24-111 href=#__codelineno-24-111></a><span class=nf>setOwner</span><span class=p>(</span><span class=n>ServerCnxn</span><span class=p>.</span><span class=na>me</span><span class=p>);</span>
</span><span id=__span-24-112><a id=__codelineno-24-112 name=__codelineno-24-112 href=#__codelineno-24-112></a>
</span><span id=__span-24-113><a id=__codelineno-24-113 name=__codelineno-24-113 href=#__codelineno-24-113></a><span class=c1>//æäº¤åŒ…è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚çš„å¤„ç†ä¸è¿æ¥è¯·æ±‚å‘èµ·çš„å¤„ç†æ˜¯ä¸€æ ·çš„ã€‚å…·ä½“ç»†èŠ‚å¯ä»¥çœ‹è¯·æ±‚ä»£ç </span>
</span><span id=__span-24-114><a id=__codelineno-24-114 name=__codelineno-24-114 href=#__codelineno-24-114></a><span class=n>submitRequest</span><span class=p>(</span><span class=n>si</span><span class=p>);</span>
</span><span id=__span-24-115><a id=__codelineno-24-115 name=__codelineno-24-115 href=#__codelineno-24-115></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-24-116><a id=__codelineno-24-116 name=__codelineno-24-116 href=#__codelineno-24-116></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-24-117><a id=__codelineno-24-117 name=__codelineno-24-117 href=#__codelineno-24-117></a><span class=w>                </span><span class=p>}</span>
</span></code></pre></div> <p>åœ¨accept thread çš„run()ä¸­,å…¶æ‰§è¡Œselector.select(),å¹¶è°ƒç”¨doAccept() æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥,å°†å…¶æ·»åŠ è‡³SelectorThread.acceptedQueue()</p> <h3 id=selector-thread><strong>selector thread</strong><a class=headerlink href=#selector-thread title="Permanent link">&para;</a></h3> <div class="language-java highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=nd>@Override</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stopped</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=w>                </span><span class=c1>//1.è°ƒç”¨select()è¯»å–å°±ç»ªçš„IOäº‹ä»¶,äº¤ç”±worker threadå¤„ç†</span>
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=w>                </span><span class=n>select</span><span class=p>();</span>
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=w>                </span><span class=c1>//2.å¤„ç†acceptçº¿ç¨‹æ–°åˆ†æ´¾çš„è¿æ¥,</span>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=w>                </span><span class=c1>// (1)å°†æ–°è¿æ¥æ³¨å†Œåˆ°selectorä¸Š;(2)åŒ…è£…ä¸ºNIOServerCnxnåæ³¨å†Œåˆ°NIOServerCnxnFactoryä¸­</span>
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=w>                </span><span class=n>processAcceptedConnections</span><span class=p>();</span>
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a><span class=w>                </span><span class=c1>//3.æ›´æ–°updateQueueä¸­è¿æ¥çš„ç›‘å¬äº‹ä»¶</span>
</span><span id=__span-25-12><a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=w>                </span><span class=n>processInterestOpsUpdateRequests</span><span class=p>();</span>
</span><span id=__span-25-13><a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-14><a id=__codelineno-25-14 name=__codelineno-25-14 href=#__codelineno-25-14></a><span class=w>                </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Ignoring unexpected runtime exception&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-25-15><a id=__codelineno-25-15 name=__codelineno-25-15 href=#__codelineno-25-15></a><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-16><a id=__codelineno-25-16 name=__codelineno-25-16 href=#__codelineno-25-16></a><span class=w>                </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Ignoring unexpected exception&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-25-17><a id=__codelineno-25-17 name=__codelineno-25-17 href=#__codelineno-25-17></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-25-18><a id=__codelineno-25-18 name=__codelineno-25-18 href=#__codelineno-25-18></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-25-19><a id=__codelineno-25-19 name=__codelineno-25-19 href=#__codelineno-25-19></a><span class=w>        </span><span class=c1>//æ‰§è¡Œæ¸…ç†æ“ä½œ,å…³é—­æ‰€æœ‰åœ¨selectorä¸Šç­‰å¾…çš„è¿æ¥</span>
</span><span id=__span-25-20><a id=__codelineno-25-20 name=__codelineno-25-20 href=#__codelineno-25-20></a><span class=w>                </span><span class=p>...</span>
</span><span id=__span-25-21><a id=__codelineno-25-21 name=__codelineno-25-21 href=#__codelineno-25-21></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-22><a id=__codelineno-25-22 name=__codelineno-25-22 href=#__codelineno-25-22></a><span class=w>                </span><span class=p>...</span>
</span><span id=__span-25-23><a id=__codelineno-25-23 name=__codelineno-25-23 href=#__codelineno-25-23></a><span class=w>        </span><span class=c1>//æ¸…ç†å·¥ä½œ</span>
</span><span id=__span-25-24><a id=__codelineno-25-24 name=__codelineno-25-24 href=#__codelineno-25-24></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-25-25><a id=__codelineno-25-25 name=__codelineno-25-25 href=#__codelineno-25-25></a><span class=p>}</span>
</span></code></pre></div> <p>åœ¨selector threadçš„run()ä¸­,ä¸»è¦æ‰§è¡Œ3ä»¶äº‹æƒ… - è°ƒç”¨select()è¯»å–å°±ç»ªçš„IOäº‹ä»¶,äº¤ç”±worker threadå¤„ç†(åœ¨äº¤ç”±worker thread å¤„ç†ä¹‹å‰ä¼šè°ƒç”¨key.interestOps(0)) - å¤„ç†acceptçº¿ç¨‹æ–°åˆ†æ´¾çš„è¿æ¥, - (1)å°†æ–°è¿æ¥æ³¨å†Œåˆ°selectorä¸Š; - (2)åŒ…è£…ä¸ºNIOServerCnxnåæ³¨å†Œåˆ°NIOServerCnxnFactoryä¸­ - æ›´æ–°updateQueueä¸­è¿æ¥çš„ç›‘å¬äº‹ä»¶</p> <p><strong>worker thread</strong> ZooKeeperä¸­é€šè¿‡WorkerServiceç®¡ç†ä¸€ç»„worker threadçº¿ç¨‹,å…¶æœ‰ä¸¤ç§ç®¡ç†æ¨¡å¼:</p> <table> <thead> <tr> <th><strong>æ¨¡å¼å</strong></th> <th><strong><em>è§£é‡Š</em></strong></th> <th>***ä½¿ç”¨åœºæ™¯**</th> <th><strong><em>å®ç°</em></strong></th> </tr> </thead> <tbody> <tr> <td>å¯æŒ‡å®šçº¿ç¨‹æ¨¡å¼</td> <td>å°†ä»»åŠ¡æŒ‡å®šç”±æŸä¸€çº¿ç¨‹å®Œæˆ,è‹¥ä¸€ç³»åˆ—ä»»åŠ¡éœ€æœ‰åºå®Œæˆ,å¯ä½¿ç”¨æ­¤ç§æ¨¡å¼,å°†éœ€æŒ‰åºå®Œæˆçš„ä»»åŠ¡æŒ‡å®šåˆ°åŒä¸€çº¿ç¨‹</td> <td>åŒä¸€ä¼šè¯ä¸‹çš„ä¸€ç³»åˆ—è¯·æ±‚</td> <td>ç”ŸæˆNä¸ªExecutorService,æ¯ä¸ªExecutorServiceåªåŒ…å«ä¸€ä¸ªçº¿ç¨‹</td> </tr> <tr> <td>ä¸å¯æŒ‡å®šçº¿ç¨‹æ¨¡å¼</td> <td>ä»»åŠ¡æäº¤å,ç”±WorkerServiceéšæœºæŒ‡å®šçº¿ç¨‹å®Œæˆ,ä»»åŠ¡ä¹‹é—´æ— é¡ºåºè¦æ±‚åˆ™ä½¿ç”¨è¯¥æ¨¡å¼</td> <td>æ‰§è¡Œç½‘ç»œIO</td> <td>ç”Ÿæˆ1ä¸ªExecutorService,å…¶ä¸­æœ‰Nä¸ªçº¿ç¨‹</td> </tr> </tbody> </table> <p>ç”±äºå„è¿æ¥çš„ç½‘ç»œIOä»»åŠ¡ä¹‹é—´æ— é¡ºåºè¦æ±‚,NIOServerCnxnFactoryä½¿ç”¨çš„WorkerServiceé‡‡ç”¨ä¸å¯æŒ‡å®šçº¿ç¨‹æ¨¡å¼.</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=w> </span><span class=cm>/**</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=cm> * Schedule work to be done by the thread assigned to this id. Thread</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=cm> * assignment is a single mod operation on the number of threads.  If a</span>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=cm> * worker thread pool is not being used, work is done directly by</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=cm> * this thread.</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=cm> * æ ¹æ®idå–æ¨¡å°†workRequeståˆ†é…ç»™å¯¹åº”çš„çº¿ç¨‹.å¦‚æœæ²¡æœ‰ä½¿ç”¨worker thread</span>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a><span class=cm> * (å³numWorkerThreads=0),åˆ™å¯åŠ¨ScheduledWorkRequestçº¿ç¨‹å®Œæˆä»»åŠ¡,å½“å‰</span>
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a><span class=cm> * çº¿ç¨‹é˜»å¡åˆ°ä»»åŠ¡å®Œæˆ.</span>
</span><span id=__span-26-9><a id=__codelineno-26-9 name=__codelineno-26-9 href=#__codelineno-26-9></a><span class=cm> *</span>
</span><span id=__span-26-10><a id=__codelineno-26-10 name=__codelineno-26-10 href=#__codelineno-26-10></a><span class=cm> * @param workRequest å¾…å¤„ç†çš„IOè¯·æ±‚</span>
</span><span id=__span-26-11><a id=__codelineno-26-11 name=__codelineno-26-11 href=#__codelineno-26-11></a><span class=cm> * @param id          æ ¹æ®æ­¤å€¼é€‰æ‹©ä½¿ç”¨å“ªä¸€ä¸ªthreadå¤„ç†workRequest</span>
</span><span id=__span-26-12><a id=__codelineno-26-12 name=__codelineno-26-12 href=#__codelineno-26-12></a><span class=cm> */</span>
</span><span id=__span-26-13><a id=__codelineno-26-13 name=__codelineno-26-13 href=#__codelineno-26-13></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>schedule</span><span class=p>(</span><span class=n>WorkRequest</span><span class=w> </span><span class=n>workRequest</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-14><a id=__codelineno-26-14 name=__codelineno-26-14 href=#__codelineno-26-14></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stopped</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-15><a id=__codelineno-26-15 name=__codelineno-26-15 href=#__codelineno-26-15></a><span class=w>        </span><span class=n>workRequest</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
</span><span id=__span-26-16><a id=__codelineno-26-16 name=__codelineno-26-16 href=#__codelineno-26-16></a><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-26-17><a id=__codelineno-26-17 name=__codelineno-26-17 href=#__codelineno-26-17></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-26-18><a id=__codelineno-26-18 name=__codelineno-26-18 href=#__codelineno-26-18></a>
</span><span id=__span-26-19><a id=__codelineno-26-19 name=__codelineno-26-19 href=#__codelineno-26-19></a><span class=w>    </span><span class=n>ScheduledWorkRequest</span><span class=w> </span><span class=n>scheduledWorkRequest</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-26-20><a id=__codelineno-26-20 name=__codelineno-26-20 href=#__codelineno-26-20></a><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>ScheduledWorkRequest</span><span class=p>(</span><span class=n>workRequest</span><span class=p>);</span>
</span><span id=__span-26-21><a id=__codelineno-26-21 name=__codelineno-26-21 href=#__codelineno-26-21></a>
</span><span id=__span-26-22><a id=__codelineno-26-22 name=__codelineno-26-22 href=#__codelineno-26-22></a><span class=w>    </span><span class=c1>// If we have a worker thread pool, use that; </span>
</span><span id=__span-26-23><a id=__codelineno-26-23 name=__codelineno-26-23 href=#__codelineno-26-23></a><span class=w>    </span><span class=c1>// otherwise, do the work directly.</span>
</span><span id=__span-26-24><a id=__codelineno-26-24 name=__codelineno-26-24 href=#__codelineno-26-24></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>workers</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
</span><span id=__span-26-25><a id=__codelineno-26-25 name=__codelineno-26-25 href=#__codelineno-26-25></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-26><a id=__codelineno-26-26 name=__codelineno-26-26 href=#__codelineno-26-26></a><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-27><a id=__codelineno-26-27 name=__codelineno-26-27 href=#__codelineno-26-27></a><span class=w>            </span><span class=c1>// make sure to map negative ids as well to [0, size-1]</span>
</span><span id=__span-26-28><a id=__codelineno-26-28 name=__codelineno-26-28 href=#__codelineno-26-28></a><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>workerNum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>size</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>size</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>size</span><span class=p>;</span>
</span><span id=__span-26-29><a id=__codelineno-26-29 name=__codelineno-26-29 href=#__codelineno-26-29></a><span class=w>            </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>worker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>workers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>workerNum</span><span class=p>);</span>
</span><span id=__span-26-30><a id=__codelineno-26-30 name=__codelineno-26-30 href=#__codelineno-26-30></a><span class=w>            </span><span class=n>worker</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>scheduledWorkRequest</span><span class=p>);</span>
</span><span id=__span-26-31><a id=__codelineno-26-31 name=__codelineno-26-31 href=#__codelineno-26-31></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RejectedExecutionException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-32><a id=__codelineno-26-32 name=__codelineno-26-32 href=#__codelineno-26-32></a><span class=w>            </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;ExecutorService rejected execution&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-26-33><a id=__codelineno-26-33 name=__codelineno-26-33 href=#__codelineno-26-33></a><span class=w>            </span><span class=n>workRequest</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
</span><span id=__span-26-34><a id=__codelineno-26-34 name=__codelineno-26-34 href=#__codelineno-26-34></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-26-35><a id=__codelineno-26-35 name=__codelineno-26-35 href=#__codelineno-26-35></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-36><a id=__codelineno-26-36 name=__codelineno-26-36 href=#__codelineno-26-36></a><span class=w>        </span><span class=c1>// When there is no worker thread pool, do the work directly</span>
</span><span id=__span-26-37><a id=__codelineno-26-37 name=__codelineno-26-37 href=#__codelineno-26-37></a><span class=w>        </span><span class=c1>// and wait for its completion</span>
</span><span id=__span-26-38><a id=__codelineno-26-38 name=__codelineno-26-38 href=#__codelineno-26-38></a><span class=w>        </span><span class=n>scheduledWorkRequest</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>
</span><span id=__span-26-39><a id=__codelineno-26-39 name=__codelineno-26-39 href=#__codelineno-26-39></a><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-40><a id=__codelineno-26-40 name=__codelineno-26-40 href=#__codelineno-26-40></a><span class=w>            </span><span class=n>scheduledWorkRequest</span><span class=p>.</span><span class=na>join</span><span class=p>();</span>
</span><span id=__span-26-41><a id=__codelineno-26-41 name=__codelineno-26-41 href=#__codelineno-26-41></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-42><a id=__codelineno-26-42 name=__codelineno-26-42 href=#__codelineno-26-42></a><span class=w>            </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Unexpected exception&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-26-43><a id=__codelineno-26-43 name=__codelineno-26-43 href=#__codelineno-26-43></a><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>interrupt</span><span class=p>();</span>
</span><span id=__span-26-44><a id=__codelineno-26-44 name=__codelineno-26-44 href=#__codelineno-26-44></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-26-45><a id=__codelineno-26-45 name=__codelineno-26-45 href=#__codelineno-26-45></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-26-46><a id=__codelineno-26-46 name=__codelineno-26-46 href=#__codelineno-26-46></a><span class=p>}</span>
</span></code></pre></div> <p>åœ¨ä¸Šæ–‡ä»‹ç»worker threadæ—¶,è¯´â€å¦‚æœè¯¥ç±»çº¿ç¨‹æ•°ä¸º0,åˆ™ä½¿ç”¨selector thread ç›´æ¥æ‰§è¡ŒIOè¯»å†™â€,ä½†ä»ä¸Šé¢æºç å¯ä»¥çœ‹å‡º,è‹¥worker threadä¸ªæ•°ä¸º0,ä¸ºæ¯ä¸ªç½‘ç»œIOå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œ,ä¸”ä¸»çº¿ç¨‹é˜»å¡éƒ½åˆ°ç½‘ç»œIOæ‰§è¡Œå®Œæ¯•,è¿™ç®€ç›´æ˜¯æµªè´¹èµ„æº,æ—¢ç„¶è¦é˜»å¡åˆ°ç½‘ç»œIOæ‰§è¡Œå®Œæ¯•,ä¸ºä½•è¿˜è¦å•ç‹¬å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹?ä¸ªäººè®¤ä¸ºå¯èƒ½æ˜¯é—ç•™ä»£ç æˆ–ä¸ºæ—¥åæ‰©å±•åšå‡†å¤‡,æ‰ä¼šæœ‰å¦‚æ­¤ä¸åˆç†çš„ä»£ç .å› æ­¤ä¸€å®šä¸èƒ½å°†worker threadçš„ä¸ªæ•°è®¾ç½®ä¸º0.</p> <p>### <strong>ScheduledWorkRequestæ˜¯å¦‚ä½•å¤„ç†ç½‘ç»œIOçš„</strong></p> <div class="language-java highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=nd>@Override</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=w>        </span><span class=c1>// Check if stopped while request was on queue</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stopped</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=w>            </span><span class=n>workRequest</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=w>            </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=w>        </span><span class=n>workRequest</span><span class=p>.</span><span class=na>doWork</span><span class=p>();</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Unexpected exception&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=w>        </span><span class=n>workRequest</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=p>}</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a><span class=nd>@Override</span>
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doWork</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-18><a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a><span class=w>    </span><span class=c1>//å¦‚æœChannelå·²ç»å…³é—­åˆ™æ¸…ç†è¯¥SelectionKey</span>
</span><span id=__span-27-19><a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>key</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-20><a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a><span class=w>        </span><span class=n>selectorThread</span><span class=p>.</span><span class=na>cleanupSelectionKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-27-21><a id=__codelineno-27-21 name=__codelineno-27-21 href=#__codelineno-27-21></a><span class=w>        </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-27-22><a id=__codelineno-27-22 name=__codelineno-27-22 href=#__codelineno-27-22></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-27-23><a id=__codelineno-27-23 name=__codelineno-27-23 href=#__codelineno-27-23></a><span class=w>    </span><span class=c1>//1.å¦‚æœå¯è¯»æˆ–å¯å†™ï¼Œåˆ™è°ƒç”¨NIOServerCnxn.doIO()æ–¹æ³•ï¼Œé€šçŸ¥NIOServerCnxnè¿æ¥å¯¹è±¡è¿›è¡ŒIOè¯»å†™åŠå¤„ç†</span>
</span><span id=__span-27-24><a id=__codelineno-27-24 name=__codelineno-27-24 href=#__codelineno-27-24></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>isReadable</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>isWritable</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-25><a id=__codelineno-27-25 name=__codelineno-27-25 href=#__codelineno-27-25></a><span class=w>        </span><span class=c1>//è°ƒç”¨NIOServerCnxnçš„doIO()å®ŒæˆIOå¤„ç†</span>
</span><span id=__span-27-26><a id=__codelineno-27-26 name=__codelineno-27-26 href=#__codelineno-27-26></a><span class=w>        </span><span class=n>cnxn</span><span class=p>.</span><span class=na>doIO</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-27-27><a id=__codelineno-27-27 name=__codelineno-27-27 href=#__codelineno-27-27></a>
</span><span id=__span-27-28><a id=__codelineno-27-28 name=__codelineno-27-28 href=#__codelineno-27-28></a><span class=w>        </span><span class=c1>// Check if we shutdown or doIO() closed this connection</span>
</span><span id=__span-27-29><a id=__codelineno-27-29 name=__codelineno-27-29 href=#__codelineno-27-29></a><span class=w>        </span><span class=c1>//å¦‚æœå·²ç»shutdownåˆ™å…³é—­è¿æ¥</span>
</span><span id=__span-27-30><a id=__codelineno-27-30 name=__codelineno-27-30 href=#__codelineno-27-30></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stopped</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-31><a id=__codelineno-27-31 name=__codelineno-27-31 href=#__codelineno-27-31></a><span class=w>            </span><span class=n>cnxn</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>
</span><span id=__span-27-32><a id=__codelineno-27-32 name=__codelineno-27-32 href=#__codelineno-27-32></a><span class=w>            </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-27-33><a id=__codelineno-27-33 name=__codelineno-27-33 href=#__codelineno-27-33></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-27-34><a id=__codelineno-27-34 name=__codelineno-27-34 href=#__codelineno-27-34></a><span class=w>        </span><span class=c1>//å¦‚æœChannelå·²ç»å…³é—­åˆ™æ¸…ç†è¯¥SelectionKey</span>
</span><span id=__span-27-35><a id=__codelineno-27-35 name=__codelineno-27-35 href=#__codelineno-27-35></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>key</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-36><a id=__codelineno-27-36 name=__codelineno-27-36 href=#__codelineno-27-36></a><span class=w>            </span><span class=n>selectorThread</span><span class=p>.</span><span class=na>cleanupSelectionKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-27-37><a id=__codelineno-27-37 name=__codelineno-27-37 href=#__codelineno-27-37></a><span class=w>            </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-27-38><a id=__codelineno-27-38 name=__codelineno-27-38 href=#__codelineno-27-38></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-27-39><a id=__codelineno-27-39 name=__codelineno-27-39 href=#__codelineno-27-39></a><span class=w>        </span><span class=c1>//2.æ›´æ–°è¯¥ä¼šè¯çš„è¿‡æœŸæ—¶é—´</span>
</span><span id=__span-27-40><a id=__codelineno-27-40 name=__codelineno-27-40 href=#__codelineno-27-40></a><span class=w>        </span><span class=n>touchCnxn</span><span class=p>(</span><span class=n>cnxn</span><span class=p>);</span>
</span><span id=__span-27-41><a id=__codelineno-27-41 name=__codelineno-27-41 href=#__codelineno-27-41></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-27-42><a id=__codelineno-27-42 name=__codelineno-27-42 href=#__codelineno-27-42></a>
</span><span id=__span-27-43><a id=__codelineno-27-43 name=__codelineno-27-43 href=#__codelineno-27-43></a><span class=w>    </span><span class=c1>//3.å·²ç»å¤„ç†å®Œè¯»å†™ï¼Œé‡æ–°æ ‡è®°è¯¥è¿æ¥å·²å‡†å¤‡å¥½æ–°çš„selectäº‹ä»¶ç›‘å¬</span>
</span><span id=__span-27-44><a id=__codelineno-27-44 name=__codelineno-27-44 href=#__codelineno-27-44></a><span class=w>    </span><span class=n>cnxn</span><span class=p>.</span><span class=na>enableSelectable</span><span class=p>();</span>
</span><span id=__span-27-45><a id=__codelineno-27-45 name=__codelineno-27-45 href=#__codelineno-27-45></a><span class=w>    </span><span class=c1>//æŠŠè¯¥è¿æ¥é‡æ–°æ”¾åˆ°selectThreadçš„updateQueueä¸­ï¼ŒselectThreadä¼šåœ¨å¤„ç†å¤„ç†å®Œæ‰€æœ‰Channelçš„è¯»å†™å’Œæ–°è¿æ¥åï¼Œæ›´æ–°æ­¤Channelçš„æ³¨å†Œç›‘å¬äº‹ä»¶</span>
</span><span id=__span-27-46><a id=__codelineno-27-46 name=__codelineno-27-46 href=#__codelineno-27-46></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>selectorThread</span><span class=p>.</span><span class=na>addInterestOpsUpdateRequest</span><span class=p>(</span><span class=n>key</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-47><a id=__codelineno-27-47 name=__codelineno-27-47 href=#__codelineno-27-47></a><span class=w>        </span><span class=n>cnxn</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>
</span><span id=__span-27-48><a id=__codelineno-27-48 name=__codelineno-27-48 href=#__codelineno-27-48></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-27-49><a id=__codelineno-27-49 name=__codelineno-27-49 href=#__codelineno-27-49></a><span class=p>}</span>
</span></code></pre></div> <p>é™¤å»ä¸€äº›å¥å£®æ€§ä»£ç ,ä¸»è¦å®Œæˆ3ä»¶äº‹: - NIOServerCnxn.doIO()æ–¹æ³•ï¼Œé€šçŸ¥NIOServerCnxnè¿æ¥å¯¹è±¡è¿›è¡ŒIOè¯»å†™åŠå¤„ç† - æ›´æ–°è¯¥è¿æ¥çš„è¿‡æœŸæ—¶é—´ - ç½‘ç»œIOå·²å¤„ç†å®Œæ¯•,ä¿®æ”¹selectableæ ‡å¿—ä½å’Œå°†socketChannelæ·»åŠ è‡³selector threadçš„updateQueueä¸­,å…¶ä½œç”¨å·²åœ¨å‰æ–‡è¯´æ˜.</p> <p>åœ¨selector threadå¤„ç†accept - threadæ¥æ”¶çš„è¿æ¥æ—¶,é™¤äº†å°†æ–°è¿æ¥æ³¨å†Œåˆ°selectorä¸Šä¹‹å¤–,è¿˜å°†è¿æ¥åŒ…è£…ä¸ºNIOServerCnxnåæ³¨å†Œåˆ°NIOServerCnxnFactoryä¸­.NIOServerCnxnæ˜¯å¯¹å®¢æˆ·ç«¯è¿æ¥çš„å°è£…, - worker threadä¸­è°ƒç”¨NIOServerCnxn.doIO()å¤„ç†ç½‘ç»œIO.è¯¦è§ZooKeeper-å®¢æˆ·ç«¯è¿æ¥ServerCnxnä¹‹NIOServerCnxn</p> <h2 id=connectionexpirerthread><strong>ConnectionExpirerThread</strong><a class=headerlink href=#connectionexpirerthread title="Permanent link">&para;</a></h2> <p>æ­¤çº¿ç¨‹ç”¨äºæ¸…ç†è¿‡æœŸçš„è¿æ¥,ä¸»è¦æ–¹æ³•å¦‚ä¸‹:</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=nd>@Override</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stopped</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>waitTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cnxnExpiryQueue</span><span class=p>.</span><span class=na>getWaitTime</span><span class=p>();</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>waitTime</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=w>                </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>waitTime</span><span class=p>);</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=w>                </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>NIOServerCnxn</span><span class=w> </span><span class=n>conn</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>cnxnExpiryQueue</span><span class=p>.</span><span class=na>poll</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a><span class=w>                </span><span class=n>conn</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-28-14><a id=__codelineno-28-14 name=__codelineno-28-14 href=#__codelineno-28-14></a>
</span><span id=__span-28-15><a id=__codelineno-28-15 name=__codelineno-28-15 href=#__codelineno-28-15></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-16><a id=__codelineno-28-16 name=__codelineno-28-16 href=#__codelineno-28-16></a><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&quot;ConnnectionExpirerThread interrupted&quot;</span><span class=p>);</span>
</span><span id=__span-28-17><a id=__codelineno-28-17 name=__codelineno-28-17 href=#__codelineno-28-17></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-28-18><a id=__codelineno-28-18 name=__codelineno-28-18 href=#__codelineno-28-18></a><span class=p>}</span>
</span></code></pre></div> <p>æ­¤çº¿ç¨‹çš„å·¥ä½œåŸç†è¯¦è§Zookeeper-è¿æ¥å’Œä¼šè¯çš„è¿‡æœŸæ¸…ç†ç­–ç•¥(ExpiryQueue)</p> <h2 id=nettyservercnxnfactory><strong>NettyServerCnxnFactory</strong><a class=headerlink href=#nettyservercnxnfactory title="Permanent link">&para;</a></h2> <p>å‰é¢è¯¦ç»†è¯´äº†NIOæ¨¡å¼çš„è¿æ¥å™¨ä¸‹é¢å¯ä»¥æ¯”è¾ƒä¸‹ä»–ä»¬ä¸¤ä¸ªçš„å·®å¼‚ï¼š NettyServerCnxnFactoryä½¿ç”¨nettyè¿›è¡Œç½‘ç»œIO,ä½†æ˜¯å…¶ä½¿ç”¨netty3.<em>ç‰ˆæœ¬,ä¸4.</em> ç‰ˆæœ¬çš„å®ç°æ€è·¯è™½ç„¶ä¸€è‡´,ä½†APIå·®åˆ«å¾ˆå¤§,ä¸ºæ­¤ä¸å†æ·±å…¥ç ”ç©¶NettyServerCnxnFactory,ç®€å•ä»‹ç»ä¸‹å…¶ä¸NIOServerCnxnFactoryçš„ä¸åŒ.</p> <table> <thead> <tr> <th><strong><em>ä¸åŒç‚¹</em></strong></th> <th><strong><em>NIO</em></strong></th> <th><strong><em>Netty</em></strong></th> </tr> </thead> <tbody> <tr> <td>acceptäº‹ä»¶</td> <td>å¯åŠ¨1ä¸ªaccept thread</td> <td>boss groupå¤„ç†acceptäº‹ä»¶,é»˜è®¤å¯åŠ¨1ä¸ªçº¿ç¨‹</td> </tr> <tr> <td>select()</td> <td>å¯åŠ¨select thread</td> <td>æ·»åŠ handleræ—¶è°ƒç”¨addLast(EventExecutorGroup, ChannelHandlerâ€¦),åˆ™handlerå¤„ç†IOäº‹ä»¶ä¼šåœ¨EventExecutorGroupä¸­è¿›è¡Œ</td> </tr> <tr> <td>ç½‘ç»œIO</td> <td>å¯åŠ¨worker thread</td> <td>å¯åŠ¨work groupå¤„ç†ç½‘ç»œIO,é»˜è®¤å¯åŠ¨æ ¸å¿ƒæ•°âˆ—2æ ¸å¿ƒæ•°âˆ—2ä¸ªçº¿ç¨‹</td> </tr> <tr> <td>å¤„ç†è¯»äº‹ä»¶</td> <td>åœ¨worker threadä¸­è°ƒç”¨NIOServerCnxn.doIO()å¤„ç†</td> <td>åœ¨handlerä¸­å¤„ç†è¯»äº‹ä»¶</td> </tr> <tr> <td>ç²˜åŒ…æ‹†åŒ…</td> <td>é€šè¿‡lenBufferå’ŒincomingBufferè§£å†³è¯¥é—®é¢˜,ä»£ç å¾ˆå¤æ‚</td> <td>æ’å…¥å¤„ç†ç²˜åŒ…æ‹†åŒ…çš„handlerå³å¯</td> </tr> <tr> <td>å¤„ç†å†™äº‹ä»¶</td> <td>æ‰§è¡ŒFinalRP.processRequest()çš„çº¿ç¨‹ä¸worker threadé€šè¿‡NIOServerCnxn.outgoingBuffersè¿›è¡Œé€šä¿¡,ç”±worker threadæ‰¹é‡å†™</td> <td>nettyå¤©ç”Ÿæ”¯æŒå¼‚æ­¥å†™,è‹¥å½“å‰çº¿ç¨‹ä¸ºEventLoopçº¿ç¨‹,åˆ™å°†å¾…å†™å…¥æ•°æ®å­˜æ”¾åˆ°ChannelOutboundBufferä¸­.è‹¥å½“å‰çº¿ç¨‹ä¸æ˜¯EventLoopçº¿ç¨‹,æ„é€ å†™ä»»åŠ¡æ·»åŠ è‡³EventLoopä»»åŠ¡é˜Ÿåˆ—ä¸­</td> </tr> <tr> <td>ç›´æ¥å†…å­˜</td> <td>ä½¿ç”¨ThreadLocalçš„ç›´æ¥å†…å­˜</td> <td>è®°ä¸å¤ªæ¸…æ¥šnettyä¸­å¦‚ä½•ä½¿ç”¨ç›´æ¥å†…å­˜äº†,ä½†nettyæ”¯æŒç›´æ¥å†…å­˜,ä¸”ä½¿ç”¨è¾ƒä¸ºæ–¹ä¾¿</td> </tr> <tr> <td>å¤„ç†è¿æ¥å…³é—­</td> <td>å¯åŠ¨connection expiration threadç®¡ç†è¿æ¥</td> <td>åœ¨handlerä¸­å¤„ç†è¿æ¥</td> </tr> </tbody> </table> <p>æ³¨:ä¸Šè¿°åŒºåˆ«æ˜¯å°†netty4.<em>ç‰ˆæœ¬ä¸NIOServerCnxnFactoryçš„å¯¹æ¯”,ç”±äºZooKeeperä½¿ç”¨netty3.</em> ,å› æ­¤å…¶NettyServerCnxnFactoryä¸­å­˜åœ¨ä¸€äº›æ— ç”¨ä»£ç ,æ¯”å¦‚å¤„ç†ç²˜åŒ…æ‹†åŒ…çš„ä»£ç  ä»ä¸Šè¿°çš„æ¯”è¾ƒä¸­å¯ä»¥çœ‹å‡ºä½¿ç”¨nettyå¤„ç†ç½‘ç»œIOæ¯”åŸºäºJava NIOè‡ªå·±ç¼–ç æ–¹ä¾¿å¤ªå¤šäº†</p> <h3 id=_6><strong>æ€»ç»“</strong><a class=headerlink href=#_6 title="Permanent link">&para;</a></h3> <p>æ€»ç»“ä¸‹çº¿ç¨‹é€šä¿¡æ‰€ç”¨çš„ä¸‰ä¸ªé˜Ÿåˆ—:</p> <ul> <li><strong>SelectorThread.acceptedQueue:accept</strong> threadå’Œselector threadé€šä¿¡</li> <li><strong>SelectorThread.updateQueue:worker</strong> threadå’Œselector threadé€šä¿¡</li> <li><strong>NIOServerCnxn.outgoingBuffers:worker</strong> threadå’Œè¯·æ±‚å¤„ç†çº¿ç¨‹é€šä¿¡</li> </ul> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=æœ€åæ›´æ–°> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="2026å¹´1æœˆ21æ—¥ 11:49:18 UTC">2026å¹´1æœˆ21æ—¥ 11:49:18</span> </span> <span class=md-source-file__fact> <span class=md-icon title=åˆ›å»ºæ—¥æœŸ> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="2026å¹´1æœˆ21æ—¥ 11:49:18 UTC">2026å¹´1æœˆ21æ—¥ 11:49:18</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> å›åˆ°é¡µé¢é¡¶éƒ¨ </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=é¡µè„š> <a href=../13-loaddatabase/ class="md-footer__link md-footer__link--prev" aria-label="ä¸Šä¸€é¡µ: ğŸ’¾ 13-åˆå§‹åŒ–ç£ç›˜æ•°æ®"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> ä¸Šä¸€é¡µ </span> <div class=md-ellipsis> ğŸ’¾ 13-åˆå§‹åŒ–ç£ç›˜æ•°æ® </div> </div> </a> <a href=../15-election/ class="md-footer__link md-footer__link--next" aria-label="ä¸‹ä¸€é¡µ: ğŸ—³ï¸ 15-é€‰ä¸¾ç®—æ³•çš„å‡†å¤‡ç­‰å¾…é€‰ä¸¾"> <div class=md-footer__title> <span class=md-footer__direction> ä¸‹ä¸€é¡µ </span> <div class=md-ellipsis> ğŸ—³ï¸ 15-é€‰ä¸¾ç®—æ³•çš„å‡†å¤‡ç­‰å¾…é€‰ä¸¾ </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> ä¸“æ³¨å¼€æºæŠ€æœ¯ç‰ˆæœ¬å‘å¸ƒæ´å¯Ÿï¼Œå¯å¾®ä¿¡æœç´¢ã€Šä¸­é—´ä»¶æºç ã€‹è”ç³»è®¢é˜…ã€‚<br>Copyright &copy; 2022 - 2025 NextStack å¼€æºç‰ˆæœ¬æ´å¯Ÿå¹³å°<br> è‡´åŠ›äºä¸ºæŠ€æœ¯å†³ç­–è€…æä¾›æœ€æ–°çš„å¼€æºé¡¹ç›®ç‰ˆæœ¬æ¼”è¿›åˆ†æ | éµå¾ª<a href=https://creativecommons.org/licenses/by/4.0/ target=_blank>CC BY 4.0</a>è®¸å¯åè®®ã€‚ </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie åŒæ„</h4> <p>æˆ‘ä»¬ä½¿ç”¨cookiesæ¥è¯†åˆ«æ‚¨çš„é‡å¤è®¿é—®åå¥½è®¾ç½®ï¼Œè¡¡é‡æˆ‘ä»¬æ–‡æ¡£çš„æœ‰æ•ˆæ€§ï¼Œ ä»¥åŠè·Ÿè¸ªæˆ‘ä»¬ç½‘ç«™çš„æµé‡ã€‚</p> <input class=md-toggle type=checkbox id=__settings checked> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">åŒæ„</button> <button type=reset class="md-button md-button--primary">æ‹’ç»</button> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id=__config type=application/json>{"annotate": null, "base": "../../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tooltips", "header.autohide", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "navigation.sections", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.79ae519e.min.js></script> <script src=../../../javascripts/homepage-fullwidth-helper.js></script> <script src=../../../javascripts/fullwidth-debug.js></script> <script src=../../../javascripts/auto-language-redirect.js></script> <script src=../../../javascripts/api-proxy.js></script> <script src=../../../javascripts/extra.js></script> <script src=../../../javascripts/homepage-navbar.js></script> <script src=../../../javascripts/seo-performance.js></script> <script src=../../../javascripts/language-switcher.js></script> <script src=../../../javascripts/category-navigation.js></script> <script src=../../../mermaid.min.js></script> <script src=../../../javascripts/baidu-tongji.js></script> <script src=../../../javascripts/google-tongji.js></script> </body> </html>