# pulsar v3.0.6

#### 2024-08-01

### Broker

- [feat][broker] 实现 PIP-323：完成积压配额遥测 ([#21816](https://github.com/apache/pulsar/pull/21816)) ([#22740](https://github.com/apache/pulsar/pull/22740))
- [feat][broker][branch-3.0] PIP-321 在命名空间级别引入允许的集群 ([#22378](https://github.com/apache/pulsar/pull/22378)) ([#22960](https://github.com/apache/pulsar/pull/22960))
- [fix] 在锁定范围内对 `individualDeletedMessages` 进行操作 ([#22966](https://github.com/apache/pulsar/pull/22966))
- [fix] 从 BookieRackAffinityMapping 中移除阻塞调用 ([#22846](https://github.com/apache/pulsar/pull/22846))
- [improve] 重构 BK ClientFactory 以返回 futures ([#22853](https://github.com/apache/pulsar/pull/22853))
- [fix][broker] 在检查 broker 是否活跃时异步返回 brokerRegistry.lookupAsync（仅限 ExtensibleLoadManagerImpl） ([#22899](https://github.com/apache/pulsar/pull/22899))
- [fix][broker] 启用 broker 客户端 tls 时无法连接到非持久主题 ([#22991](https://github.com/apache/pulsar/pull/22991))
- [fix][broker] 在启用 ExtensibleLoadManager 时检查 broker 是否可用于 SLA 监控包 ([#22485](https://github.com/apache/pulsar/pull/22485))
- [fix][broker] 检查 markDeletePosition 并计算积压 ([#22947](https://github.com/apache/pulsar/pull/22947))
- [fix][broker] 确保 PulsarService 准备好处理传入请求 ([#22977](https://github.com/apache/pulsar/pull/22977))
- [fix][broker] EntryFilters 修复由于关闭的类加载器导致的 NoClassDefFoundError ([#22767](https://github.com/apache/pulsar/pull/22767))
- [fix][broker] 修复 MessageDeduplication 重播超时导致主题加载卡住 ([#23004](https://github.com/apache/pulsar/pull/23004))
- [fix][broker] 修复发布墓碑到服务单元通道后出现的 NPE ([#22859](https://github.com/apache/pulsar/pull/22859))
- [fix][broker] 修复启用 ExtensibleLoadManager 时的复制主题卸载错误 ([#22496](https://github.com/apache/pulsar/pull/22496))
- [fix][broker] 修复上传大包时的 broker OOM 问题 ([#22989](https://github.com/apache/pulsar/pull/22989))
- [fix][broker] 修复游标应使用最新的分类帐配置 ([#22644](https://github.com/apache/pulsar/pull/22644))
- [fix][broker] 修复地理复制管理员客户端 URL ([#22584](https://github.com/apache/pulsar/pull/22584))
- [fix][broker] 修复启用主题级别复制并构建远程管理员失败时的卡住问题 ([#23028](https://github.com/apache/pulsar/pull/23028))
- [fix][broker] 修复 oldestBacklogMessageAgeSeconds 持续增加的问题，即使没有积压 ([#22907](https://github.com/apache/pulsar/pull/22907))
- [fix][broker] 修复在命名空间级别进行复制并设置主题策略时的 updatePartitionedTopic 问题 ([#22971](https://github.com/apache/pulsar/pull/22971))
- [fix][broker] 修复 TopicName.getPartition(int index) 方法的错误逻辑 ([#19841](https://github.com/apache/pulsar/pull/19841))
- [fix][broker] 处理 BucketDelayedDeliveryTracker 恢复失败 ([#22735](https://github.com/apache/pulsar/pull/22735))
- [fix][broker] 立即将已删除和空闲状态的包标记为墓碑 ([#22743](https://github.com/apache/pulsar/pull/22743))
- [fix][broker] 使 ExtensibleLoadManagerImpl.getOwnedServiceUnits 异步化 ([#22727](https://github.com/apache/pulsar/pull/22727))
- [fix][broker] 使用主题级别复制时远程集群上的消息丢失 ([#22890](https://github.com/apache/pulsar/pull/22890))
- [fix][broker] 如果 --stream-storage-port 不是 4181，PulsarStandalone 启动时出错 ([#22993](https://github.com/apache/pulsar/pull/22993))
- [fix][broker] 从 Subscription.getStats 中移除阻塞调用 ([#23088](https://github.com/apache/pulsar/pull/23088))
- [fix][broker] 当两个集群之间的分区数量不同时，复制卡住 ([#22983](https://github.com/apache/pulsar/pull/22983))
- [fix][broker] 支持扩展负载管理器的查找选项 ([#22487](https://github.com/apache/pulsar/pull/22487))
- [fix][broker] 更新初始化和关闭时间及其他次要逻辑（仅限 ExtensibleLoadManagerImpl） ([#22930](https://github.com/apache/pulsar/pull/22930))
- [fix][broker] 在健康检查中检测到死锁时，broker 会记录完整的线程转储 ([#22916](https://github.com/apache/pulsar/pull/22916))
- [fix][broker] 修复禁用主题级别地理复制时的死锁问题 ([#22738](https://github.com/apache/pulsar/pull/22738))
- [fix][broker] 修复即使禁用主题级别复制，主题分区仍然扩展的问题 ([#22769](https://github.com/apache/pulsar/pull/22769))
- [fix][broker] 如果主题不存在，在调用 getPartitionedTopicMetadata 时响应未找到错误 ([#22838](https://github.com/apache/pulsar/pull/22838))
- [fix][broker] 修复 lookupService.getTopicsUnderNamespace 无法与引号模式一起使用的问题 ([#23014](https://github.com/apache/pulsar/pull/23014))
- [fix][broker][branch-3.0] 不要尝试从非活动源 broker 中清理拥有的包（仅限 ExtensibleLoadManagerImpl） ([#23064](https://github.com/apache/pulsar/pull/23064)) ([#23077](https://github.com/apache/pulsar/pull/23077))
- [fix][broker][branch-3.0] 主题可能引用已关闭的分类帐 ([#22860](https://github.com/apache/pulsar/pull/22860)) ([#22900](https://github.com/apache/pulsar/pull/22900))
- [improve][broker] 在其他操作之前先检查最大生产者/消费者限制以节省资源 ([#23074](https://github.com/apache/pulsar/pull/23074))
- [improve][broker] 在重用之前清除线程本地 BrokerEntryMetadata 实例 ([#22752](https://github.com/apache/pulsar/pull/22752))
- [improve][broker] 跟进 [#4196](https://github.com/apache/pulsar/pull/4196) 使用 `PulsarByteBufAllocator` 处理 OOM ([#20837](https://github.com/apache/pulsar/pull/20837))
- [improve][broker] GetPartitionMetadata 失败时也可以生产消息 ([#23050](https://github.com/apache/pulsar/pull/23050))
- [improve][broker] 提高 TopicName 缓存的 CPU 资源使用效率 ([#23052](https://github.com/apache/pulsar/pull/23052))
- [improve][broker] 提高检查消息删除的效率 ([#20490](https://github.com/apache/pulsar/pull/20490))
- [improve][broker] 改进没有模式的主题检查的异常处理 ([#22974](https://github.com/apache/pulsar/pull/22974))
- [improve][broker] 在服务器分发中包含运行时依赖项 ([#22001](https://github.com/apache/pulsar/pull/22001))
- [improve][broker] 优化 PersistentTopic.getLastDispatchablePosition ([#22707](https://github.com/apache/pulsar/pull/22707))
- [improve][broker] PIP-356 支持从最早位置开始的地理复制 ([#22856](https://github.com/apache/pulsar/pull/22856))
- [improve][broker] 移除 ClassLoaderSwitcher 以避免对象分配并保持代码风格一致 ([#22796](https://github.com/apache/pulsar/pull/22796))
- [improve